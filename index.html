<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K | Ver 19.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --accent: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF; --text: #000000; --header-bg: rgba(255, 255, 255, 0.85); --bubble-me: #007AFF; --bubble-other: #E9E9EB; }
        body.dark-mode { --bg: #1C1C1E; --card-bg: #2C2C2E; --text: #FFFFFF; --header-bg: rgba(28, 30, 32, 0.85); --bubble-me: #0A84FF; --bubble-other: #3A3A3C; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; background: var(--bg); color: var(--text); }
        header { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background: var(--header-bg); height: 60px; display: flex; align-items: center; padding: env(safe-area-inset-top) 15px 0; z-index: 2000; border-bottom: 0.5px solid rgba(0,0,0,0.1); }
        header button { background: none; border: none; font-size: 22px; color: inherit; padding: 10px; cursor: pointer; }
        .title { flex: 1; text-align: center; font-weight: 600; font-size: 17px; }
        #chat-area { flex: 1; overflow-y: auto; padding: 20px 15px 120px; display: flex; flex-direction: column; gap: 12px; height: calc(100% - 60px); }
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .bubble { padding: 10px 16px; border-radius: 20px; font-size: 16px; line-height: 1.4; word-break: break-all; }
        .me { align-self: flex-end; } .me .bubble { background: var(--bubble-me); color: white; border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; } .other .bubble { background: var(--bubble-other); color: var(--text); border-bottom-left-radius: 4px; }
        .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--header-bg); backdrop-filter: blur(20px); padding: 10px 15px calc(10px + env(safe-area-inset-bottom)); display: flex; gap: 10px; border-top: 0.5px solid rgba(0,0,0,0.1); align-items: flex-end; z-index: 2500; }
        #msg-input { flex: 1; border: none; background: rgba(120, 120, 128, 0.12); padding: 10px 15px; border-radius: 20px; color: var(--text); outline: none; font-size: 16px; min-height: 40px; max-height: 120px; resize: none; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 3000; padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom); display: none; overflow-y: auto; }
        .modal.active { display: block; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn-main { width: 100%; height: 50px; background: var(--accent); color: white; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
        .btn-danger { background: #FF3B30 !important; }
        .input-box { width: 100%; height: 50px; padding: 0 15px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); background: var(--card-bg); color: var(--text); margin-bottom: 15px; font-size: 16px; }
    </style>
</head>
<body>

<header>
    <button onclick="window.goHome()">üè†</button>
    <div class="title" id="head-title">Chat-K</div>
    <button onclick="window.triggerOpenSettings()">‚öôÔ∏è</button>
</header>

<div id="chat-area"></div>

<div class="footer">
    <textarea id="msg-input" rows="1" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏..."></textarea>
    <button onclick="window.triggerSendMessage()" style="background:var(--accent); color:white; border:none; width:44px; height:44px; border-radius:50%; flex-shrink:0;">‚Üë</button>
</div>

<div id="auth-modal" class="modal">
    <div style="text-align:center; padding-top:40px;">
        <h1 style="font-size:38px; margin-bottom:30px;">üß™ Chat-K</h1>
        <div class="card">
            <div id="auth-toggle" style="display:flex; margin-bottom:20px; background:rgba(0,0,0,0.05); border-radius:10px; padding:4px;">
                <button id="tab-login" style="flex:1; border:none; padding:8px; border-radius:8px; background:white;" onclick="window.setAuthMode('login')">„É≠„Ç∞„Ç§„É≥</button>
                <button id="tab-reg" style="flex:1; border:none; padding:8px; border-radius:8px; background:none;" onclick="window.setAuthMode('reg')">Êñ∞Ë¶èÁôªÈå≤</button>
            </div>
            <input type="text" id="auth-uid" class="input-box" placeholder="„É¶„Éº„Ç∂„ÉºID (‰∏ñÁïå„Å´1„Å§)">
            <input type="text" id="auth-name" class="input-box" placeholder="Ë°®Á§∫Âêç" style="display:none;">
            <input type="password" id="auth-pw" class="input-box" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
            <button class="btn-main" id="auth-btn" onclick="window.handleAuth()">„É≠„Ç∞„Ç§„É≥</button>
        </div>
    </div>
</div>

<div id="main-modal" class="modal">
    <div style="text-align:center; padding-top:20px;">
        <div id="step-home" style="text-align:left;">
            <div class="card" onclick="alert('„É¶„Éº„Ç∂„Éº„Ç´„Éº„Éâ„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü')" style="cursor:pointer;">
                <b>User:</b> <span id="display-name"></span><br>
                <b>ID:</b> <span id="display-uid" style="font-size:12px; opacity:0.6;"></span>
            </div>
            <div id="history-list"></div>
            <button onclick="window.triggerShowGroupForm('create')" class="btn-main" style="background:#34C759;">Ôºã Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê</button>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="window.triggerShowGroupForm('join')" class="btn-main" style="background:#8E8E93;">IDÂÖ•Âäõ</button>
                <button onclick="window.startScanner()" class="btn-main" style="background:#5856D6;">„Çπ„Ç≠„É£„É≥</button>
            </div>
            <div id="group-form" style="display:none; margin-top:15px;" class="card">
                <div id="scanner-container" style="display:none; margin-bottom:15px;"><div id="reader"></div></div>
                <input type="text" id="group-id-input" placeholder="Project ID" class="input-box">
                <input type="password" id="group-pw-input" placeholder="Password" class="input-box">
                <button class="btn-main" onclick="window.triggerHandleGroupAction()">Áî≥Ë´ã / ÂÖ•ÂÆ§</button>
            </div>
        </div>
        <div id="step-waiting" style="display:none;" class="card">
            <h3>ÊâøË™çÂæÖ„Å°...</h3>
            <button class="btn-main" style="background:#8E8E93;" onclick="location.reload()">Êàª„Çã</button>
        </div>
    </div>
</div>

<div id="set-modal" class="modal">
    <div style="display:
