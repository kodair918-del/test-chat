<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K | Science Edition</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; width: 100%; background: var(--bg-blue); font-family: sans-serif; }
        body { display: flex; flex-direction: column; }
        header { background: var(--header-dark); color: white; display: flex; align-items: center; height: 50px; padding: 0 10px; padding-top: env(safe-area-inset-top); flex-shrink: 0; z-index: 100; }
        header .title { flex: 1; text-align: center; font-weight: bold; font-size: 16px; }
        header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 14px; -webkit-overflow-scrolling: touch; }
        .footer { background: #ffffff; padding: 8px 10px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #ddd; flex-shrink: 0; }
        #msg-input { flex: 1; border: none; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; max-height: 100px; resize: none; line-height: 1.4; }
        .system-msg { align-self: center; background: rgba(0,0,0,0.15); color: white; font-size: 11px; padding: 4px 12px; border-radius: 12px; margin: 5px 0; }
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sender-name { font-size: 11px; color: #555; margin-bottom: 3px; margin-left: 5px; font-weight: bold; }
        .me { align-self: flex-end; } .me .bubble { background: var(--line-green); color: white; border-top-right-radius: 2px; }
        .other { align-self: flex-start; } .other .bubble { border-top-left-radius: 2px; }
        .ai-bubble { align-self: flex-start; max-width: 90%; margin: 10px 0; border: 1.5px dashed var(--line-green); padding: 12px; border-radius: 15px; background: rgba(255,255,255,0.95); font-size: 13px; color: #333; }
        .ai-badge { background: var(--line-green); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-bottom: 5px; display: inline-block; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 20px; display: block; overflow-y: auto; }
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .input-box { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 15px; font-size: 16px; }
    </style>
</head>
<body>

<header>
    <button onclick="location.reload()">üè†</button>
    <div class="title" id="display-group-name">Chat-K Expert</div>
    <button id="gear-btn" onclick="openSettings()" style="display:none;">‚öôÔ∏è</button>
</header>

<div id="chat-area"></div>

<div class="footer">
    <textarea id="msg-input" rows="1" placeholder="$\alpha, \beta$ Êï∞Âºè„ÅØ$„ÅßÂõ≤„ÇÄ" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
    <button onclick="window.triggerSendMessage()" style="background:var(--line-green); color:white; border:none; width:40px; height:40px; border-radius:50%;">‚û§</button>
</div>

<div id="main-modal" class="modal">
    <h2 style="text-align:center; color:var(--line-green); margin-top:40px;">Chat-K Expert</h2>
    <div id="step-register">
        <input type="email" id="reg-email" class="input-box" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ">
        <div id="name-input-area" style="display:none;">
            <input type="text" id="reg-name" class="input-box" placeholder="„ÅäÂêçÂâçÔºàÂ∞ÇÈñÄ„Å™„Å©Ôºâ">
        </div>
        <button class="btn-main" id="auth-btn" onclick="window.triggerCheckEmail()">„É≠„Ç∞„Ç§„É≥ / Êñ∞Ë¶èÁôªÈå≤</button>
    </div>
    <div id="step-home" style="display:none; text-align:center;">
        <div style="background:white; padding:15px; border-radius:15px; margin-bottom:20px; border:1px solid #ddd;">
            <p id="welcome-msg" style="font-weight:bold; margin:0;"></p>
        </div>
        <div id="history-list"></div>
        <button onclick="window.triggerShowGroupForm('create')" class="btn-main" style="margin-top:10px;">Êñ∞Ë¶è„Ç∞„É´„Éº„Éó‰ΩúÊàê</button>
        <button onclick="window.triggerShowGroupForm('join')" style="width:100%; background:#eee; border:none; padding:15px; border-radius:12px; margin-top:10px; font-weight:bold;">Êó¢Â≠ò„Ç∞„É´„Éº„Éó„Å´ÂèÇÂä†</button>
        <div id="group-form" style="display:none; margin-top:15px; padding:15px; background:#fff; border-radius:12px; border:1px solid #ddd;">
            <input type="text" id="group-id" placeholder="„Ç∞„É´„Éº„ÉóÂêç" class="input-box" style="margin-bottom:10px;">
            <input type="password" id="group-pw" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" class="input-box">
            <button class="btn-main" onclick="window.triggerHandleGroupAction()">Ê±∫ÂÆö</button>
        </div>
        <button onclick="localStorage.clear(); location.reload();" style="color:red; border:none; background:none; margin-top:40px; font-size:12px;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get, set, off, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com",
        projectId: "my-chat-1d626",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = localStorage.getItem('chat_name'), myEmail = localStorage.getItem('chat_email'), currentGid = "";

    // Êï∞Âºè„É¨„É≥„ÉÄ„É™„É≥„Ç∞Áî®„Ç™„Éó„Ç∑„Éß„É≥
    const mathOptions = { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}], throwOnError: false };

    // --- Â§ñÈÉ®Âëº„Å≥Âá∫„ÅóÁî®Èñ¢Êï∞„Çíwindow„Å´ÁôªÈå≤ („Éú„Çø„É≥ÁÑ°ÂèçÂøúÂØæÁ≠ñ) ---
    window.triggerCheckEmail = async () => {
        const email = document.getElementById('reg-email').value.trim().toLowerCase();
        if(!email.includes('@')) return alert("ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        const snap = await get(ref(db, `users/${email.replace(/\./g, '_')}`));
        if(snap.exists()){
            myName = snap.val().name; myEmail = email;
            localStorage.setItem('chat_name', myName); localStorage.setItem('chat_email', myEmail);
            showStep('home');
        } else {
            document.getElementById('name-input-area').style.display = 'block';
            document.getElementById('auth-btn').onclick = () => finalizeReg(email);
        }
    };

    async function finalizeReg(email) {
        const name = document.getElementById('reg-name').value.trim();
        if(!name) return alert("ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        await set(ref(db, `users/${email.replace(/\./g, '_')}`), { name: name });
        myName = name; myEmail = email;
        localStorage.setItem('chat_name', name); localStorage.setItem('chat_email', email);
        showStep('home');
    }

    window.triggerSendMessage = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim() || !currentGid) return;
        push(ref(db, `v5_groups/${currentGid}/messages`), { 
            name: myName, sender: myEmail, text: inp.value, type: 'text', time: serverTimestamp() 
        });
        inp.value = ""; inp.style.height = 'auto';
    };

    window.triggerHandleGroupAction = async () => {
        const gid = document.getElementById('group-id').value.trim(), pw = btoa(document.getElementById('group-pw').value);
        if(!gid) return;
        const snap = await get(ref(db, `v5_groups/${gid}`));
        if(window.currentMode === 'create') {
            if(snap.exists()) return alert("Êó¢„Å´Â≠òÂú®„Åó„Åæ„Åô");
            await set(ref(db, `v5_groups/${gid}`), { host: myEmail, pw: pw });
        } else {
            if(!snap.exists() || snap.val().pw !== pw) return alert("ÊÉÖÂ†±„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì");
        }
        let h = JSON.parse(localStorage.getItem('chat_history') || "[]");
        if(!h.includes(gid)) h.push(gid);
        localStorage.setItem('chat_history', JSON.stringify(h));
        enterChat(gid);
    };

    window.triggerShowGroupForm = (m) => { window.currentMode = m; document.getElementById('group-form').style.display = 'block'; };

    // --- „ÉÅ„É£„ÉÉ„Éà„Ç≥„Ç¢Ê©üËÉΩ ---
    function enterChat(gid) {
        currentGid = gid;
        document.getElementById('main-modal').style.display = 'none';
        document.getElementById('display-group-name').innerText = gid;
        document.getElementById('chat-area').innerHTML = "";

        // ÂÖ•ÂÆ§ÈÄöÁü•
        push(ref(db, `v5_groups/${gid}/messages`), { text: `${myName}„Åï„Çì„ÅåÂèÇÂä†„Åó„Åæ„Åó„Åü`, type: 'system' });

        const chatRef = ref(db, `v5_groups/${gid}/messages`);
        onChildAdded(chatRef, (snap) => {
            const d = snap.val();
            const wrap = document.createElement('div');
            if(d.type === 'system') {
                wrap.className = 'system-msg'; wrap.innerText = d.text;
            } else {
                wrap.className = `bubble-wrapper ${d.sender === myEmail ? 'me' : 'other'}`;
                wrap.innerHTML = `<div class="sender-name">${d.name}</div><div class="bubble">${d.text}</div>`;
                if(window.renderMathInElement) renderMathInElement(wrap, mathOptions);
            }
            document.getElementById('chat-area').appendChild(wrap);
            document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
            if(d.sender !== myEmail && d.type === 'text') checkExpertTerms(d.text);
        });
    }

    // AIËß£Ë™¨ (ÁêÜÁ≥ªÁî®Ë™û)
    function checkExpertTerms(text) {
        const dictionary = {
            "„Ç∑„É•„É¨„Éá„Ç£„É≥„Ç¨„Éº": "„ÄêAIËß£Ë™¨„ÄëÈáèÂ≠êÂäõÂ≠¶„ÅÆÊ†πÂππ„Äå„Ç∑„É•„É¨„Éá„Ç£„É≥„Ç¨„ÉºÊñπÁ®ãÂºè„Äç„ÅßÊúâÂêç„ÄÇÁä∂ÊÖã„ÅÆÈáç„Å≠Âêà„Çè„Åõ„ÇíÁå´„Åß‰æã„Åà„Åæ„Åó„Åü„ÄÇ",
            "„Ç®„É≥„Éà„É≠„Éî„Éº": "„ÄêAIËß£Ë™¨„Äë‰∏çË¶èÂâá„Åï„ÅÆÂ∞∫Â∫¶„ÄÇÁÜ±ÂäõÂ≠¶„Åß„ÅØ $S = k_B \ln \Omega$ „Å®ÂÆöÁæ©„Åï„Çå„Åæ„Åô„ÄÇ",
            "„Ç™„Ç§„É©„Éº„ÅÆÁ≠âÂºè": "„ÄêAIËß£Ë™¨„ÄëÊï∞Â≠¶Âè≤‰∏äÊúÄ„ÇÇÁæé„Åó„ÅÑÂºè„Å®„Åï„Çå„Çã $e^{i\pi} + 1 = 0$ „Åß„Åô„ÄÇ",
            "„Éä„É¥„Ç£„Ç®„Éª„Çπ„Éà„Éº„ÇØ„Çπ": "„ÄêAIËß£Ë™¨„ÄëÊµÅ‰Ωì„ÅÆÈÅãÂãï„ÇíË®òËø∞„Åô„ÇãÊñπÁ®ãÂºè„ÄÇÈùûÁ∑öÂΩ¢ÂÅèÂæÆÂàÜÊñπÁ®ãÂºè„Åß„ÅÇ„Çä„ÄÅËß£„ÅÆÂ≠òÂú®Ë®ºÊòé„ÅØÈõ£Âïè„Åß„Åô„ÄÇ"
        };
        for(let key in dictionary) {
            if(text.includes(key)) {
                setTimeout(() => {
                    const ai = document.createElement('div'); ai.className = 'ai-bubble';
                    ai.innerHTML = `<span class="ai-badge">Gemini Support</span><br>${dictionary[key]}`;
                    if(window.renderMathInElement) renderMathInElement(ai, mathOptions);
                    document.getElementById('chat-area').appendChild(ai);
                    document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
                }, 1000);
                break;
            }
        }
    }

    function showStep(s) {
        document.getElementById('step-register').style.display = 'none';
        document.getElementById('step-home').style.display = 'none';
        document.getElementById('step-'+s).style.display = 'block';
        if(s === 'home') refreshHistory();
    }

    function refreshHistory() {
        const list = document.getElementById('history-list'); list.innerHTML = "";
        JSON.parse(localStorage.getItem('chat_history') || "[]").forEach(gid => {
            const div = document.createElement('div');
            div.style = "background:white; padding:15px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;";
            div.innerHTML = `<span><b>${gid}</b></span><button onclick="window.enterChatTrigger('${gid}')" style="background:var(--line-green);color:white;border:none;padding:8px 15px;border-radius:10px;">ÂÖ•ÂÆ§</button>`;
            list.appendChild(div);
        });
        document.getElementById('welcome-msg').innerText = "Researcher: " + myName;
    }
    window.enterChatTrigger = (gid) => enterChat(gid);
    window.onload = () => { (myName && myEmail) ? showStep('home') : showStep('register'); };
</script>
</body>
</html>
