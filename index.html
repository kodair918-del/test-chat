<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue, update, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = { 
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo", 
        databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com", 
        projectId: "my-chat-1d626" 
    };
    const app = initializeApp(config); 
    const db = getDatabase(app);

    // --- ä¿®æ­£ï¼šIDãŒãªã„å ´åˆã«æ–°è¦ç™ºè¡Œã™ã‚‹å‡¦ç†ã‚’è¿½åŠ  ---
    let myId = localStorage.getItem('chat_uid');
    // --- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²å‡¦ç† ---
    window.execLogin = async () => {
        const id = document.getElementById('login-id').value;
        const pw = document.getElementById('login-pw').value;
        if (!id || !pw) return alert("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        const userRef = ref(db, `v20_users/${id}`);
        const snap = await get(userRef);

        if (snap.exists()) {
            // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
            if (snap.val().pw === pw) {
                loginSuccess(id, snap.val().name);
            } else {
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
            }
        } else {
            // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šç™»éŒ²
            await set(userRef, { name: id, pw: pw, icon: "" });
            loginSuccess(id, id);
            alert("æ–°è¦ç™»éŒ²ã—ã¾ã—ãŸ");
        }
    };

    function loginSuccess(id, name) {
        myId = id;
        myName = name;
        localStorage.setItem('chat_uid', id);
        localStorage.setItem('chat_name', name);
        document.getElementById('login-modal').style.display = 'none';
        window.goHome();
    }
    let myName = localStorage.getItem('chat_name') || "æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼";
    let myIcon = "", currentGid = null;
    let lastSeen = JSON.parse(localStorage.getItem('chat_last_seen') || "{}");

    // åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«IDã‚’ç”Ÿæˆã—ã¦ç™»éŒ²
    async function checkUserAuth() {
        if (!myId) {
            myId = "u_" + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('chat_uid', myId);
            localStorage.setItem('chat_name', myName);
            // Firebaseã«åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
            await set(ref(db, `v20_users/${myId}`), { name: myName, icon: "" });
        }
        window.goHome();
    }

    window.toggleNeon = (isOn) => { document.body.classList.toggle('neon-mode', isOn); localStorage.setItem('neon_enabled', isOn); };
    const drawIcon = (el, url, name) => { if(!el) return; if(url) el.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover;">`; else { el.innerHTML = name ? name[0] : "?"; el.style.background = "var(--accent)"; } };

    window.goHome = async () => {
        currentGid = null; 
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        document.getElementById('main-modal').classList.add('active');
        document.getElementById('chat-footer').style.display = "none";
        document.getElementById('header-set-btn').style.visibility = "hidden";
        document.getElementById('head-title').innerText = "ãƒ›ãƒ¼ãƒ ";

        const uSnap = await get(ref(db, `v20_users/${myId}`));
        if(uSnap.exists()) { 
            myName = uSnap.val().name; 
            myIcon = uSnap.val().icon || ""; 
            localStorage.setItem('chat_name', myName); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚æ›´æ–°
        }
        
        document.getElementById('u-name-display').innerText = myName;
        document.getElementById('u-id-display').innerText = "@" + myId;
        drawIcon(document.getElementById('home-icon-preview'), myIcon, myName);

        // ä»¥ä¸‹ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿å‡¦ç†...
        const listSnap = await get(ref(db, `v20_users/${myId}/myGroups`));
        const list = document.getElementById('project-list'); list.innerHTML = "";
        if(listSnap.exists()) {
            for(let gid of Object.keys(listSnap.val())) {
                const unread = await calculateUnread(gid);
                const b = document.createElement('button'); b.className = "btn-main";
                b.innerHTML = `<span>${gid.split('_')[0]}</span> ${unread > 0 ? `<span class="badge">ğŸ”´ ${unread}</span>` : ''}`;
                b.onclick = () => window.enterChat(gid);
                list.appendChild(b);
            }
        }
    };

    // --- ä¸­ç•¥ï¼ˆä»–ã®é–¢æ•°ã¯ãã®ã¾ã¾ï¼‰ ---

    // èµ·å‹•æ™‚ã«å®Ÿè¡Œ
    window.onload = () => { 
        window.toggleNeon(localStorage.getItem('neon_enabled') === 'true'); 
        checkUserAuth(); // window.goHomeã®ä»£ã‚ã‚Šã«ã“ã‚Œã‚’å‘¼ã¶
    };
</script>

