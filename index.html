<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K | Expert AI Fixed</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; --gemini-blue: #4285F4; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; overflow: hidden; position: fixed; width: 100%; background: var(--bg-blue); font-family: sans-serif; }
        body { display: flex; flex-direction: column; }
        header { background: var(--header-dark); color: white; display: flex; align-items: center; height: 50px; padding: 0 10px; flex-shrink: 0; z-index: 100; }
        header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; width: 40px; }
        header .title { flex: 1; text-align: center; font-weight: bold; font-size: 16px; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 12px; }
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 85%; margin-bottom: 5px; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; }
        .me { align-self: flex-end; } .me .bubble { background: var(--line-green); color: white; }
        .ai-hint { font-size: 9px; color: white; margin-top: 2px; margin-left: 5px; opacity: 0.9; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .side-panel { position: fixed; top: 0; right: -100%; width: 100%; height: 100%; background: white; z-index: 2000; transition: 0.3s; padding: 20px; }
        .side-panel.open { right: 0; }
        #detail-panel { position: fixed; bottom: -100%; left: 0; width: 100%; height: 80%; background: white; z-index: 1500; transition: 0.4s; border-radius: 20px 20px 0 0; padding: 25px; overflow-y: auto; box-shadow: 0 -5px 15px rgba(0,0,0,0.2); }
        #detail-panel.open { bottom: 0; }
        .footer { background: white; padding: 10px; display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #ddd; }
        #msg-input { flex: 1; border: none; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; }
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <button onclick="window.backToHome()">ğŸ </button>
    <div class="title">Gemini Expert Chat</div>
    <button onclick="window.toggleSettings()">âš™ï¸</button>
</header>

<div id="chat-area"></div>

<div id="detail-panel">
    <button onclick="window.closeDetail()" style="float:right; border:none; background:none; font-size:24px;">&times;</button>
    <h3 style="color:var(--gemini-blue); margin:0 0 15px 0;">AI Expert Insight</h3>
    <div id="detail-content" style="line-height:1.6;"></div>
</div>

<div id="settings-panel" class="side-panel">
    <h3>Expert ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</h3>
    <hr>
    <label>Gemini API Key</label>
    <input type="password" id="set-api-key" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
    <label>ã‚ãªãŸã®å¹´é½¢</label>
    <input type="number" id="set-user-age" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
    <button class="btn-main" style="background:var(--gemini-blue);" onclick="window.saveSettings()">ä¿å­˜ã—ã¦åæ˜ </button>
    <button onclick="window.toggleSettings()" style="width:100%; margin-top:15px; background:none; border:none; color:#666;">é–‰ã˜ã‚‹</button>
</div>

<div id="login-modal" class="modal">
    <h2 style="color:var(--line-green);">Chat-K Expert</h2>
    <input type="email" id="login-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width:100%; padding:15px; border:1px solid #ddd; border-radius:12px; margin-bottom:10px;">
    <button class="btn-main" onclick="window.doLogin()">ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹</button>
</div>

<div class="footer">
    <textarea id="msg-input" rows="1" placeholder="ç†ç³»ã®è©±é¡Œã‚’å…¥åŠ›..."></textarea>
    <button onclick="window.sendMsg()" style="background:var(--gemini-blue); color:white; border:none; width:44px; height:44px; border-radius:50%;">â¤</button>
</div>

<script type="module">
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°å®šç¾© ---
    window.doLogin = () => {
        const email = document.getElementById('login-email').value;
        if(!email) return alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        localStorage.setItem('chat_email', email);
        document.getElementById('login-modal').style.display = 'none';
        window.renderMessage("System", `${email}ã•ã‚“ãŒå…¥å®¤ã—ã¾ã—ãŸ`, false, true);
    };

    window.backToHome = () => {
        if(confirm("ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
            // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿æƒ…å ±ã‚’ä¸€æ™‚æ¶ˆã•ãšã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤º
            document.getElementById('login-modal').style.display = 'flex';
        }
    };

    window.sendMsg = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim()) return;
        window.renderMessage("Me", inp.value, true);
        inp.value = "";
    };

    window.renderMessage = (name, text, isMe, isSystem = false) => {
        const area = document.getElementById('chat-area');
        if(isSystem) {
            const sys = document.createElement('div');
            sys.style = "align-self:center; background:rgba(0,0,0,0.1); padding:4px 10px; border-radius:10px; font-size:11px; color:white; margin:5px 0;";
            sys.innerText = text;
            area.appendChild(sys);
        } else {
            const wrap = document.createElement('div');
            wrap.className = `bubble-wrapper ${isMe ? 'me' : 'other'}`;
            wrap.innerHTML = `<div class="bubble">${text}</div><div class="ai-hint">ğŸ’¡ AIè§£èª¬ã‚’è¡¨ç¤º</div>`;
            wrap.onclick = () => window.askGemini(text);
            area.appendChild(wrap);
        }
        area.scrollTop = area.scrollHeight;
    };

    window.askGemini = async (text) => {
        const key = localStorage.getItem('gemini_api_key');
        const age = localStorage.getItem('user_age') || "20";
        const content = document.getElementById('detail-content');
        
        document.getElementById('detail-panel').classList.add('open');
        content.innerHTML = `<div style="text-align:center; padding:20px;">æ€è€ƒä¸­...<br><small>APIã«æ¥ç¶šã—ã¦ã„ã¾ã™</small></div>`;

        if(!key) {
            content.innerHTML = `<p style="color:red;">âš ï¸ APIã‚­ãƒ¼ãŒæœªè¨­å®šã§ã™ã€‚<br>å³ä¸Šã®âš™ï¸ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>`;
            return;
        }

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `ã‚ãªãŸã¯ç†ç³»è¬›å¸«ã§ã™ã€‚${age}æ­³å‘ã‘ã«ã€Œ${text}ã€ã‚’è§£èª¬ã€‚æ•°å¼ã¯LaTeXï¼ˆ$ï¼‰å¿…é ˆã€‚` }] }]
                })
            });

            if(!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || "APIã‚¨ãƒ©ãƒ¼");
            }

            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;
            content.innerHTML = aiText;
            
            if(window.renderMathInElement) {
                renderMathInElement(content, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });
            }
        } catch (e) {
            content.innerHTML = `<p style="color:red;">âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br><small>${e.message}</small></p>
            <p>ã€ç¢ºèªé …ç›®ã€‘<br>1. APIã‚­ãƒ¼ã¯æ­£ã—ã„ã§ã™ã‹ï¼Ÿ<br>2. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«ç¹‹ãŒã£ã¦ã„ã¾ã™ã‹ï¼Ÿ</p>`;
        }
    };

    window.saveSettings = () => {
        localStorage.setItem('gemini_api_key', document.getElementById('set-api-key').value.trim());
        localStorage.setItem('user_age', document.getElementById('set-user-age').value);
        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        window.toggleSettings();
    };

    window.toggleSettings = () => document.getElementById('settings-panel').classList.toggle('open');
    window.closeDetail = () => document.getElementById('detail-panel').classList.remove('open');

    window.onload = () => {
        if(localStorage.getItem('chat_email')) {
            document.getElementById('login-modal').style.display = 'none';
        }
        document.getElementById('set-api-key').value = localStorage.getItem('gemini_api_key') || "";
        document.getElementById('set-user-age').value = localStorage.getItem('user_age') || "20";
    };
</script>
</body>
</html>
