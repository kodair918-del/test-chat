// 設定画面を開く関数の「甘い」設定
window.openSettings = async () => {
    if (!currentGid) return;
    
    // モーダル表示を最優先（判定を待たずに開く）
    document.getElementById('settings-modal').classList.add('active');
    
    try {
        const gSnap = await get(ref(db, `v20_groups/${currentGid}`));
        if (!gSnap.exists()) return;
        
        const data = gSnap.val();
        
        // ホスト判定を「UIDが含まれているか」程度まで甘くする
        // 厳密な一致でなくても、データが存在すればパネルを表示候補に
        const isHost = (data.host === myId || data.host?.uid === myId || !data.host);
        
        const hostPanel = document.getElementById('host-panel');
        if (hostPanel) {
            hostPanel.style.display = isHost ? "block" : "none";
            if (isHost) {
                // 承認待ちリストの監視を開始
                onValue(ref(db, `v20_groups/${currentGid}/requests`), s => {
                    const area = document.getElementById('req-list');
                    if (area) {
                        area.innerHTML = "<h4>承認待ちユーザー:</h4>";
                        if (s.exists()) {
                            Object.entries(s.val()).forEach(([rid, r]) => {
                                const d = document.createElement('div');
                                d.style = "display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:rgba(0,0,0,0.05); padding:8px; border-radius:8px;";
                                d.innerHTML = `<span>${r.name}</span><button onclick="window.approve('${rid}','${r.uid}')" style="background:var(--success); color:white; border:none; padding:5px 10px; border-radius:5px;">承認</button>`;
                                area.appendChild(d);
                            });
                        } else {
                            area.innerHTML += "<p style='font-size:12px; opacity:0.5;'>現在なし</p>";
                        }
                    }
                });
            }
        }
    } catch (e) {
        console.error("Settings error:", e);
    }
};
