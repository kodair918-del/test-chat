<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K | Ver 18.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --accent: #007AFF; --bg: #FFFFFF; --card: #F2F2F7; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        header { height: 60px; display: flex; align-items: center; padding: 0 15px; border-bottom: 0.5px solid #DDD; }
        .title { flex: 1; text-align: center; font-weight: bold; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px; }
        .input-area { height: 80px; padding: 10px; display: flex; gap: 10px; background: var(--card); }
        .input-box { flex: 1; border-radius: 20px; border: 1px solid #CCC; padding: 0 15px; font-size: 16px; outline: none; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: none; padding: 20px; }
        .modal.active { display: block; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .btn { width: 100%; height: 45px; border-radius: 10px; border: none; background: var(--accent); color: white; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

<header>
    <button onclick="location.reload()">üè†</button>
    <div class="title" id="head-title">Chat-K</div>
    <button onclick="document.getElementById('set-modal').classList.add('active')">‚öôÔ∏è</button>
</header>

<div id="chat-area"></div>

<div class="input-area" id="input-ui" style="display:none;">
    <input type="text" id="msg-input" class="input-box" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...">
    <button onclick="window.sendMsg()" style="background:none; border:none; font-size:24px;">‚¨ÜÔ∏è</button>
</div>

<div id="auth-modal" class="modal">
    <h2>üß™ Chat-K „É≠„Ç∞„Ç§„É≥</h2>
    <div class="card">
        <input type="text" id="a-uid" class="input-box" placeholder="ID" style="width:100%; margin-bottom:10px;">
        <input type="password" id="a-pw" class="input-box" placeholder="PASS" style="width:100%; margin-bottom:10px;">
        <button class="btn" onclick="window.handleAuth()">„É≠„Ç∞„Ç§„É≥ / Êñ∞Ë¶èÁôªÈå≤</button>
    </div>
</div>

<div id="set-modal" class="modal">
    <h2>‚öôÔ∏è Ë®≠ÂÆö</h2>
    <div class="card">
        <p>ÂêçÂâç: <input type="text" id="edit-name"></p>
        <button class="btn" onclick="window.saveProfile()">‰øùÂ≠ò</button>
        <button class="btn" style="background:#8E8E93;" onclick="this.parentElement.parentElement.classList.remove('active')">Èñâ„Åò„Çã</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = { apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo", databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com" };
    const app = initializeApp(config);
    const db = getDatabase(app);

    let my = { id: localStorage.getItem('chat_uid'), name: localStorage.getItem('chat_name') };
    let currentGid = "public-room"; // „Åì„ÅÆÈ†É„ÅØÊö´ÂÆöÁöÑ„Å´Âõ∫ÂÆö„Åæ„Åü„ÅØÈÅ∏ÊäûÂà∂

    // „É°„ÉÉ„Ç∑„É•ÂåñÔºà„Éè„ÉÉ„Ç∑„É•Èñ¢Êï∞Ôºâ
    const mesh = (t) => CryptoJS.SHA256(t).toString();

    window.handleAuth = async () => {
        const uid = document.getElementById('a-uid').value;
        const pw = document.getElementById('a-pw').value;
        const hpw = mesh(pw); // ÂÖ•Âäõ„Åï„Çå„ÅüPASS„ÇíÂç≥Â∫ß„Å´„É°„ÉÉ„Ç∑„É•Âåñ

        const s = await get(ref(db, `v10_users/${uid}`));
        if(s.exists()) {
            if(s.val().pw === hpw) {
                loginSuccess(uid, s.val().name);
            } else {
                alert("„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô");
            }
        } else {
            // Êñ∞Ë¶èÁôªÈå≤
            const nm = prompt("Ë°®Á§∫Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            await set(ref(db, `v10_users/${uid}`), { name: nm, pw: hpw });
            loginSuccess(uid, nm);
        }
    };

    function loginSuccess(id, nm) {
        localStorage.setItem('chat_uid', id);
        localStorage.setItem('chat_name', nm);
        location.reload();
    }

    if(my.id) {
        document.getElementById('auth-modal').classList.remove('active');
        document.getElementById('input-ui').style.display = 'flex';
        startChat();
    } else {
        document.getElementById('auth-modal').classList.add('active');
    }

    function startChat() {
        onValue(ref(db, `v10_groups/${currentGid}/messages`), (s) => {
            const area = document.getElementById('chat-area');
            area.innerHTML = "";
            if(s.exists()) {
                Object.values(s.val()).forEach(m => {
                    const d = document.createElement('div');
                    d.innerHTML = `<b>${m.sender}</b>: ${m.text}`;
                    area.appendChild(d);
                });
            }
        });
    }

    window.sendMsg = () => {
        const txt = document.getElementById('msg-input').value;
        if(!txt) return;
        push(ref(db, `v10_groups/${currentGid}/messages`), {
            sender: my.name,
            text: txt,
            time: Date.now()
        });
        document.getElementById('msg-input').value = "";
    };
</script>
</body>
</html>
