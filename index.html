<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K</title> <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg-blue); font-family: sans-serif; }
        body { display: flex; flex-direction: column; }

        header { 
            background: var(--header-dark); 
            color: white; 
            padding: 0 10px; 
            display: grid; 
            grid-template-columns: 50px 1fr 50px; 
            align-items: center; 
            height: 55px; 
            flex-shrink: 0; 
            padding-top: env(safe-area-inset-top);
            z-index: 100;
        }
        header button { background: none; border: none; color: white; font-size: 22px; cursor: pointer; }
        header .title { text-align: center; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        #chat-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px 10px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            -webkit-overflow-scrolling: touch;
        }

        .footer { 
            background: #fff; 
            padding: 10px 10px calc(10px + env(safe-area-inset-bottom)); 
            display: flex; 
            align-items: flex-end; 
            gap: 8px; 
            border-top: 1px solid #ddd;
            flex-shrink: 0;
        }
        #msg-input { 
            flex: 1; 
            border: none; 
            background: #f0f2f5; 
            padding: 12px 15px; 
            border-radius: 20px; 
            font-size: 16px; 
            outline: none; 
            max-height: 150px;
            resize: none;
            line-height: 1.4;
        }

        /* ãµãã ã—ã‚¹ã‚¿ã‚¤ãƒ« */
        .bubble { padding: 8px 12px; border-radius: 18px; font-size: 15px; background: white; white-space: pre-wrap; word-break: break-all; max-width: 80%; }
        .me { align-self: flex-end; } .me .bubble { background: var(--line-green); color: white; border-top-right-radius: 2px; }
        .other { align-self: flex-start; } .other .bubble { border-top-left-radius: 2px; }

        /* è¨­å®šãƒ‘ãƒãƒ« */
        #settings-panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100%; background: white; z-index: 2000; transition: 0.3s; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.2); overflow-y: auto; }
        #settings-panel.open { right: 0; }
        .member-chip { display: inline-block; background: #f0f2f5; padding: 5px 12px; border-radius: 15px; font-size: 13px; margin: 3px; border: 1px solid #ddd; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 20px; display: block; overflow-y: auto; }
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        #scanner-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 3000; display: none; flex-direction: column; }
    </style>
</head>
<body>

<header>
    <button onclick="location.reload()">ğŸ </button>
    <div class="title" id="display-group-name">Chat-K</div>
    <button id="gear-btn" onclick="openSettings()" style="display:none;">âš™ï¸</button>
    <div id="header-spacer" style="width:40px;"></div>
</header>

<div id="chat-area"></div>

<div class="footer">
    <textarea id="msg-input" rows="1" placeholder="Shift+Enterã§é€ä¿¡ (PC)" onkeydown="handleKeyDown(event)"></textarea>
    <button onclick="sendMessage()" style="background:var(--line-green); color:white; border:none; width:44px; height:44px; border-radius:50%; flex-shrink:0;">â¤</button>
</div>

<div id="settings-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š</h3>
        <button onclick="closeSettings()" style="font-size:30px; border:none; background:none;">&times;</button>
    </div>
    <hr>
    <div id="host-only-info" style="display:none; background:#fff9c4; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #fbc02d;">
        <p style="margin:0; font-size:12px; color:#856404;"><b>ğŸ”‘ ãƒ›ã‚¹ãƒˆé™å®šæƒ…å ±</b></p>
        <p style="margin:8px 0 0; font-size:18px;">PW: <strong id="info-pw"></strong></p>
    </div>
    <div style="text-align:left; margin-bottom:20px;">
        <p style="font-weight:bold; margin-bottom:8px;">å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼:</p>
        <div id="member-list"></div>
    </div>
    <div id="qr-code" style="margin:10px auto; display:flex; justify-content:center; background:white; padding:10px; border-radius:10px; width:fit-content;"></div>
    <hr>
    <button onclick="leaveGroup()" style="width:100%; padding:12px; background:#ff4b4b; color:white; border:none; border-radius:8px; margin-top:10px;">å±¥æ­´ã‹ã‚‰å‰Šé™¤</button>
</div>

<div id="main-modal" class="modal">
    <h2 style="color:var(--line-green); margin-top:20px; text-align:center;">Chat-K</h2>
    <div id="step-register">
        <input type="email" id="reg-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-bottom:15px; font-size:16px;">
        <div id="name-input-area" style="display:none;">
            <input type="text" id="reg-name" placeholder="ãŠåå‰" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-bottom:15px; font-size:16px;">
        </div>
        <button class="btn-main" id="auth-btn" onclick="checkEmail()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="step-home" style="display:none;">
        <p id="welcome-msg" style="font-weight:bold; text-align:center;"></p>
        <button class="btn-main" onclick="startScanner()" style="background:#4285F4; margin-bottom:20px;">ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³ã§å‚åŠ </button>
        <div id="history-list"></div>
        <button onclick="toggleForm('join')" style="width:100%; background:#eee; border:none; padding:15px; border-radius:12px; margin-top:10px;">æ‰‹å‹•å‚åŠ </button>
        <button onclick="toggleForm('create')" style="width:100%; background:none; border:1px solid #ccc; padding:10px; border-radius:12px; margin-top:10px; color:#666;">ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</button>
        <div id="group-form" style="display:none; margin-top:15px; background:#fff; padding:15px; border-radius:15px; border:1px solid #ddd;">
            <input type="text" id="group-id" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ccc; border-radius:8px;">
            <input type="password" id="group-pw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ccc; border-radius:8px;">
            <button class="btn-main" onclick="handleGroupAction()">æ±ºå®š</button>
        </div>
        <div style="text-align:center;"><button onclick="logout()" style="color:red; border:none; background:none; margin-top:40px; font-size:14px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div>
    </div>
</div>

<div id="scanner-container">
    <div style="color:white; padding:20px; font-size:18px;" onclick="stopScanner()">âœ• é–‰ã˜ã‚‹</div>
    <video id="video-preview" style="width:100%; height:70%; object-fit:cover;"></video>
    <canvas id="scan-canvas" style="display:none;"></canvas>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get, set, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com",
        projectId: "my-chat-1d626",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = localStorage.getItem('chat_name'), myEmail = localStorage.getItem('chat_email'), currentGid = "";
    let members = {};

    // ã‚¹ãƒãƒ›ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒªã‚µã‚¤ã‚ºå¯¾ç­–
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            document.body.style.height = window.visualViewport.height + 'px';
        });
    }

    window.onload = () => { (myName && myEmail) ? showStep('home') : showStep('register'); };

    // PCç”¨é€ä¿¡ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: Shift + Enter ã§é€ä¿¡
    window.handleKeyDown = (e) => {
        if (e.key === 'Enter' && e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    };

    window.sendMessage = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim() || !currentGid) return;
        push(ref(db, `v5_groups/${currentGid}/messages`), { name: myName, sender: myEmail, text: inp.value });
        inp.value = "";
        inp.focus(); // é€ä¿¡å¾Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
    };

    // --- ä»¥ä¸‹ã€æ—¢å­˜æ©Ÿèƒ½ã®å®‰å®šåŒ–ç‰ˆ ---
    window.enterChat = (gid) => {
        currentGid = gid; members = {};
        document.getElementById('main-modal').style.display = 'none';
        document.getElementById('gear-btn').style.display = 'block';
        document.getElementById('header-spacer').style.display = 'none';
        document.getElementById('display-group-name').innerText = gid;
        document.getElementById('chat-area').innerHTML = "";
        const chatRef = ref(db, `v5_groups/${gid}/messages`);
        off(chatRef);
        onChildAdded(chatRef, (snap) => {
            const d = snap.val();
            members[d.sender] = d.name;
            const wrap = document.createElement('div');
            wrap.className = `bubble-wrapper ${d.sender === myEmail ? 'me' : 'other'}`;
            wrap.style.display = "flex"; wrap.style.flexDirection = "column";
            wrap.innerHTML = `<div style="font-size:10px;margin:2px 5px;color:#eee;">${d.name}</div><div class="bubble">${d.text}</div>`;
            document.getElementById('chat-area').appendChild(wrap);
            document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
        });
    };

    window.openSettings = async () => {
        const snap = await get(ref(db, `v5_groups/${currentGid}`));
        const data = snap.val();
        if(data.host === myEmail) {
            document.getElementById('host-only-info').style.display = 'block';
            document.getElementById('info-pw').innerText = atob(data.pw);
        } else { document.getElementById('host-only-info').style.display = 'none'; }
        const listDiv = document.getElementById('member-list'); listDiv.innerHTML = "";
        Object.keys(members).forEach(mEmail => {
            const span = document.createElement('span'); span.className = 'member-chip';
            span.innerHTML = members[mEmail] + (mEmail === data.host ? ' <small style="color:#856404;">â˜…</small>' : '');
            listDiv.appendChild(span);
        });
        document.getElementById('qr-code').innerHTML = "";
        new QRCode(document.getElementById('qr-code'), { text: `${window.location.origin}${window.location.pathname}?join=${currentGid}`, width: 150, height: 150 });
        document.getElementById('settings-panel').classList.add('open');
    };

    window.closeSettings = () => document.getElementById('settings-panel').classList.remove('open');

    window.checkEmail = async () => {
        const email = document.getElementById('reg-email').value.trim();
        const snap = await get(ref(db, `users/${email.replace(/\./g, '_')}`));
        if(snap.exists()){
            myName = snap.val().name; myEmail = email;
            localStorage.setItem('chat_name', myName); localStorage.setItem('chat_email', myEmail);
            if(snap.val().history) localStorage.setItem('chat_history', JSON.stringify(snap.val().history));
            showStep('home');
        } else { document.getElementById('name-input-area').style.display = 'block'; document.getElementById('auth-btn').onclick = () => finalizeNewAccount(email); }
    };
    async function finalizeNewAccount(email) {
        const name = document.getElementById('reg-name').value.trim();
        if(!name) return;
        await set(ref(db, `users/${email.replace(/\./g, '_')}`), { name: name, history: [] });
        myName = name; myEmail = email;
        localStorage.setItem('chat_name', name); localStorage.setItem('chat_email', email);
        showStep('home');
    }
    window.handleGroupAction = async () => {
        const gid = document.getElementById('group-id').value.trim(), pw = btoa(document.getElementById('group-pw').value);
        const snap = await get(ref(db, `v5_groups/${gid}`));
        if(window.currentMode === 'create') {
            if(snap.exists()) return alert("æ—¢ã«å­˜åœ¨ã—ã¾ã™");
            await set(ref(db, `v5_groups/${gid}`), { host: myEmail, pw: pw });
        } else { if(!snap.exists() || snap.val().pw !== pw) return alert("èªè¨¼ã‚¨ãƒ©ãƒ¼"); }
        saveGroupLocal(gid, pw); enterChat(gid);
    };
    function saveGroupLocal(gid, pw) {
        let h = JSON.parse(localStorage.getItem('chat_history') || "[]"); if(!h.includes(gid)) h.push(gid);
        localStorage.setItem('chat_history', JSON.stringify(h));
        let a = JSON.parse(localStorage.getItem('chat_access') || "{}"); a[gid] = pw;
        localStorage.setItem('chat_access', JSON.stringify(a));
        set(ref(db, `users/${myEmail.replace(/\./g, '_')}/history`), h);
    }
    window.startScanner = async () => {
        document.getElementById('scanner-container').style.display = 'flex';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            const video = document.getElementById('video-preview');
            video.srcObject = stream; video.play();
            const tick = () => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    const canvas = document.getElementById('scan-canvas');
                    canvas.height = video.videoHeight; canvas.width = video.videoWidth;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
                    if (code) {
                        stopScanner();
                        const gid = new URL(code.data).searchParams.get('join');
                        if(gid) {
                            const pw = prompt(`ã‚°ãƒ«ãƒ¼ãƒ—ã€Œ${gid}ã€ã®PW`);
                            if(pw) { document.getElementById('group-id').value = gid; document.getElementById('group-pw').value = pw; window.currentMode = 'join'; handleGroupAction(); }
                        }
                        return;
                    }
                }
                if(document.getElementById('scanner-container').style.display === 'flex') requestAnimationFrame(tick);
            };
            requestAnimationFrame(tick);
        } catch(e) { alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼"); stopScanner(); }
    };
    window.stopScanner = () => {
        const video = document.getElementById('video-preview');
        if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        document.getElementById('scanner-container').style.display = 'none';
    };
    window.toggleForm = (m) => { window.currentMode = m; document.getElementById('group-form').style.display = 'block'; };
    function showStep(s) {
        document.getElementById('step-register').style.display = 'none';
        document.getElementById('step-home').style.display = 'none';
        document.getElementById('step-'+s).style.display = 'block';
        if(s === 'home') refreshHistory();
    }
    function refreshHistory() {
        const list = document.getElementById('history-list'); list.innerHTML = "";
        JSON.parse(localStorage.getItem('chat_history') || "[]").forEach(gid => {
            const div = document.createElement('div');
            div.style = "background:white; padding:15px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #ddd;";
            div.innerHTML = `<span><b>${gid}</b></span><button onclick="enterChat('${gid}')" style="background:var(--line-green);color:white;border:none;padding:10px 20px;border-radius:10px;">å…¥å®¤</button>`;
            list.appendChild(div);
        });
        document.getElementById('welcome-msg').innerText = "ãƒ­ã‚°ã‚¤ãƒ³: " + myName;
    }
    window.leaveGroup = () => { if(confirm("å±¥æ­´ã‹ã‚‰æ¶ˆã™ï¼Ÿ")) {
        let h = JSON.parse(localStorage.getItem('chat_history') || "[]").filter(g => g !== currentGid);
        localStorage.setItem('chat_history', JSON.stringify(h)); location.reload();
    }};
    window.logout = () => { if(confirm("å…¨æ¶ˆå»ï¼Ÿ")) { localStorage.clear(); location.reload(); } };
</script>
</body>
</html>
