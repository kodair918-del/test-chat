<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Video Chat v2.0.5</title>
    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room@latest/dist/skyway_room.js"></script>
    <style>
        body { background-color: #7494c0; font-family: sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #version-tag { position: fixed; bottom: 5px; right: 10px; color: rgba(255,255,255,0.7); font-size: 10px; z-index: 1000; cursor: pointer; text-decoration: underline; }
        #home-screen { padding: 20px; text-align: center; color: white; flex: 1; overflow-y: auto; }
        .group-card { background: white; color: #333; padding: 15px; border-radius: 10px; margin: 10px auto; width: 80%; max-width: 300px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
        .box { background: white; padding: 25px; border-radius: 10px; text-align: center; width: 85%; max-width: 320px; }
        input { width: 90%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        #chat-container { display: none; flex-direction: column; height: 100vh; }
        #chat-header { background: #557094; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        #video-area { display: none; background: #000; height: 180px; gap: 2px; padding: 2px; }
        video { flex: 1; height: 100%; background: #222; border-radius: 5px; object-fit: cover; }
        #chat-screen { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; background: #f0f2f5; }
        .balloon { padding: 10px 15px; border-radius: 18px; background: white; margin-bottom: 10px; max-width: 75%; color: #333; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .right { align-self: flex-end; background-color: #8de055; }
        .input-area { background: #fff; padding: 10px; display: flex; gap: 8px; border-top: 1px solid #ddd; }
        button { padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .btn-green { background: #28a745; color: white; }
        .btn-blue { background: #007bff; color: white; }
    </style>
</head>
<body>

<div id="version-tag" onclick="showAdmin()">Ver 2.0.5 (Settings Mode)</div>

<div id="home-screen">
    <h2 style="margin-top:40px;">ãƒã‚¤ã‚°ãƒ«ãƒ¼ãƒ—</h2>
    <div id="group-list"></div>
    <button class="btn-green" onclick="showLogin()" style="margin-top:20px; font-size:18px;">ï¼‹ æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—</button>
</div>

<div id="admin-screen" class="modal">
    <div class="box">
        <h3>SkyWayè¨­å®š</h3>
        <p style="font-size:12px; color:#666;">APIã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="text" id="admin-key" placeholder="APIã‚­ãƒ¼">
        <input type="text" id="admin-secret" placeholder="ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼">
        <button class="btn-blue" onclick="saveAdmin()">è¨­å®šã‚’ä¿å­˜</button>
        <button onclick="document.getElementById('admin-screen').style.display='none'">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="login-screen" class="modal">
    <div class="box">
        <h3>ã‚°ãƒ«ãƒ¼ãƒ—å…¥å®¤</h3>
        <input type="text" id="group-id" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å">
        <input type="text" id="group-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <input type="text" id="user-id" placeholder="ã‚ãªãŸã®åå‰">
        <div style="margin-top:15px;">
            <button class="btn-blue" onclick="window.enterGroup(true)">ä¿å­˜ã—ã¦å…¥å®¤</button>
            <button onclick="document.getElementById('login-screen').style.display='none'">æˆ»ã‚‹</button>
        </div>
    </div>
</div>

<div id="chat-container">
    <div id="chat-header">
        <button onclick="location.reload()" style="background:none; color:white; font-size:24px;">ğŸ </button>
        <span id="display-group-name"></span>
        <button id="call-btn" class="btn-green">ğŸ“é€šè©±</button>
    </div>
    <div id="video-area">
        <video id="local-video" autoplay playsinline muted></video>
        <div id="remote-videos" style="display:contents;"></div>
    </div>
    <div id="chat-screen"></div>
    <div class="input-area">
        <input type="text" id="input-message" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸...">
        <button id="send-btn" class="btn-blue">é€ä¿¡</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        projectId: "my-chat-1d626",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName, chatRef;

    // ç®¡ç†è¨­å®šã®è¡¨ç¤ºãƒ»ä¿å­˜
    window.showAdmin = () => {
        document.getElementById('admin-key').value = localStorage.getItem('skywayKey') || "";
        document.getElementById('admin-secret').value = localStorage.getItem('skywaySecret') || "";
        document.getElementById('admin-screen').style.display = 'flex';
    };
    window.saveAdmin = () => {
        localStorage.setItem('skywayKey', document.getElementById('admin-key').value);
        localStorage.setItem('skywaySecret', document.getElementById('admin-secret').value);
        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
        location.reload();
    };

    window.onload = () => {
        const list = document.getElementById('group-list');
        const groups = JSON.parse(localStorage.getItem('myGroups') || "[]");
        list.innerHTML = "";
        groups.forEach(g => {
            const div = document.createElement('div');
            div.className = 'group-card';
            div.innerHTML = `<strong>${g.id}</strong><button class="btn-blue" style="border-radius:5px; padding:5px 15px;">å…¥å®¤</button>`;
            div.onclick = () => {
                const user = prompt("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                if(user) startChat(g.id, g.pass, user);
            };
            list.appendChild(div);
        });
    };

    window.showLogin = () => document.getElementById('login-screen').style.display = 'flex';

    window.enterGroup = (save) => {
        const id = document.getElementById('group-id').value;
        const pass = document.getElementById('group-pass').value;
        const user = document.getElementById('user-id').value;
        if(!id || !pass || !user) return alert("å…¨éƒ¨å…¥åŠ›ã—ã¦ãã ã•ã„");
        if(save) {
            let gs = JSON.parse(localStorage.getItem('myGroups') || "[]");
            if(!gs.find(g => g.id === id)) { gs.push({id, pass}); localStorage.setItem('myGroups', JSON.stringify(gs)); }
        }
        startChat(id, pass, user);
    };

    async function startChat(id, pass, user) {
        myName = user;
        chatRef = ref(db, `rooms/${id}_${pass}/messages`);
        document.getElementById('display-group-name').innerText = id;
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('chat-container').style.display = 'flex';

        onChildAdded(chatRef, (d) => {
            const m = d.val();
            const div = document.createElement('div');
            div.className = `balloon ${m.name === myName ? 'right' : ''}`;
            div.innerText = `${m.name}: ${m.text}`;
            document.getElementById('chat-screen').appendChild(div);
            document.getElementById('chat-screen').scrollTop = document.getElementById('chat-screen').scrollHeight;
        });

        document.getElementById('call-btn').onclick = async () => {
            const key = localStorage.getItem('skywayKey');
            const secret = localStorage.getItem('skywaySecret');
            if(!key || !secret) return alert("å³ä¸‹ã®Verã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„");
            
            document.getElementById('video-area').style.display = 'flex';
            try {
                const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory, nowInSec, uuidV4 } = SkyWay;
                const context = await SkyWayContext.Create(key, {
                    auth: { jti: uuidV4(), iat: nowInSec(), exp: nowInSec() + 3600, 
                            scope: { app: { id: key, turn: true, actions: ["read", "write"] } } },
                    secret: secret
                });
                const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: id + pass });
                const member = await room.join();
                const { audio, video } = await SkyWayStreamFactory.createMicrophoneAudioAndCameraVideoStreams();
                document.getElementById('local-video').srcObject = video.track;
                await member.publish(audio); await member.publish(video);

                room.onStreamPublished.add(async (e) => {
                    if (e.publication.publisher.id === member.id) return;
                    const { stream } = await member.subscribe(e.publication.id);
                    if (stream.contentType === 'video') {
                        const v = document.createElement('video'); v.autoplay = true; v.playsinline = true;
                        v.srcObject = stream.track; document.getElementById('remote-videos').appendChild(v);
                    }
                });
            } catch (e) { alert("é€šè©±ã‚¨ãƒ©ãƒ¼: " + e.message); }
        };
    }

    document.getElementById('send-btn').onclick = () => {
        const i = document.getElementById('input-message');
        if(i.value && chatRef) { push(chatRef, { name: myName, text: i.value, time: serverTimestamp() }); i.value = ""; }
    };
</script>
</body>
</html>
