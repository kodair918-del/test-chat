<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K | Physics & Destruction</title>
    <style>
        :root {
            --accent: #007AFF; --bg: #000; --card-bg: #1c1c1e; --text: #ffffff;
            --header-bg: rgba(0, 0, 0, 0.8); --bubble-me: #007AFF; --bubble-other: #2c2c2e;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); overflow: hidden; position: fixed; width: 100%; height: 100%; }
        
        /* ËÉåÊôØÁâ©ÁêÜ„Ç®„É≥„Ç∏„É≥Áî®„Ç≠„É£„É≥„Éê„Çπ */
        #bg-canvas { position: fixed; top: 0; left: 0; z-index: 0; pointer-events: none; opacity: 0.6; }

        header { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background: var(--header-bg); height: 60px; display: flex; align-items: center; padding: 0 15px; border-bottom: 0.5px solid rgba(255,255,255,0.1); z-index: 2000; position: relative; }
        .title { flex: 1; text-align: center; font-weight: 600; font-size: 17px; }

        #chat-area { height: calc(100% - 60px); overflow-y: auto; padding: 20px 15px 140px; display: flex; flex-direction: column; gap: 15px; position: relative; z-index: 1000; }
        .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--header-bg); backdrop-filter: blur(20px); padding: 10px 15px 30px; display: none; gap: 10px; border-top: 0.5px solid rgba(255,255,255,0.1); z-index: 2500; align-items: center; }
        
        .std-input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255, 255, 255, 0.05); color: var(--text); outline: none; font-size: 16px; }
        #msg-input { flex: 1; border: none; background: rgba(255, 255, 255, 0.1); padding: 10px 15px; border-radius: 20px; color: var(--text); outline: none; font-size: 16px; resize: none; height: 40px; }
        .btn-main { width: 100%; height: 50px; background: var(--accent); color: white; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: opacity 0.2; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 3000; display: none; flex-direction: column; padding: 40px 20px; }
        .modal.active { display: flex; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; }
        
        .msg-row { display: flex; gap: 10px; max-width: 85%; }
        .msg-row.me { align-self: flex-end; flex-direction: row-reverse; }
        .bubble { padding: 10px 15px; border-radius: 18px; font-size: 16px; background: var(--bubble-other); line-height: 1.4; word-break: break-all; }
        .me .bubble { background: var(--bubble-me); }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <header>
        <button onclick="window.goHome()" style="background:none; border:none; font-size:20px; color:#fff;">üè†</button>
        <div class="title" id="head-title">ÁêÜÁßë & Á†¥Â£ä</div>
    </header>

    <div id="chat-area"></div>

    <div class="footer" id="chat-footer">
        <textarea id="msg-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏..."></textarea>
        <button onclick="window.sendMessage()" style="background:var(--accent); color:white; border:none; width:44px; height:44px; border-radius:50%;">‚Üë</button>
    </div>

    <div id="auth-overlay" class="modal">
        <div class="card" style="margin-top: auto; margin-bottom: auto;">
            <h2 style="text-align:center;">Chat-K Login</h2>
            <p style="text-align:center; opacity:0.5; font-size:12px;">ID„ÅÆ„Åø„ÅßË™çË®ºÔºà„Éë„Çπ„ÉØ„Éº„Éâ‰∏çË¶ÅÔºâ</p>
            <input type="text" id="auth-id" class="std-input" placeholder="„É¶„Éº„Ç∂„ÉºID„ÇíÂÖ•Âäõ">
            <button class="btn-main" onclick="window.execAuth()"><span>Ë™çË®º„Åó„Å¶ÈñãÂßã</span></button>
        </div>
    </div>

    <div id="main-modal" class="modal">
        <h3>„Éó„É≠„Ç∏„Çß„ÇØ„Éà</h3>
        <div id="project-list"></div>
        <div class="card">
            <input type="text" id="new-p-name" class="std-input" placeholder="Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç">
            <button class="btn-main" onclick="window.createProject()" style="background:#34C759;"><span>Ôºã Êñ∞Ë¶è‰ΩúÊàê</span></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, push, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const config = { apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo", databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com", projectId: "my-chat-1d626" };
        const app = initializeApp(config); const db = getDatabase(app);

        let myId = localStorage.getItem('chat_uid'), myName = localStorage.getItem('chat_name'), currentGid = null;

        // --- „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ ---
        window.execAuth = async () => {
            const id = document.getElementById('auth-id').value;
            if(!id) return alert("ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            
            const userRef = ref(db, `v20_users/${id}`);
            const snap = await get(userRef);
            if(!snap.exists()) {
                await set(userRef, { name: id, pw: "" });
            }
            localStorage.setItem('chat_uid', id);
            localStorage.setItem('chat_name', id);
            myId = id; myName = id;
            document.getElementById('auth-overlay').classList.remove('active');
            window.goHome();
        };

        window.goHome = async () => {
            currentGid = null;
            document.getElementById('main-modal').classList.add('active');
            document.getElementById('chat-footer').style.display = "none";
            
            const snap = await get(ref(db, `v20_users/${myId}/myGroups`));
            const list = document.getElementById('project-list'); list.innerHTML = "";
            if(snap.exists()){
                Object.keys(snap.val()).forEach(gid => {
                    const b = document.createElement('button'); b.className = "btn-main";
                    b.style.marginBottom = "10px";
                    b.innerHTML = `<span>${gid.split('_')[0]}</span>`;
                    b.onclick = () => window.enterChat(gid);
                    list.appendChild(b);
                });
            }
        };

        window.createProject = async () => {
            const name = document.getElementById('new-p-name').value;
            if(!name) return;
            const gid = name + "_" + Math.random().toString(36).substr(2,6);
            await set(ref(db, `v20_groups/${gid}`), { name: name, host: myId });
            await set(ref(db, `v20_users/${myId}/myGroups/${gid}`), true);
            document.getElementById('new-p-name').value = "";
            window.goHome();
        };

        window.enterChat = (gid) => {
            currentGid = gid;
            document.getElementById('main-modal').classList.remove('active');
            document.getElementById('chat-footer').style.display = "flex";
            onValue(ref(db, `v20_groups/${gid}/messages`), snap => {
                const area = document.getElementById('chat-area'); area.innerHTML = "";
                if(snap.exists()){
                    Object.values(snap.val()).forEach(m => {
                        const row = document.createElement('div');
                        row.className = `msg-row ${m.uid === myId ? 'me' : ''}`;
                        row.innerHTML = `<div class="bubble">${m.text}</div>`;
                        area.appendChild(row);
                    });
                    area.scrollTop = area.scrollHeight;
                }
            });
        };

        window.sendMessage = () => {
            const txt = document.getElementById('msg-input').value;
            if(!txt || !currentGid) return;
            push(ref(db, `v20_groups/${currentGid}/messages`), { uid: myId, text: txt, time: serverTimestamp() });
            document.getElementById('msg-input').value = "";
        };

        // --- ÁêÜÁßë„ÉªÁ†¥Â£ä„Ç®„É≥„Ç∏„É≥ (3D) ---
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let parts = [];
        const fov = 400;

        function initPhysics() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            parts = [];
            for(let i=0; i<200; i++) parts.push({
                x: (Math.random()-0.5)*400, y: (Math.random()-0.5)*400, z: (Math.random()-0.5)*400,
                vx: 0, vy: 0, vz: 0, active: false
            });
        }

        window.addEventListener('mousedown', (e) => {
            parts.forEach(p => {
                p.active = true;
                p.vx += (Math.random()-0.5)*20; p.vy += (Math.random()-0.5)*20; p.vz += (Math.random()-0.5)*20;
            });
        });

        function updatePhysics() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            parts.forEach(p => {
                if(p.active) {
                    p.vy += 0.2; p.x += p.vx; p.y += p.vy; p.z += p.vz;
                    if(p.y > 500) { p.y = 500; p.vy *= -0.5; }
                }
                let s = fov / (fov + p.z);
                let x2d = p.x * s + canvas.width/2;
                let y2d = p.y * s + canvas.height/2;
                ctx.fillStyle = `rgba(255,255,255,${s})`;
                ctx.fillRect(x2d, y2d, s*5, s*5);
            });
            requestAnimationFrame(updatePhysics);
        }

        // EnterÁÑ°ÂäπÂåñ„É´„Éº„É´
        document.addEventListener('keydown', e => { if(e.key==='Enter') e.preventDefault(); });

        window.onload = () => {
            initPhysics(); updatePhysics();
            if(!myId) document.getElementById('auth-overlay').classList.add('active');
            else window.goHome();
        };
    </script>
</body>
</html>
