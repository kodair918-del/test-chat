<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; width: 100%; background: var(--bg-blue); font-family: sans-serif; }
        body { display: flex; flex-direction: column; }
        header { background: var(--header-dark); color: white; display: flex; justify-content: space-between; align-items: center; height: 50px; padding: 0 10px; padding-top: env(safe-area-inset-top); flex-shrink: 0; z-index: 100; }
        header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; width: 40px; }
        header .title { flex: 1; text-align: center; font-weight: bold; font-size: 16px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 14px; -webkit-overflow-scrolling: touch; }
        .footer { background: #ffffff; padding: 8px 10px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #ddd; flex-shrink: 0; }
        #msg-input { flex: 1; border: none; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; max-height: 100px; resize: none; }
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .bubble { padding: 8px 14px; border-radius: 18px; font-size: 15px; background: white; white-space: pre-wrap; word-break: break-all; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sender-name { font-size: 11px; color: #555; margin-bottom: 3px; margin-left: 5px; }
        .me { align-self: flex-end; } .me .bubble { background: var(--line-green); color: white; border-top-right-radius: 2px; }
        .other { align-self: flex-start; } .other .bubble { border-top-left-radius: 2px; }
        #settings-panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100%; background: white; z-index: 2000; transition: 0.3s; padding: 20px; overflow-y: auto; }
        #settings-panel.open { right: 0; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 20px; display: block; overflow-y: auto; }
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .input-box { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 15px; font-size: 16px; outline: none; }
    </style>
</head>
<body>

<header>
    <button onclick="location.reload()">ğŸ </button>
    <div class="title" id="display-group-name">Chat-K</div>
    <button id="gear-btn" onclick="openSettings()" style="display:none;">âš™ï¸</button>
</header>

<div id="chat-area"></div>

<div class="footer">
    <textarea id="msg-input" rows="1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'" onkeydown="if(event.key==='Enter'&&!event.shiftKey&&window.innerWidth>=768){event.preventDefault();sendMessage();}"></textarea>
    <button onclick="sendMessage()" style="background:var(--line-green); color:white; border:none; width:40px; height:40px; border-radius:50%; flex-shrink:0;">â¤</button>
</div>

<div id="main-modal" class="modal">
    <h2 style="color:var(--line-green); text-align:center; margin-top:40px;">Chat-K</h2>
    
    <div id="step-register">
        <p style="text-align:center; color:#666; font-size:14px; margin-bottom:20px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§åˆ©ç”¨é–‹å§‹</p>
        <input type="email" id="reg-email" class="input-box" placeholder="example@gmail.com">
        
        <div id="name-input-area" style="display:none;">
            <p style="text-align:center; color:#666; font-size:14px;">åˆã‚ã¦ã®æ–¹ã¯ãŠåå‰ã‚’å…¥åŠ›</p>
            <input type="text" id="reg-name" class="input-box" placeholder="ã‚ãªãŸã®ãŠåå‰">
        </div>
        
        <button class="btn-main" id="auth-btn" onclick="checkEmail()">æ¬¡ã¸</button>
    </div>

    <div id="step-home" style="display:none; text-align:center;">
        <div style="background:white; padding:15px; border-radius:15px; margin-bottom:15px; border:1px solid #ddd;">
            <p id="welcome-msg" style="font-weight:bold; margin:0;"></p>
            <input type="text" id="edit-my-name" class="input-box" style="margin:10px 0; padding:10px; text-align:center;">
            <button onclick="updateProfileName()" style="font-size:12px; border:none; background:none; color:var(--line-green); font-weight:bold;">ãŠåå‰ã‚’æ›´æ–°</button>
        </div>
        <button class="btn-main" onclick="startScanner()" style="background:#4285F4; margin-bottom:15px;">ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³ã§å‚åŠ </button>
        <div id="history-list"></div>
        <button onclick="window.currentMode='join'; document.getElementById('group-form').style.display='block'" style="width:100%; background:#eee; border:none; padding:15px; border-radius:12px; margin-top:10px; font-weight:bold;">æ‰‹å‹•ã§ã‚°ãƒ«ãƒ¼ãƒ—ã«å‚åŠ </button>
        <button onclick="window.currentMode='create'; document.getElementById('group-form').style.display='block'" style="width:100%; background:none; border:1px solid #ccc; padding:10px; border-radius:12px; margin-top:10px; color:#666;">æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹</button>
        
        <div id="group-form" style="display:none; margin-top:10px; padding:15px; background:#fff; border-radius:12px; border:1px solid #ddd;">
            <input type="text" id="group-id" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" class="input-box" style="margin-bottom:10px;">
            <input type="password" id="group-pw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="input-box" style="margin-bottom:10px;">
            <button class="btn-main" onclick="handleGroupAction()">æ±ºå®š</button>
        </div>
        <button onclick="localStorage.clear(); location.reload();" style="color:red; border:none; background:none; margin-top:40px; font-size:12px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
</div>

<div id="settings-panel">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h3>è¨­å®š</h3><button onclick="closeSettings()" style="font-size:30px; border:none; background:none;">&times;</button></div>
    <div id="host-only-info" style="display:none; background:#fff9c4; padding:15px; border-radius:10px; margin-bottom:15px;">
        <p style="margin:0; font-size:12px;"><b>ğŸ”‘ ãƒ›ã‚¹ãƒˆæ¨©é™: PWå¤‰æ›´</b></p>
        <input type="text" id="edit-group-pw" class="input-box" style="padding:10px; margin:5px 0;">
        <button onclick="updateGroupPw()" style="width:100%;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿å­˜</button>
    </div>
    <div id="member-list"></div>
    <div id="qr-code" style="display:flex; justify-content:center; margin:20px 0;"></div>
    <button onclick="leaveGroup()" style="width:100%; padding:12px; background:#ff4b4b; color:white; border:none; border-radius:8px;">å±¥æ­´ã‹ã‚‰å‰Šé™¤</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get, set, off, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com",
        projectId: "my-chat-1d626",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = localStorage.getItem('chat_name'), myEmail = localStorage.getItem('chat_email'), currentGid = "";
    let members = {};

    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            document.body.style.height = window.visualViewport.height + 'px';
            if(currentGid) document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
        });
    }

    window.onload = () => { (myName && myEmail) ? showStep('home') : showStep('register'); };

    // --- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ–°è¦ç™»éŒ²ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£ ---
    window.checkEmail = async () => {
        const email = document.getElementById('reg-email').value.trim().toLowerCase();
        if(!email || !email.includes('@')) return alert("æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const userRef = ref(db, `users/${email.replace(/\./g, '_')}`);
        const snap = await get(userRef);

        if(snap.exists()){
            // ç™»éŒ²æ¸ˆã¿ï¼šãã®ã¾ã¾ãƒ­ã‚°ã‚¤ãƒ³
            const userData = snap.val();
            myName = userData.name;
            myEmail = email;
            localStorage.setItem('chat_name', myName);
            localStorage.setItem('chat_email', myEmail);
            if(userData.history) localStorage.setItem('chat_history', JSON.stringify(userData.history));
            showStep('home');
        } else {
            // æœªç™»éŒ²ï¼šåå‰å…¥åŠ›æ¬„ã‚’å‡ºã™
            document.getElementById('name-input-area').style.display = 'block';
            document.getElementById('auth-btn').innerText = "ç™»éŒ²ã‚’å®Œäº†ã™ã‚‹";
            document.getElementById('auth-btn').onclick = () => finalizeRegistration(email);
        }
    };

    async function finalizeRegistration(email) {
        const name = document.getElementById('reg-name').value.trim();
        if(!name) return alert("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const userRef = ref(db, `users/${email.replace(/\./g, '_')}`);
        await set(userRef, { name: name, history: [] });
        
        myName = name;
        myEmail = email;
        localStorage.setItem('chat_name', name);
        localStorage.setItem('chat_email', email);
        showStep('home');
    }

    // --- ãƒãƒ£ãƒƒãƒˆãƒ»è¨­å®šãƒ»ãã®ä»– (Ver 4.6.2æº–æ‹ ) ---
    window.sendMessage = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim() || !currentGid) return;
        push(ref(db, `v5_groups/${currentGid}/messages`), { name: myName, sender: myEmail, text: inp.value });
        inp.value = ""; inp.style.height = 'auto'; inp.focus();
    };

    window.enterChat = (gid) => {
        currentGid = gid; members = {};
        document.getElementById('main-modal').style.display = 'none';
        document.getElementById('gear-btn').style.display = 'block';
        document.getElementById('display-group-name').innerText = gid;
        document.getElementById('chat-area').innerHTML = "";
        const chatRef = ref(db, `v5_groups/${gid}/messages`);
        off(chatRef);
        onChildAdded(chatRef, (snap) => {
            const d = snap.val();
            members[d.sender] = d.name;
            const wrap = document.createElement('div');
            wrap.className = `bubble-wrapper ${d.sender === myEmail ? 'me' : 'other'}`;
            wrap.innerHTML = `<div class="sender-name">${d.name}</div><div class="bubble">${d.text}</div>`;
            document.getElementById('chat-area').appendChild(wrap);
            document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
        });
    };

    window.openSettings = async () => {
        const snap = await get(ref(db, `v5_groups/${currentGid}`));
        const data = snap.val();
        if(data.host === myEmail) {
            document.getElementById('host-only-info').style.display = 'block';
            document.getElementById('edit-group-pw').value = atob(data.pw);
        }
        document.getElementById('qr-code').innerHTML = "";
        new QRCode(document.getElementById('qr-code'), { text: `${window.location.origin}${window.location.pathname}?join=${currentGid}`, width: 140, height: 140 });
        document.getElementById('settings-panel').classList.add('open');
    };

    window.updateProfileName = async () => {
        const newName = document.getElementById('edit-my-name').value.trim();
        if(!newName) return;
        await update(ref(db, `users/${myEmail.replace(/\./g, '_')}`), { name: newName });
        localStorage.setItem('chat_name', newName); myName = newName;
        alert("åå‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ"); refreshHistory();
    };

    window.handleGroupAction = async () => {
        const gid = document.getElementById('group-id').value.trim(), pw = btoa(document.getElementById('group-pw').value);
        if(!gid || !document.getElementById('group-pw').value) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
        const snap = await get(ref(db, `v5_groups/${gid}`));
        if(window.currentMode === 'create') {
            if(snap.exists()) return alert("æ—¢ã«å­˜åœ¨ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—åã§ã™");
            await set(ref(db, `v5_groups/${gid}`), { host: myEmail, pw: pw });
        } else { if(!snap.exists() || snap.val().pw !== pw) return alert("ã‚°ãƒ«ãƒ¼ãƒ—åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); }
        saveGroupLocal(gid, pw); enterChat(gid);
    };

    function saveGroupLocal(gid, pw) {
        let h = JSON.parse(localStorage.getItem('chat_history') || "[]"); if(!h.includes(gid)) h.push(gid);
        localStorage.setItem('chat_history', JSON.stringify(h));
        update(ref(db, `users/${myEmail.replace(/\./g, '_')}`), { history: h });
    }

    function showStep(s) {
        document.getElementById('step-register').style.display = 'none';
        document.getElementById('step-home').style.display = 'none';
        document.getElementById('step-'+s).style.display = 'block';
        if(s === 'home') refreshHistory();
    }

    function refreshHistory() {
        const list = document.getElementById('history-list'); list.innerHTML = "";
        JSON.parse(localStorage.getItem('chat_history') || "[]").forEach(gid => {
            const div = document.createElement('div');
            div.style = "background:white; padding:12px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #ddd;";
            div.innerHTML = `<span><b>${gid}</b></span><button onclick="enterChat('${gid}')" style="background:var(--line-green);color:white;border:none;padding:8px 15px;border-radius:10px;">å…¥å®¤</button>`;
            list.appendChild(div);
        });
        document.getElementById('welcome-msg').innerText = myName;
        document.getElementById('edit-my-name').value = myName;
    }
    
    window.closeSettings = () => document.getElementById('settings-panel').classList.remove('open');
    window.leaveGroup = () => { if(confirm("å±¥æ­´ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { let h = JSON.parse(localStorage.getItem('chat_history') || "[]").filter(g => g !== currentGid); localStorage.setItem('chat_history', JSON.stringify(h)); location.reload(); }};
</script>
</body>
</html>
