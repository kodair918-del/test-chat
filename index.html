<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K | Expert AI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; --gemini-blue: #4285F4; }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; overflow: hidden; position: fixed; width: 100%; background: var(--bg-blue); font-family: sans-serif; }
        body { display: flex; flex-direction: column; }
        
        header { background: var(--header-dark); color: white; display: flex; align-items: center; height: 50px; padding: 0 10px; flex-shrink: 0; z-index: 100; }
        header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; width: 40px; }
        header .title { flex: 1; text-align: center; font-weight: bold; font-size: 16px; }

        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 12px; }
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 80%; margin-bottom: 8px; position: relative; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; }
        .me { align-self: flex-end; } .me .bubble { background: var(--line-green); color: white; }
        .ai-hint { font-size: 9px; color: white; margin-top: 2px; margin-left: 5px; opacity: 0.9; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒ‘ãƒãƒ« */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 20px; overflow-y: auto; }
        .side-panel { position: fixed; top: 0; right: -100%; width: 100%; height: 100%; background: white; z-index: 2000; transition: 0.3s; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
        .side-panel.open { right: 0; }
        
        #detail-panel { position: fixed; bottom: -100%; left: 0; width: 100%; height: 80%; background: white; z-index: 1500; transition: 0.4s; border-radius: 20px 20px 0 0; padding: 25px; overflow-y: auto; }
        #detail-panel.open { bottom: 0; }

        .footer { background: white; padding: 10px; display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #ddd; }
        #msg-input { flex: 1; border: none; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; }
        .btn-main { width: 100%; padding: 15px; background: var(--gemini-blue); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <button onclick="goHome()">ğŸ </button>
    <div class="title" id="display-title">Chat-K Expert</div>
    <button onclick="toggleSettings()">âš™ï¸</button>
</header>

<div id="chat-area"></div>

<div id="detail-panel">
    <button onclick="closeDetail()" style="float:right; border:none; background:none; font-size:24px;">&times;</button>
    <h4 id="detail-title" style="color:var(--gemini-blue); margin-top:0;">Gemini AI Analysis</h4>
    <div id="detail-content">AIè§£æä¸­...</div>
</div>

<div id="settings-panel" class="side-panel">
    <h3>Expert è¨­å®š</h3>
    <hr>
    <label>Gemini API Key</label>
    <input type="password" id="api-key" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:8px;" placeholder="AI Studioã®ã‚­ãƒ¼ã‚’å…¥åŠ›">
    
    <label>ã‚ãªãŸã®å¹´é½¢</label>
    <input type="number" id="user-age" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
    
    <button class="btn-main" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
    <button onclick="toggleSettings()" style="width:100%; margin-top:15px; background:none; border:none; color:#666;">é–‰ã˜ã‚‹</button>
</div>

<div id="main-modal" class="modal">
    <h2 style="text-align:center; color:var(--line-green); margin-top:40px;">Chat-K Expert</h2>
    <div id="step-auth">
        <input type="email" id="reg-email" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-bottom:10px;" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <button class="btn-main" onclick="checkAuth()" style="background:var(--line-green);">é–‹å§‹ã™ã‚‹</button>
    </div>
    <div id="step-home" style="display:none; text-align:center;">
        <p id="welcome-msg" style="font-weight:bold;"></p>
        <div id="history-list" style="margin:20px 0;"></div>
        <button onclick="createGroup()" class="btn-main">æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</button>
    </div>
</div>

<div class="footer">
    <textarea id="msg-input" rows="1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
    <button onclick="sendMsg()" style="background:var(--gemini-blue); color:white; border:none; width:44px; height:44px; border-radius:50%;">â¤</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = { /* ã‚ãªãŸã®Firebaseè¨­å®š */ };
    const app = initializeApp(config);
    const db = getDatabase(app);

    let myName = localStorage.getItem('chat_name'), myEmail = localStorage.getItem('chat_email');
    let apiKey = localStorage.getItem('gemini_api_key') || "";
    let userAge = localStorage.getItem('user_age') || "20";
    let currentGid = "";

    window.onload = () => {
        document.getElementById('api-key').value = apiKey;
        document.getElementById('user-age').value = userAge;
        if(myName) showHome();
    };

    // --- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ---
    window.goHome = () => {
        currentGid = "";
        document.getElementById('main-modal').style.display = 'block';
        document.getElementById('step-home').style.display = 'block';
        document.getElementById('step-auth').style.display = 'none';
        showHome();
    };

    // --- èªè¨¼ & ãƒ›ãƒ¼ãƒ  ---
    window.checkAuth = async () => {
        const email = document.getElementById('reg-email').value.trim().toLowerCase();
        if(!email) return;
        myEmail = email;
        localStorage.setItem('chat_email', email);
        myName = email.split('@')[0]; // ä»®ã®åå‰
        localStorage.setItem('chat_name', myName);
        showHome();
    };

    function showHome() {
        document.getElementById('step-auth').style.display = 'none';
        document.getElementById('step-home').style.display = 'block';
        document.getElementById('welcome-msg').innerText = `Researcher: ${myName}`;
        // å±¥æ­´è¡¨ç¤ºãªã©ã®å‡¦ç†ï¼ˆçœç•¥ï¼‰
    }

    // --- ãƒãƒ£ãƒƒãƒˆ & AI ---
    window.sendMsg = () => {
        const text = document.getElementById('msg-input').value.trim();
        if(!text) return;
        // Firebaseé€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå®Ÿéš›ã«ã¯GidãŒå¿…è¦ï¼‰
        renderMessage(myName, text, true);
        document.getElementById('msg-input').value = "";
    };

    async function fetchGemini(text) {
        if(!apiKey) return "âš™ï¸è¨­å®šã‹ã‚‰APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        const prompt = `ã‚ãªãŸã¯ç†ç³»å°‚é–€å®¶ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼å¹´é½¢${userAge}æ­³ã«å‘ã‘ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã®å°‚é–€ç”¨èªã‚’æŠ½å‡ºã—HTMLå½¢å¼ã§è§£èª¬ã—ã¦ãã ã•ã„ã€‚æ•°å¼ã¯LaTeXï¼ˆ$ï¼‰ã‚’ä½¿ç”¨ã€‚å¯¾è±¡: "${text}"`;
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        } catch(e) { return "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"; }
    }

    function renderMessage(name, text, isMe) {
        const area = document.getElementById('chat-area');
        const wrap = document.createElement('div');
        wrap.className = `bubble-wrapper ${isMe ? 'me' : 'other'}`;
        wrap.innerHTML = `<div class="bubble">${text}</div><div class="ai-hint">ğŸ’¡ AIè§£èª¬ã‚’è¡¨ç¤º</div>`;
        wrap.onclick = async () => {
            document.getElementById('detail-panel').classList.add('open');
            document.getElementById('detail-content').innerHTML = "GeminiãŒæ€è€ƒä¸­...";
            const res = await fetchGemini(text);
            document.getElementById('detail-content').innerHTML = res;
            if(window.renderMathInElement) renderMathInElement(document.getElementById('detail-content'));
        };
        area.appendChild(wrap);
        area.scrollTop = area.scrollHeight;
    }

    // --- è¨­å®šç®¡ç† ---
    window.saveSettings = () => {
        apiKey = document.getElementById('api-key').value;
        userAge = document.getElementById('user-age').value;
        localStorage.setItem('gemini_api_key', apiKey);
        localStorage.setItem('user_age', userAge);
        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        toggleSettings();
    };

    window.toggleSettings = () => document.getElementById('settings-panel').classList.toggle('open');
    window.closeDetail = () => document.getElementById('detail-panel').classList.remove('open');
    window.createGroup = () => { /* ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆãƒ­ã‚¸ãƒƒã‚¯ */ };
</script>
</body>
</html>
