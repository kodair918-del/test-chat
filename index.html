<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K | Expert AI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; --gemini-blue: #4285F4; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; overflow: hidden; position: fixed; width: 100%; background: var(--bg-blue); font-family: sans-serif; }
        body { display: flex; flex-direction: column; }
        header { background: var(--header-dark); color: white; display: flex; align-items: center; height: 50px; padding: 0 10px; flex-shrink: 0; z-index: 100; }
        header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        header .title { flex: 1; text-align: center; font-weight: bold; font-size: 16px; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 12px; }
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 85%; margin-bottom: 5px; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .me { align-self: flex-end; } .me .bubble { background: var(--line-green); color: white; }
        .ai-hint { font-size: 9px; color: white; margin-top: 2px; margin-left: 5px; opacity: 0.9; font-weight: bold; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .side-panel { position: fixed; top: 0; right: -100%; width: 100%; height: 100%; background: white; z-index: 2000; transition: 0.3s; padding: 20px; }
        .side-panel.open { right: 0; }
        #detail-panel { position: fixed; bottom: -100%; left: 0; width: 100%; height: 80%; background: white; z-index: 1500; transition: 0.4s; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 25px; overflow-y: auto; box-shadow: 0 -5px 15px rgba(0,0,0,0.2); }
        #detail-panel.open { bottom: 0; }
        .footer { background: white; padding: 10px; display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #ddd; }
        #msg-input { flex: 1; border: none; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; }
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    </style>
</head>
<body>

<header>
    <button onclick="window.goHome()">üè†</button>
    <div class="title" id="display-title">Chat-K Expert</div>
    <button onclick="window.toggleSettings()">‚öôÔ∏è</button>
</header>

<div id="chat-area"></div>

<div id="detail-panel">
    <button onclick="window.closeDetail()" style="float:right; border:none; background:none; font-size:24px;">&times;</button>
    <h3 id="detail-title" style="color:var(--gemini-blue);">Gemini AI Analysis</h3>
    <div id="detail-content" style="line-height:1.6;">AIËß£Êûê‰∏≠...</div>
</div>

<div id="settings-panel" class="side-panel">
    <h3>Expert Ë®≠ÂÆö</h3>
    <hr>
    <label>Gemini API Key</label>
    <input type="password" id="set-api-key" placeholder="AI Studio„ÅÆ„Ç≠„Éº„ÇíÂÖ•Âäõ">
    <label>„ÅÇ„Å™„Åü„ÅÆÂπ¥ÈΩ¢</label>
    <input type="number" id="set-user-age">
    <button class="btn-main" style="background:var(--gemini-blue);" onclick="window.saveSettings()">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
    <button onclick="window.toggleSettings()" style="width:100%; margin-top:15px; background:none; border:none; color:#666;">Êàª„Çã</button>
</div>

<div id="login-modal" class="modal">
    <h2 style="color:var(--line-green);">Chat-K Expert</h2>
    <p style="font-size:13px; color:#666;">ÁêÜÁ≥ªÂ∞ÇÈñÄÂÆ∂„ÉÅ„É£„ÉÉ„Éà„Å∏„Çà„ÅÜ„Åì„Åù</p>
    <input type="email" id="login-email" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ">
    <button class="btn-main" onclick="window.doLogin()">ÈñãÂßã„Åô„Çã</button>
</div>

<div class="footer">
    <textarea id="msg-input" rows="1" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."></textarea>
    <button onclick="window.sendMsg()" style="background:var(--gemini-blue); color:white; border:none; width:44px; height:44px; border-radius:50%;">‚û§</button>
</div>

<script type="module">
    // --- „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÁôªÈå≤ ---
    window.doLogin = () => {
        const email = document.getElementById('login-email').value;
        if(!email) return alert("„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        localStorage.setItem('chat_email', email);
        localStorage.setItem('chat_name', email.split('@')[0]);
        document.getElementById('login-modal').style.display = 'none';
        // ÂàùÂõûÂèÇÂä†„Ç¢„Éä„Ç¶„É≥„Çπ
        window.renderMessage("System", `${email.split('@')[0]}„Åï„Çì„ÅåÂèÇÂä†„Åó„Åæ„Åó„Åü`, false, true);
    };

    window.goHome = () => {
        if(confirm("„Éõ„Éº„É†Ôºà„É≠„Ç∞„Ç§„É≥ÁîªÈù¢Ôºâ„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü")) {
            location.reload();
        }
    };

    window.sendMsg = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim()) return;
        window.renderMessage(localStorage.getItem('chat_name'), inp.value, true);
        inp.value = "";
    };

    window.renderMessage = (name, text, isMe, isSystem = false) => {
        const area = document.getElementById('chat-area');
        if(isSystem) {
            const sys = document.createElement('div');
            sys.style = "align-self:center; background:rgba(0,0,0,0.1); padding:4px 10px; border-radius:10px; font-size:11px; color:white;";
            sys.innerText = text;
            area.appendChild(sys);
        } else {
            const wrap = document.createElement('div');
            wrap.className = `bubble-wrapper ${isMe ? 'me' : 'other'}`;
            wrap.innerHTML = `<div class="bubble">${text}</div><div class="ai-hint">üí° AIËß£Ë™¨„ÇíË°®Á§∫</div>`;
            wrap.onclick = () => window.openAIExplanation(text);
            area.appendChild(wrap);
        }
        area.scrollTop = area.scrollHeight;
    };

    window.openAIExplanation = async (text) => {
        const apiKey = localStorage.getItem('gemini_api_key');
        const age = localStorage.getItem('user_age') || "20";
        document.getElementById('detail-panel').classList.add('open');
        document.getElementById('detail-content').innerHTML = "Gemini„ÅåÊÄùËÄÉ‰∏≠...";

        if(!apiKey) {
            document.getElementById('detail-content').innerHTML = "‚ö†Ô∏è Âè≥‰∏ä„ÅÆ‚öôÔ∏è„Åã„ÇâGemini API Key„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
            return;
        }

        const prompt = `„ÅÇ„Å™„Åü„ÅØÁêÜÁ≥ªÂ∞ÇÈñÄÂÆ∂„Éú„ÉÉ„Éà„Åß„Åô„ÄÇ„É¶„Éº„Ç∂„ÉºÂπ¥ÈΩ¢${age}Ê≠≥„Å´Âêë„Åë„Å¶„ÄÅ„É°„ÉÉ„Çª„Éº„Ç∏„Äå${text}„ÄçÂÜÖ„ÅÆÂ∞ÇÈñÄÁî®Ë™û„ÇíÊäΩÂá∫„Åó„ÄÅLaTeXÊï∞Âºè„ÇíÁî®„ÅÑ„Å¶HTMLÂΩ¢Âºè„ÅßËß£Ë™¨„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await res.json();
            const result = data.candidates[0].content.parts[0].text;
            document.getElementById('detail-content').innerHTML = result;
            if(window.renderMathInElement) renderMathInElement(document.getElementById('detail-content'));
        } catch(e) {
            document.getElementById('detail-content').innerHTML = "ÈÄö‰ø°„Ç®„É©„Éº„Åß„Åô„ÄÇAPI„Ç≠„Éº„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
        }
    };

    window.toggleSettings = () => document.getElementById('settings-panel').classList.toggle('open');
    window.closeDetail = () => document.getElementById('detail-panel').classList.remove('open');
    
    window.saveSettings = () => {
        localStorage.setItem('gemini_api_key', document.getElementById('set-api-key').value);
        localStorage.setItem('user_age', document.getElementById('set-user-age').value);
        alert("Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ");
        window.toggleSettings();
    };

    // ÂàùÊúüÂåñ
    window.onload = () => {
        if(localStorage.getItem('chat_email')) {
            document.getElementById('login-modal').style.display = 'none';
        }
        document.getElementById('set-api-key').value = localStorage.getItem('gemini_api_key') || "";
        document.getElementById('set-user-age').value = localStorage.getItem('user_age') || "20";
    };
</script>
</body>
</html>
