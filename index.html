/* ä¿®æ­£ã®è‚ï¼šenterChaté–¢æ•°å†…ã§ãƒ›ã‚¹ãƒˆåˆ¤å®šã‚’å¸¸æ™‚ç›£è¦–ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸ */
async function enterChat(gid) {
    currentGid = gid;
    localStorage.setItem('last_gid', gid); 
    document.getElementById('main-modal').classList.remove('active');
    document.getElementById('head-title').innerText = gid;
    saveToHistory(gid);

    // å¸¸ã«æœ€æ–°ã®ã‚°ãƒ«ãƒ¼ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ç›£è¦–
    onValue(ref(db, `v7_groups/${gid}`), (snap) => {
        const data = snap.val();
        if(!data || !data.active) { 
            alert("ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ"); 
            removeFromHistory(gid);
            location.reload(); return; 
        }

        // é‡è¦ï¼šã“ã“ã§å†èª­ã¿è¾¼ã¿å¾Œã‚‚ã€Œè‡ªåˆ†ãŒãƒ›ã‚¹ãƒˆã‹ã€ã‚’æ¯å›ãƒã‚§ãƒƒã‚¯
        const isHost = (data.host === myId);
        
        // ãƒãƒ£ãƒƒãƒˆç”»é¢ã®æç”»
        const area = document.getElementById('chat-area'); area.innerHTML = "";
        if(data.messages) Object.entries(data.messages).forEach(([mid, d]) => {
            const wrap = document.createElement('div');
            wrap.className = `bubble-wrapper ${d.sender === myId ? 'me' : 'other'}`;
            wrap.innerHTML = `<div style="font-size:10px; margin:2px 5px; opacity:0.6">${d.senderName} ${d.sender === data.host ? 'ğŸ‘‘' : ''}</div>
                              <div class="bubble" onclick="window.askDeleteMessage('${mid}', '${d.sender}', ${isHost})">${d.text}</div>`;
            area.appendChild(wrap);
        });
        area.scrollTop = area.scrollHeight;

        // è¨­å®šç”»é¢ã‚’é–‹ããŸã‚ã®æº–å‚™ï¼ˆãƒ›ã‚¹ãƒˆãªã‚‰æ‰¿èªãƒªã‚¹ãƒˆãªã©ã‚’æ›´æ–°ï¼‰
        if(isHost) renderRequestList(data.requests);
    });
}
