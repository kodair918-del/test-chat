<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K | Next Gen AI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; --gemini-blue: #4285F4; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; overflow: hidden; position: fixed; width: 100%; background: var(--bg-blue); font-family: sans-serif; }
        body { display: flex; flex-direction: column; }
        header { background: var(--header-dark); color: white; display: flex; align-items: center; height: 50px; padding: 0 10px; flex-shrink: 0; z-index: 100; }
        header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        header .title { flex: 1; text-align: center; font-weight: bold; font-size: 16px; }
        .page { position: fixed; top: 50px; left: 0; width: 100%; height: calc(100% - 50px); background: #f8f9fa; z-index: 10; display: none; overflow-y: auto; padding: 20px; }
        .page.active { display: block; }
        #chat-page { background: var(--bg-blue); padding: 0; display: none; flex-direction: column; }
        #chat-page.active { display: flex; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 10px; }
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; }
        .me { align-self: flex-end; } .me .bubble { background: var(--line-green); color: white; }
        .ai-hint { font-size: 9px; color: white; margin-top: 2px; margin-left: 5px; font-weight: bold; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .panel { position: fixed; bottom: -100%; left: 0; width: 100%; height: 85%; background: white; z-index: 2000; transition: 0.4s; border-radius: 20px 20px 0 0; padding: 25px; overflow-y: auto; }
        .panel.open { bottom: 0; }
        .footer { background: white; padding: 10px; display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #ddd; }
        #msg-input { flex: 1; border: none; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; }
    </style>
</head>
<body>

<header>
    <button onclick="window.showPage('home-page')">ğŸ </button>
    <div class="title" id="header-title">Home</div>
    <button onclick="window.openPanel('settings-panel')">âš™ï¸</button>
</header>

<div id="login-page" class="page active" style="z-index: 3000;">
    <div style="text-align:center; padding-top:40px;">
        <h2 style="color:var(--line-green);">Chat-K Expert</h2>
        <input type="email" id="login-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd;">
        <button class="btn-main" onclick="window.doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
</div>

<div id="home-page" class="page">
    <h3>Researcher: <span id="user-name-disp"></span></h3>
    <div class="card">
        <h4>æ‰€å±ã‚°ãƒ«ãƒ¼ãƒ—</h4>
        <div id="group-list">
            <button class="btn-main" style="background:#fff; color:#333; border:1px solid #ddd;" onclick="window.enterChat('ç†ç³»æœ€å…ˆç«¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ')">ç†ç³»æœ€å…ˆç«¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ å…¥å®¤</button>
        </div>
    </div>
    <div class="card">
        <h4>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h4>
        <button class="btn-main" onclick="alert('æ–°ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆç”»é¢ï¼ˆé–‹ç™ºä¸­ï¼‰')">âœ¨ æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</button>
        <button class="btn-main" style="background:var(--header-dark);" onclick="window.openPanel('settings-panel')">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»APIè¨­å®š</button>
    </div>
</div>

<div id="chat-page" class="page">
    <div id="chat-area"></div>
    <div class="footer">
        <textarea id="msg-input" rows="1" placeholder="AIã«èããŸã„ç†ç³»ã®è©±ã‚’é€ä¿¡..."></textarea>
        <button onclick="window.sendMsg()" style="background:var(--gemini-blue); color:white; border:none; width:44px; height:44px; border-radius:50%;">â¤</button>
    </div>
</div>

<div id="ai-panel" class="panel">
    <button onclick="window.closePanel('ai-panel')" style="float:right; border:none; background:none; font-size:24px;">&times;</button>
    <h3 style="color:var(--gemini-blue);">AI Expert Insight</h3>
    <div id="ai-content" style="line-height:1.6; font-size:15px;"></div>
</div>

<div id="settings-panel" class="panel">
    <button onclick="window.closePanel('settings-panel')" style="float:right; border:none; background:none; font-size:24px;">&times;</button>
    <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</h3>
    <label>Gemini API Key (Google AI Studio)</label>
    <input type="password" id="set-api-key" placeholder="AIza..." style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
    <label>ã‚ãªãŸã®å¹´é½¢ (è§£èª¬ãƒ¬ãƒ™ãƒ«ã«å½±éŸ¿)</label>
    <input type="number" id="set-user-age" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
    <button class="btn-main" style="background:var(--gemini-blue);" onclick="window.saveSettings()">ä¿å­˜ã—ã¦åæ˜ </button>
</div>

<script>
    window.showPage = (id) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('header-title').innerText = (id === 'home-page' ? 'Home' : 'Research Chat');
    };

    window.openPanel = (id) => document.getElementById(id).classList.add('open');
    window.closePanel = (id) => document.getElementById(id).classList.remove('open');

    window.doLogin = () => {
        const email = document.getElementById('login-email').value;
        if(!email) return;
        localStorage.setItem('chat_email', email);
        document.getElementById('user-name-disp').innerText = email.split('@')[0];
        document.getElementById('login-page').style.display = 'none';
        window.showPage('home-page');
    };

    window.enterChat = (name) => {
        document.getElementById('header-title').innerText = name;
        window.showPage('chat-page');
    };

    window.sendMsg = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim()) return;
        const area = document.getElementById('chat-area');
        const wrap = document.createElement('div');
        wrap.className = "bubble-wrapper me";
        wrap.innerHTML = `<div class="bubble">${inp.value}</div><div class="ai-hint">ğŸ’¡ ã‚¯ãƒªãƒƒã‚¯ã—ã¦AIè§£èª¬</div>`;
        wrap.onclick = () => window.askGemini(inp.value);
        area.appendChild(wrap);
        area.scrollTop = area.scrollHeight;
        inp.value = "";
    };

    window.askGemini = async (text) => {
        const key = localStorage.getItem('gemini_api_key');
        const age = localStorage.getItem('user_age') || "20";
        const content = document.getElementById('ai-content');
        window.openPanel('ai-panel');
        content.innerHTML = `<div style="padding:20px; text-align:center;">AIãŒè§£æä¸­...</div>`;

        if(!key) { content.innerHTML = "âš™ï¸è¨­å®šã‹ã‚‰APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; return; }

        // ãƒ¢ãƒ‡ãƒ«åã‚’ã‚ˆã‚Šç¢ºå®Ÿãªã‚‚ã®ã«å¤‰æ›´
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `ã‚ãªãŸã¯ç†ç³»è¬›å¸«ã§ã™ã€‚${age}æ­³å‘ã‘ã«ã€Œ${text}ã€ã‚’æ—¥æœ¬èªã§åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¦ãã ã•ã„ã€‚å°‚é–€ç”¨èªã«ã¯å¿…ãšLaTeXï¼ˆ$è¨˜å·ï¼‰ã§æ•°å¼ã‚’æ·»ãˆã¦ãã ã•ã„ã€‚` }] }]
                })
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.error ? data.error.message : "æ¥ç¶šã‚¨ãƒ©ãƒ¼");

            const responseText = data.candidates[0].content.parts[0].text;
            content.innerHTML = responseText.replace(/\n/g, "<br>").replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
            
            if(window.renderMathInElement) {
                renderMathInElement(content, { delimiters: [{left: "$", right: "$", display: false}, {left: "$$", right: "$$", display: true}] });
            }
        } catch(e) {
            content.innerHTML = `<p style="color:red;">âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}<br><small>APIã‚­ãƒ¼ã¾ãŸã¯ãƒ¢ãƒ‡ãƒ«æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small></p>`;
        }
    };

    window.saveSettings = () => {
        localStorage.setItem('gemini_api_key', document.getElementById('set-api-key').value.trim());
        localStorage.setItem('user_age', document.getElementById('set-user-age').value);
        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        window.closePanel('settings-panel');
    };

    window.onload = () => {
        if(localStorage.getItem('chat_email')) {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('user-name-disp').innerText = localStorage.getItem('chat_email').split('@')[0];
            window.showPage('home-page');
        }
        document.getElementById('set-api-key').value = localStorage.getItem('gemini_api_key') || "";
        document.getElementById('set-user-age').value = localStorage.getItem('user_age') || "20";
    };
</script>
</body>
</html>
