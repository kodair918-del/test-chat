<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat-K (Group Mode)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; }
        body { background-color: var(--bg-blue); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* ログイン・設定画面 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; padding: 20px; box-sizing: border-box; display: none; overflow-y: auto; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        
        /* ヘッダー */
        header { background: #35495e; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        
        /* チャットエリア */
        #chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .bubble { max-width: 70%; padding: 8px 12px; border-radius: 15px; margin-bottom: 10px; position: relative; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .bubble.other { background: white; align-self: flex-start; border-top-left-radius: 0; }
        .bubble.me { background: var(--line-green); color: white; align-self: flex-end; border-top-right-radius: 0; }
        .bubble .info { font-size: 10px; color: #555; margin-bottom: 2px; }
        .bubble.me .info { color: #e0e0e0; text-align: right; }

        /* 入力エリア */
        .footer { background: #fff; padding: 10px; display: flex; gap: 10px; align-items: center; }
        .footer input { flex: 1; border: none; background: #f0f0f0; padding: 10px; border-radius: 20px; }
        .footer button { background: var(--line-green); color: white; border: none; padding: 10px 15px; border-radius: 50%; cursor: pointer; }

        /* QRコード */
        #qrcode-canvas { margin-top: 20px; text-align: center; }
        .btn { width: 100%; padding: 12px; background: var(--line-green); color: white; border: none; border-radius: 5px; font-weight: bold; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div id="display-group-name">グループ未設定</div>
    <button onclick="showSettings()" style="background:none; border:1px solid #fff; color:#fff; font-size:12px; border-radius:4px;">⚙ 設定</button>
</header>

<div id="chat-area"></div>

<div class="footer">
    <input type="text" id="msg-input" placeholder="メッセージを入力">
    <button onclick="sendMessage()">▶</button>
</div>

<div id="settings-modal" class="modal">
    <h2>⚙ グループ設定</h2>
    <div class="input-group">
        <label>表示名（自分の名前）</label>
        <input type="text" id="user-name" placeholder="例：タナカ">
    </div>
    <hr>
    <div class="input-group">
        <label>グループID (半角英数字)</label>
        <input type="text" id="group-id" placeholder="例：mygroup123">
    </div>
    <div class="input-group">
        <label>グループパスワード</label>
        <input type="password" id="group-pw" placeholder="パスワードを入力">
    </div>
    <button class="btn" onclick="saveSettings()">設定を保存して入室</button>
    
    <div id="qrcode-section" style="display:none; text-align:center; margin-top:30px;">
        <p style="font-size:12px; color:#666;">このQRコードを友達に共有してください</p>
        <div id="qrcode-canvas"></div>
    </div>
    <button class="btn" style="background:#888;" onclick="hideSettings()">閉じる</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com",
        projectId: "my-chat-1d626",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentRef = null;

    // 設定の読み込みと初期化
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const qid = urlParams.get('id');
        
        if (qid) document.getElementById('group-id').value = qid;
        
        const savedName = localStorage.getItem('chat_name');
        const savedGid = localStorage.getItem('chat_gid');
        const savedGpw = localStorage.getItem('chat_gpw');

        if (savedName && savedGid) {
            document.getElementById('user-name').value = savedName;
            document.getElementById('group-id').value = savedGid;
            document.getElementById('group-pw').value = savedGpw;
            startChat(savedGid, savedName);
        } else {
            showSettings();
        }
    };

    window.showSettings = () => {
        document.getElementById('settings-modal').style.display = 'block';
        updateQRCode();
    };

    window.hideSettings = () => {
        document.getElementById('settings-modal').style.display = 'none';
    };

    window.saveSettings = () => {
        const name = document.getElementById('user-name').value;
        const gid = document.getElementById('group-id').value;
        const gpw = document.getElementById('group-pw').value;

        if(!name || !gid) return alert("名前とグループIDを入力してください");
        
        localStorage.setItem('chat_name', name);
        localStorage.setItem('chat_gid', gid);
        localStorage.setItem('chat_gpw', gpw);
        
        location.reload(); // 再読み込みしてチャット開始
    };

    function startChat(gid, myName) {
        document.getElementById('display-group-name').innerText = "Group: " + gid;
        currentRef = ref(db, "groups/" + gid + "/messages");
        
        onChildAdded(currentRef, (snap) => {
            const data = snap.val();
            addBubble(data.name, data.text, data.name === myName);
        });
    }

    function addBubble(name, text, isMe) {
        const chatArea = document.getElementById('chat-area');
        const div = document.createElement('div');
        div.className = `bubble ${isMe ? 'me' : 'other'}`;
        div.innerHTML = `<div class="info">${name}</div><div>${text}</div>`;
        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    window.sendMessage = () => {
        const input = document.getElementById('msg-input');
        const name = localStorage.getItem('chat_name');
        if(!input.value || !currentRef) return;

        push(currentRef, {
            name: name,
            text: input.value,
            time: serverTimestamp()
        });
        input.value = "";
    };

    function updateQRCode() {
        const gid = document.getElementById('group-id').value;
        if(!gid) return;
        
        document.getElementById('qrcode-canvas').innerHTML = "";
        document.getElementById('qrcode-section').style.display = 'block';
        const joinUrl = window.location.origin + window.location.pathname + "?id=" + gid;
        
        new QRCode(document.getElementById("qrcode-canvas"), {
            text: joinUrl,
            width: 128,
            height: 128
        });
    }
</script>

</body>
</html>
