<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat-K Secure OTP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; }
        * { box-sizing: border-box; }
        body { background: var(--bg-blue); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: var(--header-dark); color: white; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; height: 55px; flex-shrink: 0; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 12px; }
        .footer { background: #fff; padding: 8px 10px; display: flex; gap: 8px; border-top: 1px solid #ddd; }
        #msg-input { flex: 1; border: none; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒ›ãƒ¼ãƒ  */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 25px; display: block; overflow-y: auto; text-align: center; }
        .input-group { text-align: left; margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .btn-sub { width: 100%; padding: 12px; background: #666; color: white; border: none; border-radius: 8px; margin-top: 10px; }
        
        /* å±¥æ­´ãƒªã‚¹ãƒˆ */
        .history-item { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .bubble-wrapper.me { align-self: flex-end; align-items: flex-end; }
        .bubble-wrapper.other { align-self: flex-start; align-items: flex-start; }
        .bubble { padding: 8px 12px; border-radius: 18px; font-size: 15px; background: white; border-top-left-radius: 2px; }
        .me .bubble { background: var(--line-green); color: white; border-top-left-radius: 18px; border-top-right-radius: 2px; }
    </style>
</head>
<body>

<header>
    <button onclick="goHome()" style="background:none; border:none; color:white; font-size:24px;">ğŸ </button>
    <div id="display-group-name">Chat-K</div>
    <div onclick="openConfig()" style="cursor:pointer; font-size: 24px;">âš™ï¸</div>
</header>

<div id="chat-area"></div>

<div class="footer">
    <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
    <button onclick="sendMessage()" style="background:var(--line-green); color:white; border:none; width:40px; height:40px; border-radius:50%;">â¤</button>
</div>

<div id="main-modal" class="modal">
    <h2 style="color:var(--line-green);">Chat-K</h2>
    
    <div id="step-email">
        <p>ã¾ãšã¯Gmailã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <div class="input-group"><input type="email" id="reg-email" placeholder="example@gmail.com"></div>
        <button class="btn-main" onclick="sendOTP()">10æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡</button>
    </div>

    <div id="step-otp" style="display:none;">
        <p>ãƒ¡ãƒ¼ãƒ«ã«å±Šã„ãŸ10æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <div class="input-group"><input type="text" id="reg-otp" placeholder="0000000000"></div>
        <button class="btn-main" onclick="verifyOTP()">èªè¨¼ã™ã‚‹</button>
    </div>

    <div id="step-name" style="display:none;">
        <p>ã‚ãªãŸã®ãŠåå‰ï¼ˆè¡¨ç¤ºåï¼‰ã‚’ç™»éŒ²ã—ã¾ã™</p>
        <div class="input-group"><input type="text" id="reg-name" placeholder="ãŠåå‰"></div>
        <button class="btn-main" onclick="saveAccount()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå®Œäº†</button>
    </div>

    <div id="step-home" style="display:none;">
        <p id="welcome-msg"></p>
        <div id="history-area">
            <h4>å‚åŠ ä¸­ã®ã‚°ãƒ«ãƒ¼ãƒ— (å±¥æ­´)</h4>
            <div id="history-list"></div>
        </div>
        <hr>
        <button class="btn-main" onclick="showGroupForm('create')">æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹</button>
        <button class="btn-sub" onclick="showGroupForm('join')">æ—¢å­˜ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚‹</button>
        
        <div id="group-form" style="display:none; margin-top:20px;">
            <div class="input-group"><label>ã‚°ãƒ«ãƒ¼ãƒ—å</label><input type="text" id="group-id"></div>
            <div class="input-group"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="group-pw"></div>
            <button class="btn-main" onclick="executeAction()">å®Ÿè¡Œ</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, serverTimestamp, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com",
        projectId: "my-chat-1d626",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = localStorage.getItem('chat_name');
    let myEmail = localStorage.getItem('chat_email');
    let currentGid = "";
    let tempOTP = "";

    window.onload = () => {
        if (myEmail && myName) showStep('home');
        else showStep('email');
    };

    // --- èªè¨¼ãƒ•ãƒ­ãƒ¼ ---
    window.sendOTP = () => {
        const email = document.getElementById('reg-email').value;
        if(!email.includes('@')) return alert("æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        tempOTP = Math.floor(Math.random() * 9000000000) + 1000000000;
        alert("ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘\n" + email + " å®›ã«èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ã‚Šã¾ã—ãŸã€‚\nã‚³ãƒ¼ãƒ‰: " + tempOTP);
        showStep('otp');
    };

    window.verifyOTP = () => {
        if(document.getElementById('reg-otp').value == tempOTP) showStep('name');
        else alert("ã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“");
    };

    window.saveAccount = () => {
        const n = document.getElementById('reg-name').value;
        if(!n) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        localStorage.setItem('chat_email', document.getElementById('reg-email').value);
        localStorage.setItem('chat_name', n);
        myName = n;
        showStep('home');
    };

    // --- ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»å±¥æ­´ãƒ•ãƒ­ãƒ¼ ---
    function showStep(s) {
        ['email','otp','name', 'home'].forEach(x => document.getElementById('step-'+x).style.display = 'none');
        document.getElementById('step-'+s).style.display = 'block';
        if(s === 'home') refreshHistory();
    }

    function refreshHistory() {
        document.getElementById('welcome-msg').innerText = "ã“ã‚“ã«ã¡ã¯ã€" + myName + " ã•ã‚“";
        const list = document.getElementById('history-list');
        list.innerHTML = "";
        const history = JSON.parse(localStorage.getItem('chat_history') || "[]");
        history.forEach(gid => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `<span><b>${gid}</b></span> <button onclick="quickJoin('${gid}')">å…¥å®¤</button>`;
            list.appendChild(item);
        });
    }

    window.showGroupForm = (m) => {
        window.groupMode = m;
        document.getElementById('group-form').style.display = 'block';
    };

    window.executeAction = async () => {
        const gid = document.getElementById('group-id').value.trim();
        const pw = btoa(document.getElementById('group-pw').value);
        if(!gid || !pw) return;

        const groupRef = ref(db, `v3_groups/${gid}`);
        const snap = await get(groupRef);

        if(window.groupMode === 'create') {
            if(snap.exists()) return alert("æ—¢ã«å­˜åœ¨ã—ã¾ã™");
            await set(groupRef, { pw: pw, host: myEmail });
            addToHistory(gid);
            startChat(gid);
        } else {
            if(!snap.exists() || snap.val().pw !== pw) return alert("èªè¨¼å¤±æ•—");
            addToHistory(gid);
            startChat(gid);
        }
    };

    function addToHistory(gid) {
        let history = JSON.parse(localStorage.getItem('chat_history') || "[]");
        if(!history.includes(gid)) history.push(gid);
        localStorage.setItem('chat_history', JSON.stringify(history));
    }

    window.quickJoin = (gid) => startChat(gid);

    // --- ãƒãƒ£ãƒƒãƒˆæœ¬ä½“ ---
    function startChat(gid) {
        currentGid = gid;
        document.getElementById('main-modal').style.display = 'none';
        document.getElementById('display-group-name').innerText = gid;
        document.getElementById('chat-area').innerHTML = "";
        onChildAdded(ref(db, `v3_groups/${gid}/messages`), (snap) => {
            const d = snap.val();
            const wrap = document.createElement('div');
            wrap.className = `bubble-wrapper ${d.name === myName ? 'me' : 'other'}`;
            wrap.innerHTML = `<div style="font-size:10px;padding:0 5px;">${d.name}</div><div class="bubble">${d.text}</div>`;
            document.getElementById('chat-area').appendChild(wrap);
            document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
        });
    }

    window.sendMessage = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim()) return;
        push(ref(db, `v3_groups/${currentGid}/messages`), { name: myName, text: inp.value });
        inp.value = "";
    };

    window.goHome = () => location.reload();
</script>
</body>
</html>
