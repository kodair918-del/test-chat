<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat-K Secure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; }
        * { box-sizing: border-box; }
        body { background: var(--bg-blue); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden; }
        
        header { background: var(--header-dark); color: white; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; height: 55px; flex-shrink: 0; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 12px; }
        .footer { background: #fff; padding: 8px 10px; display: flex; gap: 8px; border-top: 1px solid #ddd; }
        #msg-input { flex: 1; border: none; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; }
        
        /* å…±é€šãƒ¢ãƒ¼ãƒ€ãƒ«è¨­å®š */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 20px; display: block; overflow-y: auto; text-align: center; }
        .input-group { text-align: left; margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; color: #666; margin-bottom: 3px; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .btn-sub { width: 100%; padding: 12px; background: #666; color: white; border: none; border-radius: 8px; margin-top: 10px; }
        .btn-danger { width: 100%; padding: 10px; background: #ff4b4b; color: white; border: none; border-radius: 8px; margin-top: 20px; }

        /* æ‰¿èªãƒ‘ãƒãƒ«ï¼ˆãƒ›ã‚¹ãƒˆç”¨ï¼‰ */
        #admin-panel { background: #fffde7; border: 2px solid #fbc02d; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: none; text-align: left; }
        .req-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #ddd; }

        /* å¹ãå‡ºã— */
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .bubble-wrapper.me { align-self: flex-end; align-items: flex-end; }
        .bubble-wrapper.other { align-self: flex-start; align-items: flex-start; }
        .bubble { padding: 8px 12px; border-radius: 18px; font-size: 15px; background: white; border-top-left-radius: 2px; }
        .me .bubble { background: var(--line-green); color: white; border-top-left-radius: 18px; border-top-right-radius: 2px; }
    </style>
</head>
<body>

<header>
    <div style="width:30px;"></div> <div id="display-group-name">Chat-K</div>
    <div onclick="openConfig()" style="cursor:pointer; font-size: 24px;">âš™ï¸</div>
</header>

<div id="chat-area">
    <div id="admin-panel">
        <p style="font-size:12px; font-weight:bold; margin:0 0 5px 0;">ğŸ”” å…¥å®¤ç”³è«‹</p>
        <div id="request-list"></div>
    </div>
</div>

<div class="footer">
    <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
    <button onclick="sendMessage()" style="background:var(--line-green); color:white; border:none; width:40px; height:40px; border-radius:50%;">â¤</button>
</div>

<div id="home-screen" class="modal">
    <h2 style="color:var(--line-green);">Chat-K Secure</h2>
    <div class="input-group"><label>ã‚ãªãŸã®åå‰</label><input type="text" id="user-name" autocomplete="off"></div>
    <hr>
    <button class="btn-main" onclick="showForm('create')">æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹</button>
    <button class="btn-sub" onclick="showForm('join')">æ—¢å­˜ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚‹</button>
    
    <div id="group-form" style="display:none; margin-top:20px; border-top:1px solid #ddd; padding-top:20px;">
        <h3 id="form-title"></h3>
        <div class="input-group"><label>ã‚°ãƒ«ãƒ¼ãƒ—å</label><input type="text" id="group-id"></div>
        <div class="input-group"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="group-pw" autocomplete="new-password"></div>
        <button class="btn-main" id="exec-btn" onclick="executeGroupAction()">å®Ÿè¡Œ</button>
    </div>
</div>

<div id="wait-screen" class="modal" style="display:none;">
    <h3>â³ æ‰¿èªå¾…ã¡...</h3>
    <p>ãƒ›ã‚¹ãƒˆãŒè¨±å¯ã™ã‚‹ã¾ã§ã“ã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„ã€‚</p>
    <button class="btn-sub" onclick="location.reload()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<div id="config-modal" class="modal" style="display:none;">
    <h2>âš™ï¸ ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±</h2>
    <div style="text-align:left; background:#eee; padding:15px; border-radius:8px;">
        <p><b>ã‚°ãƒ«ãƒ¼ãƒ—å:</b> <span id="conf-gid"></span></p>
        <p><b>ã‚ãªãŸã®åå‰:</b> <span id="conf-name"></span></p>
    </div>
    
    <div id="qrcode-section" style="margin-top:20px;">
        <p style="font-size:12px; color:#666;">æ‹›å¾…ç”¨QRã‚³ãƒ¼ãƒ‰</p>
        <div id="qrcode-canvas" style="display:flex; justify-content:center; margin:10px 0;"></div>
    </div>

    <button class="btn-main" onclick="closeConfig()">é–‰ã˜ã‚‹</button>
    <button class="btn-danger" onclick="exitGroup()">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é€€å‡ºã™ã‚‹</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onValue, serverTimestamp, update, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com",
        projectId: "my-chat-1d626",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "", gid = "", mode = "";

    const hash = (str) => btoa(encodeURIComponent(str));

    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('id')) {
            showForm('join');
            document.getElementById('group-id').value = urlParams.get('id');
        }
    };

    window.showForm = (type) => {
        mode = type;
        document.getElementById('group-form').style.display = 'block';
        document.getElementById('form-title').innerText = type === 'create' ? "æ–°è¦ä½œæˆ" : "å…¥å®¤ç”³è«‹";
        document.getElementById('exec-btn').innerText = type === 'create' ? "ä½œæˆã—ã¦å…¥å®¤" : "ç”³è«‹ã‚’é€ã‚‹";
    };

    window.executeGroupAction = async () => {
        myName = document.getElementById('user-name').value.trim();
        gid = document.getElementById('group-id').value.trim();
        const pw = document.getElementById('group-pw').value.trim();
        if(!myName || !gid || !pw) return alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");

        const groupRef = ref(db, `secure_v2/${gid}`);
        const snap = await get(groupRef);

        if (mode === 'create') {
            if (snap.exists()) return alert("ãã®åå‰ã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™");
            await set(groupRef, { host: myName, pw: hash(pw) });
            localStorage.setItem('chat_role', 'host');
            enterChat();
        } else {
            if (!snap.exists()) return alert("ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã—ã¾ã›ã‚“");
            if (snap.val().pw !== hash(pw)) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
            await set(ref(db, `secure_v2/${gid}/requests/${myName}`), { status: "waiting" });
            localStorage.setItem('chat_role', 'guest');
            waitForApproval();
        }
    };

    function waitForApproval() {
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('wait-screen').style.display = 'block';
        onValue(ref(db, `secure_v2/${gid}/requests/${myName}`), (snap) => {
            if(snap.val()?.status === "approved") enterChat();
            else if(snap.val()?.status === "denied") { alert("æ‹’å¦ã•ã‚Œã¾ã—ãŸ"); location.reload(); }
        });
    }

    function enterChat() {
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('wait-screen').style.display = 'none';
        document.getElementById('display-group-name').innerText = gid;
        
        if(localStorage.getItem('chat_role') === 'host') {
            document.getElementById('admin-panel').style.display = 'block';
            onChildAdded(ref(db, `secure_v2/${gid}/requests`), (snap) => {
                if(snap.val().status === "waiting") {
                    const div = document.createElement('div');
                    div.className = "req-item";
                    div.id = `req-${snap.key}`;
                    div.innerHTML = `<span>${snap.key}</span><div><button onclick="authReq('${snap.key}',true)">è¨±å¯</button><button onclick="authReq('${snap.key}',false)">æ‹’å¦</button></div>`;
                    document.getElementById('request-list').appendChild(div);
                }
            });
        }

        onChildAdded(ref(db, `secure_v2/${gid}/messages`), (snap) => {
            const d = snap.val();
            const area = document.getElementById('chat-area');
            const wrap = document.createElement('div');
            wrap.className = `bubble-wrapper ${d.name === myName ? 'me' : 'other'}`;
            wrap.innerHTML = `<div style="font-size:10px;margin:0 5px;">${d.name}</div><div class="bubble">${d.text}</div>`;
            area.appendChild(wrap);
            area.scrollTop = area.scrollHeight;
        });
    }

    window.authReq = (u, ok) => {
        update(ref(db, `secure_v2/${gid}/requests/${u}`), { status: ok ? "approved" : "denied" });
        document.getElementById(`req-${u}`).remove();
    };

    window.sendMessage = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim()) return;
        push(ref(db, `secure_v2/${gid}/messages`), { name: myName, text: inp.value, time: serverTimestamp() });
        inp.value = "";
    };

    // --- è¨­å®šç”»é¢ã®å‡¦ç† ---
    window.openConfig = () => {
        if(!gid) return;
        document.getElementById('config-modal').style.display = 'block';
        document.getElementById('conf-gid').innerText = gid;
        document.getElementById('conf-name').innerText = myName;
        
        document.getElementById('qrcode-canvas').innerHTML = "";
        const url = window.location.origin + window.location.pathname + "?id=" + gid;
        new QRCode(document.getElementById("qrcode-canvas"), { text: url, width: 140, height: 140 });
    };

    window.closeConfig = () => document.getElementById('config-modal').style.display = 'none';
    window.exitGroup = () => { if(confirm("é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ")) location.reload(); };

</script>
</body>
</html>
