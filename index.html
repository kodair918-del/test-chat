<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Video Chat v2.0.3</title>
    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room@latest/dist/skyway_room.js"></script>
    
    <style>
        body { background-color: #7494c0; font-family: sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #version-tag { position: fixed; bottom: 5px; right: 10px; color: rgba(255,255,255,0.5); font-size: 10px; z-index: 1000; }
        #home-screen { padding: 20px; text-align: center; color: white; }
        .group-card { background: white; color: #333; padding: 15px; border-radius: 10px; margin: 10px auto; width: 80%; max-width: 300px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;}
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
        .login-box { background: white; padding: 25px; border-radius: 10px; text-align: center; width: 80%; max-width: 300px; }
        .login-box input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; }
        #chat-container { display: none; flex-direction: column; height: 100vh; }
        #chat-header { background: #557094; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        #video-area { display: none; background: #000; height: 180px; gap: 2px; padding: 2px; }
        video { flex: 1; height: 100%; background: #222; border-radius: 5px; object-fit: cover; }
        #chat-screen { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .balloon { padding: 8px 15px; border-radius: 18px; background: white; margin-bottom: 10px; max-width: 80%; color: #333; font-size: 14px; }
        .right { align-self: flex-end; background-color: #8de055; }
        .input-area { background: #fff; padding: 10px; display: flex; gap: 5px; }
    </style>
</head>
<body>

<div id="version-tag">Ver 2.0.3 (Final Fix)</div>

<div id="home-screen">
    <h2>ãƒã‚¤ã‚°ãƒ«ãƒ¼ãƒ—</h2>
    <div id="group-list"></div>
    <button onclick="document.getElementById('login-screen').style.display='flex'" style="padding:15px 30px; background:#28a745; color:white; border:none; border-radius:10px; font-size:16px; font-weight:bold; cursor:pointer;">ï¼‹ æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ </button>
</div>

<div id="login-screen">
    <div class="login-box">
        <h3>ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š</h3>
        <input type="text" id="group-id" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å">
        <input type="text" id="group-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <input type="text" id="user-id" placeholder="ã‚ãªãŸã®åå‰">
        <div style="margin-top:15px;">
            <button onclick="window.enterGroup(true)" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:5px;">ä¿å­˜ã—ã¦å…¥å®¤</button>
            <button onclick="document.getElementById('login-screen').style.display='none'" style="padding:10px 20px; background:#666; color:white; border:none; border-radius:5px; margin-left:5px;">æˆ»ã‚‹</button>
        </div>
    </div>
</div>

<div id="chat-container">
    <div id="chat-header">
        <button onclick="location.reload()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">ğŸ </button>
        <span id="display-group-name" style="font-weight:bold;"></span>
        <button id="call-btn" style="background:#28a745; color:white; border:none; border-radius:20px; padding:8px 15px; cursor:pointer;">ğŸ“é€šè©±é–‹å§‹</button>
    </div>
    <div id="video-area">
        <video id="local-video" autoplay playsinline muted></video>
        <div id="remote-videos" style="display:contents;"></div>
    </div>
    <div id="chat-screen"></div>
    <div class="input-area">
        <input type="text" id="input-message" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
        <button id="send-btn" style="background:#007bff; color:white; border:none; border-radius:20px; padding:10px 20px; cursor:pointer;">é€ä¿¡</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        projectId: "my-chat-1d626",
        storageBucket: "my-chat-1d626.firebasestorage.app",
        messagingSenderId: "769979957640",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const skywayKey = "d692a6e7-021b-4698-9dd4-d7fdeefc6f5e"; 

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName, chatRef;

    window.onload = () => {
        const list = document.getElementById('group-list');
        const groups = JSON.parse(localStorage.getItem('myGroups') || "[]");
        list.innerHTML = "";
        groups.forEach(g => {
            const div = document.createElement('div');
            div.className = 'group-card';
            div.innerHTML = `<span>${g.id}</span><button style="border:none; background:#007bff; color:white; border-radius:5px; padding:5px 10px;">å…¥å®¤</button>`;
            div.onclick = () => {
                const user = prompt("ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                if(user) startChat(g.id, g.pass, user);
            };
            list.appendChild(div);
        });
    };

    window.enterGroup = (save) => {
        const id = document.getElementById('group-id').value;
        const pass = document.getElementById('group-pass').value;
        const user = document.getElementById('user-id').value;
        if(!id || !pass || !user) return alert("å…¨éƒ¨å…¥åŠ›ã—ã¦ã­ï¼");

        if(save) {
            let gs = JSON.parse(localStorage.getItem('myGroups') || "[]");
            if(!gs.find(g => g.id === id)) {
                gs.push({id, pass});
                localStorage.setItem('myGroups', JSON.stringify(gs));
            }
        }
        startChat(id, pass, user);
    };

    async function startChat(id, pass, user) {
        myName = user;
        chatRef = ref(db, `rooms/${id}_${pass}/messages`);
        document.getElementById('display-group-name').innerText = id;
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('chat-container').style.display = 'flex';

        onChildAdded(chatRef, (d) => {
            const m = d.val();
            const div = document.createElement('div');
            div.className = `balloon ${m.name === myName ? 'right' : ''}`;
            div.innerText = `${m.name}: ${m.text}`;
            document.getElementById('chat-screen').appendChild(div);
            document.getElementById('chat-screen').scrollTop = document.getElementById('chat-screen').scrollHeight;
        });

        document.getElementById('call-btn').onclick = async () => {
            if (typeof SkyWay === 'undefined') return alert("é€šä¿¡æº–å‚™ä¸­...5ç§’å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦ã­");
            document.getElementById('video-area').style.display = 'flex';
            try {
                const { SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = SkyWay;
                const context = await SkyWayContext.Create(skywayKey);
                const room = await SkyWayRoom.FindOrCreate(context, { type: 'p2p', name: id + pass });
                const member = await room.join();
                
                const { audio, video } = await SkyWayStreamFactory.createMicrophoneAudioAndCameraVideoStreams();
                document.getElementById('local-video').srcObject = video.track;
                await member.publish(audio);
                await member.publish(video);

                room.onStreamPublished.add(async (e) => {
                    if (e.publication.publisher.id === member.id) return;
                    const { stream } = await member.subscribe(e.publication.id);
                    if (stream.contentType === 'video') {
                        const remoteV = document.createElement('video');
                        remoteV.autoplay = true; remoteV.playsinline = true;
                        remoteV.srcObject = stream.track;
                        document.getElementById('remote-videos').appendChild(remoteV);
                    }
                });
            } catch (err) {
                console.error(err);
                alert("é€šè©±ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã®è¨±å¯ã‚’ç¢ºèªã—ã¦ã­ï¼");
            }
        };
    }

    document.getElementById('send-btn').onclick = () => {
        const i = document.getElementById('input-message');
        if(i.value && chatRef) {
            push(chatRef, { name: myName, text: i.value, time: serverTimestamp() });
            i.value = "";
        }
    };
</script>
</body>
</html>
