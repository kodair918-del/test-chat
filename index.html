<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K Debug | Ver 0.1.6.3d</title>
    <style>
        :root {
            --accent: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF; --text: #000000;
            --border: rgba(0,0,0,0.1); --danger: #FF3B30; --success: #34C759;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; padding: 20px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; font-size: 18px; border-bottom: 2px solid var(--accent); padding-bottom: 8px; }
        .std-input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid var(--border); box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; height: 48px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 10px; color: white; transition: 0.2s; }
        .btn-main { background: var(--accent); }
        .btn-sub { background: #8E8E93; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .u-info { font-size: 14px; background: #eee; padding: 10px; border-radius: 8px; margin-bottom: 15px; word-break: break-all; }
        .req-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 8px; margin-bottom: 8px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ‘¤ è‡ªåˆ†ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h2>
        <div class="u-info" id="my-debug-info">èª­ã¿è¾¼ã¿ä¸­...</div>
        <input type="text" id="set-name" class="std-input" placeholder="è¡¨ç¤ºåï¼ˆåå‰ï¼‰">
        <button class="btn btn-main" onclick="window.updateProfile()">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜</button>
    </div>

    <div class="card">
        <h2>â• ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã‚’é€ã‚‹</h2>
        <input type="text" id="target-id" class="std-input" placeholder="ç›¸æ‰‹ã®ID (@ä»¥é™)">
        <button class="btn btn-success" onclick="window.sendFriendRequest()">ç”³è«‹ã‚’é€ä¿¡</button>
    </div>

    <div class="card">
        <h2>ğŸ“¬ å±Šã„ã¦ã„ã‚‹ç”³è«‹</h2>
        <div id="request-list">ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</div>
    </div>

    <div class="card">
        <h2>ğŸ‘¥ ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§</h2>
        <div id="friend-list">ãƒ•ãƒ¬ãƒ³ãƒ‰ã¯ã„ã¾ã›ã‚“</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const config = { apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo", databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com", projectId: "my-chat-1d626" };
        const app = initializeApp(config); const db = getDatabase(app);

        const myId = localStorage.getItem('chat_uid');
        let myName = localStorage.getItem('chat_name') || "ã‚²ã‚¹ãƒˆ";

        // 1. åˆæœŸåŒ–ã¨ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
        window.onload = () => {
            if(!myId) {
                alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            document.getElementById('my-debug-info').innerText = `ID: ${myId}\nName: ${myName}`;
            document.getElementById('set-name').value = myName;
            startMonitoring();
        };

        // 2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
        window.updateProfile = async () => {
            const newName = document.getElementById('set-name').value;
            if(!newName) return;
            await update(ref(db, `v20_users/${myId}`), { name: newName });
            localStorage.setItem('chat_name', newName);
            myName = newName;
            alert("ä¿å­˜ã—ã¾ã—ãŸ");
            location.reload();
        };

        // 3. ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹é€ä¿¡
        window.sendFriendRequest = async () => {
            const tid = document.getElementById('target-id').value.trim();
            if(!tid || tid === myId) {
                alert("æœ‰åŠ¹ãªç›¸æ‰‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            const targetRef = ref(db, `v20_users/${tid}`);
            const snap = await get(targetRef);
            if(!snap.exists()) {
                alert("æŒ‡å®šã•ã‚ŒãŸIDã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return;
            }

            await set(ref(db, `v20_users/${tid}/friendRequests/${myId}`), {
                senderName: myName,
                timestamp: Date.now()
            });
            alert("ç”³è«‹ã‚’é€ã‚Šã¾ã—ãŸã€‚");
            document.getElementById('target-id').value = "";
        };

        // 4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆç”³è«‹ & ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆï¼‰
        function startMonitoring() {
            // ç”³è«‹ã®ç›£è¦–
            onValue(ref(db, `v20_users/${myId}/friendRequests`), snap => {
                const list = document.getElementById('request-list');
                list.innerHTML = "";
                if(snap.exists()) {
                    Object.keys(snap.val()).forEach(rid => {
                        const data = snap.val()[rid];
                        const div = document.createElement('div');
                        div.className = "req-item";
                        div.innerHTML = `
                            <span><b>${data.senderName}</b> (@${rid})</span>
                            <div>
                                <button class="btn btn-success" style="width:60px; height:34px; margin:0;" onclick="window.answerRequest('${rid}', '${data.senderName}', true)">æ‰¿èª</button>
                                <button class="btn btn-danger" style="width:60px; height:34px; margin:0;" onclick="window.answerRequest('${rid}', '', false)">æ‹’å¦</button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                } else {
                    list.innerText = "ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“";
                }
            });

            // ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã®ç›£è¦–
            onValue(ref(db, `v20_users/${myId}/friends`), async snap => {
                const list = document.getElementById('friend-list');
                list.innerHTML = "";
                if(snap.exists()) {
                    for(let fid of Object.keys(snap.val())) {
                        const info = await get(ref(db, `v20_users/${fid}`));
                        const name = info.exists() ? info.val().name : fid;
                        const div = document.createElement('div');
                        div.className = "req-item";
                        div.innerHTML = `<span>ğŸ‘¤ ${name} (@${fid})</span>`;
                        list.appendChild(div);
                    }
                } else {
                    list.innerText = "ãƒ•ãƒ¬ãƒ³ãƒ‰ã¯ã„ã¾ã›ã‚“";
                }
            });
        }

        // 5. ç”³è«‹ã¸ã®å›ç­”
        window.answerRequest = async (rid, rname, isApprove) => {
            if(isApprove) {
                // ãŠäº’ã„ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã«è¿½åŠ 
                await update(ref(db, `v20_users/${myId}/friends`), { [rid]: true });
                await update(ref(db, `v20_users/${rid}/friends`), { [myId]: true });
                alert(`${rname}ã•ã‚“ã¨ãƒ•ãƒ¬ãƒ³ãƒ‰ã«ãªã‚Šã¾ã—ãŸï¼`);
            }
            // ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            await remove(ref(db, `v20_users/${myId}/friendRequests/${rid}`));
        };

    </script>
</body>
</html>
