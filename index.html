<!DOCTYPE html>

<html lang="ja">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>Chat-K | Ver 22.0</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>

        :root { --accent: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF; --text: #000000; --header-bg: rgba(255, 255, 255, 0.85); --bubble-me: #007AFF; --bubble-other: #E9E9EB; }

        body.dark-mode { --bg: #1C1C1E; --card-bg: #2C2C2E; --text: #FFFFFF; --header-bg: rgba(28, 30, 32, 0.85); --bubble-me: #0A84FF; --bubble-other: #3A3A3C; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }

        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; background: var(--bg); color: var(--text); }

        header { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background: var(--header-bg); height: 60px; display: flex; align-items: center; padding: env(safe-area-inset-top) 15px 0; z-index: 2000; border-bottom: 0.5px solid rgba(0,0,0,0.1); }

        header button { background: none; border: none; font-size: 22px; color: inherit; padding: 10px; cursor: pointer; }

        .title { flex: 1; text-align: center; font-weight: 600; font-size: 17px; }

        #chat-area { flex: 1; overflow-y: auto; padding: 20px 15px 120px; display: flex; flex-direction: column; gap: 12px; height: calc(100% - 60px); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 5000; padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom); display: none; overflow-y: auto; }

        .modal.active { display: block; }

        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .input-box { width: 100%; height: 50px; padding: 0 15px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); background: var(--card-bg); color: var(--text); margin-bottom: 15px; font-size: 16px; outline: none; }

        .btn-main { width: 100%; height: 50px; background: var(--accent); color: white; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }

        .btn-danger { background: #FF3B30 !important; }

        .btn-gray { background: #8E8E93 !important; }

    </style>

</head>

<body>



<header>

    <button onclick="window.goHome()">ğŸ </button>

    <div class="title" id="head-title">Chat-K</div>

    <button onclick="window.triggerOpenSettings()">âš™ï¸</button>

</header>



<div id="chat-area"></div>



<div id="set-modal" class="modal">

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">

        <h2>âš™ï¸ è¨­å®š / ç·¨é›†</h2>

        <button onclick="window.closeModal('set-modal')" style="font-size:28px;">Ã—</button>

    </div>



    <div class="card">

        <h3>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h3>

        <p style="font-size:12px; opacity:0.6;">å¤‰æ›´ã—ã¦ä¿å­˜ã‚’æŠ¼ã™ã¨å³åº§ã«åæ˜ ã•ã‚Œã¾ã™</p>

        <input type="text" id="edit-name" class="input-box" placeholder="åå‰">

        <input type="text" id="edit-uid" class="input-box" placeholder="ID">

        <input type="text" id="edit-pw" class="input-box" placeholder="PASS">

        <button class="btn-main" onclick="window.saveUserProfile()">ä¿å­˜ã—ã¦æ›´æ–°</button>

    </div>



    <div id="project-settings" style="display:none;">

        <div class="card">

            <h3>ğŸ¢ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†</h3>

            <p id="set-group-name"></p>

            <div id="qrcode-container" style="display:flex; justify-content:center; background:white; padding:15px; border-radius:12px;"></div>

            <button class="btn-main btn-danger" style="margin-top:15px;" onclick="window.deleteGroup()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤</button>

        </div>

    </div>



    <button class="btn-main btn-gray" onclick="document.body.classList.toggle('dark-mode')">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>

    <button class="btn-main btn-danger" onclick="localStorage.clear(); location.reload();">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

</div>



<div id="home-modal" class="modal">

    <div style="text-align:center; padding-top:20px;">

        <div class="card" onclick="window.triggerOpenSettings()" style="cursor:pointer; text-align:left; border: 2.5px solid var(--accent); background:rgba(0,122,255,0.05);">

            <div style="font-size:11px; color:var(--accent); font-weight:bold; margin-bottom:5px;">USER PROFILE (ã‚¿ãƒƒãƒ—ã—ã¦ç·¨é›†)</div>

            <b>Name:</b> <span id="display-name"></span><br>

            <b>ID:</b> <span id="display-uid"></span>

        </div>

        

        <div id="history-list"></div>

        <button onclick="window.showGroupForm('create')" class="btn-main" style="background:#34C759;">ï¼‹ æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</button>

        <button onclick="window.showGroupForm('join')" class="btn-main btn-gray">IDå…¥åŠ›ã§å…¥å®¤</button>

        

        <div id="group-form" style="display:none;" class="card">

            <input type="text" id="g-id" placeholder="Project ID" class="input-box">

            <input type="password" id="g-pw" placeholder="Password" class="input-box">

            <button class="btn-main" onclick="window.groupAction()">æ±ºå®š</button>

        </div>

    </div>

</div>



<div id="auth-modal" class="modal">

    <div style="text-align:center; padding-top:40px;">

        <h1 style="font-size:38px; margin-bottom:30px;">ğŸ§ª Chat-K</h1>

        <div class="card">

            <input type="text" id="a-uid" class="input-box" placeholder="ID">

            <input type="text" id="a-name" class="input-box" placeholder="åå‰(æ–°è¦æ™‚)">

            <input type="password" id="a-pw" class="input-box" placeholder="PASS">

            <button class="btn-main" onclick="window.handleAuth('login')">ãƒ­ã‚°ã‚¤ãƒ³</button>

            <button class="btn-main btn-gray" onclick="window.handleAuth('reg')">æ–°è¦ç™»éŒ²</button>

        </div>

    </div>

</div>



<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

    import { getDatabase, ref, set, get, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";



    const config = { apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo", databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com" };

    const app = initializeApp(config);

    const db = getDatabase(app);



    // å†…éƒ¨å¤‰æ•°ï¼ˆã“ã‚Œã‚’å¸¸ã«æœ€æ–°ã«ã™ã‚‹ï¼‰

    let my = {

        id: localStorage.getItem('chat_uid'),

        name: localStorage.getItem('chat_name'),

        pw: localStorage.getItem('chat_raw_pw')

    };

    let currentGid = "";



    // UIæ›´æ–°é–¢æ•°ï¼ˆä¸€ç®‡æ‰€ã«ã¾ã¨ã‚ãŸï¼‰

    function updateUI() {

        document.getElementById('display-name').innerText = my.name || "---";

        document.getElementById('display-uid').innerText = "@" + (my.id || "---");

        document.getElementById('edit-name').value = my.name || "";

        document.getElementById('edit-uid').value = my.id || "";

        document.getElementById('edit-pw').value = my.pw || "";

    }



    window.triggerOpenSettings = () => {

        updateUI();

        const projArea = document.getElementById('project-settings');

        if(currentGid) {

            projArea.style.display = 'block';

            document.getElementById('set-group-name').innerText = "Project: " + currentGid;

            const qrc = document.getElementById('qrcode-container');

            qrc.innerHTML = "";

            new QRCode(qrc, {text: currentGid, width:128, height:128});

        } else {

            projArea.style.display = 'none';

        }

        document.getElementById('set-modal').classList.add('active');

    };



    window.saveUserProfile = async () => {

        const nid = document.getElementById('edit-uid').value.trim();

        const nnm = document.getElementById('edit-name').value.trim();

        const npw = document.getElementById('edit-pw').value.trim();

        if(!nid || !nnm || !npw) return alert("ç©ºæ¬„ä¸å¯");



        // IDå¤‰æ›´ãŒã‚ã‚‹å ´åˆ

        if(nid !== my.id) {

            const check = await get(ref(db, `v10_users/${nid}`));

            if(check.exists()) return alert("ãã®IDã¯ä½¿ç”¨ä¸­ã§ã™");

            await remove(ref(db, `v10_users/${my.id}`));

        }



        // Firebaseä¿å­˜

        await set(ref(db, `v10_users/${nid}`), { name: nnm, pw: npw });



        // å†…éƒ¨å¤‰æ•°ã¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’å³æ™‚æ›´æ–°

        my = { id: nid, name: nnm, pw: npw };

        localStorage.setItem('chat_uid', nid);

        localStorage.setItem('chat_name', nnm);

        localStorage.setItem('chat_raw_pw', npw);



        alert("ãƒ—ãƒ­ãƒ•æ›´æ–°å®Œäº†");

        updateUI();

        window.closeModal('set-modal');

        renderHome();

    };



    window.handleAuth = async (mode) => {

        const uid = document.getElementById('a-uid').value.trim();

        const pw = document.getElementById('a-pw').value;

        const name = document.getElementById('a-name').value.trim();

        if(mode === 'reg') {

            await set(ref(db, `v10_users/${uid}`), { name, pw });

            finishLogin(uid, name, pw);

        } else {

            const s = await get(ref(db, `v10_users/${uid}`));

            if(s.exists() && s.val().pw === pw) finishLogin(uid, s.val().name, pw);

            else alert("IDã¾ãŸã¯PASSãŒé•ã„ã¾ã™");

        }

    };



    function finishLogin(id, nm, pw) {

        localStorage.setItem('chat_uid', id);

        localStorage.setItem('chat_name', nm);

        localStorage.setItem('chat_raw_pw', pw);

        location.reload();

    }



    function renderHome() {

        updateUI();

        document.getElementById('home-modal').classList.add('active');

        const list = document.getElementById('history-list'); list.innerHTML = "";

        JSON.parse(localStorage.getItem('chat_history') || "[]").forEach(g => {

            const d = document.createElement('div'); d.className = "card"; d.innerText = g;

            d.onclick = () => enterChat(g); list.appendChild(d);

        });

    }



    function enterChat(gid) {

        currentGid = gid;

        document.getElementById('home-modal').classList.remove('active');

        document.getElementById('head-title').innerText = gid;

        onValue(ref(db, `v10_groups/${gid}/messages`), (s) => {

            const area = document.getElementById('chat-area'); area.innerHTML = "";

            if(s.exists()) Object.values(s.val()).forEach(m => {

                const w = document.createElement('div');

                w.innerHTML = `<b>${m.sender}</b>: ${m.text}`;

                area.appendChild(w);

            });

            area.scrollTop = area.scrollHeight;

        });

        let h = JSON.parse(localStorage.getItem('chat_history') || "[]"); if(!h.includes(gid)) h.push(gid); localStorage.setItem('chat_history', JSON.stringify(h));

    }



    window.groupAction = async () => {

        const gid = document.getElementById('g-id').value;

        const gpw = document.getElementById('g-pw').value;

        if(window.gMode === 'create') {

            await set(ref(db, `v10_groups/${gid}`), { host: my.id, pw: gpw, members: {[my.id]: true} });

            enterChat(gid);

        } else {

            const s = await get(ref(db, `v10_groups/${gid}`));

            if(s.exists() && s.val().pw === gpw) enterChat(gid); else alert("æ‹’å¦ã•ã‚Œã¾ã—ãŸ");

        }

    };



    window.goHome = () => { currentGid = ""; document.getElementById('head-title').innerText = "Chat-K"; renderHome(); };

    window.closeModal = (id) => document.getElementById(id).classList.remove('active');

    window.showGroupForm = (m) => { window.gMode = m; document.getElementById('group-form').style.display = 'block'; };



    if(!my.id) document.getElementById('auth-modal').classList.add('active'); else renderHome();

</script>

</body>

</html>
