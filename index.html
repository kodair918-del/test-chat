<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K | Diagnostic Mode</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; --gemini-blue: #4285F4; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: sans-serif; background: var(--bg-blue); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: var(--header-dark); color: white; height: 50px; display: flex; align-items: center; padding: 0 15px; flex-shrink: 0; }
        header .title { flex: 1; text-align: center; font-weight: bold; }
        .page { flex: 1; overflow-y: auto; background: #f8f9fa; display: none; padding: 20px; }
        .page.active { display: block; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: var(--bg-blue); }
        .bubble { padding: 12px 16px; border-radius: 18px; background: white; max-width: 85%; cursor: pointer; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .me { align-self: flex-end; background: var(--line-green); color: white; }
        .panel { position: fixed; bottom: -100%; left: 0; width: 100%; height: 85%; background: white; z-index: 2000; transition: 0.4s; border-radius: 20px 20px 0 0; padding: 25px; overflow-y: auto; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); }
        .panel.open { bottom: 0; }
        .footer { background: white; padding: 10px; display: flex; gap: 8px; border-top: 1px solid #ddd; }
        textarea { flex: 1; border: none; background: #f0f2f5; padding: 10px; border-radius: 20px; resize: none; outline: none; }
        .btn { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .btn-send { background: var(--gemini-blue); color: white; border-radius: 50%; width: 44px; height: 44px; }
        .debug-log { background: #333; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 5px; margin-top: 10px; overflow-x: auto; }
    </style>
</head>
<body>

<header>
    <button onclick="location.reload()" style="background:none; border:none; color:white; font-size:18px;">ğŸ </button>
    <div class="title">Chat-K AI Expert</div>
    <button onclick="document.getElementById('set-panel').classList.add('open')" style="background:none; border:none; color:white; font-size:18px;">âš™ï¸</button>
</header>

<div id="chat-page" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
    <div id="chat-area"></div>
    <div class="footer">
        <textarea id="msg-input" rows="1" placeholder="ç†ç³»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹..."></textarea>
        <button onclick="sendMsg()" class="btn-send">â¤</button>
    </div>
</div>

<div id="ai-panel" class="panel">
    <button onclick="this.parentElement.classList.remove('open')" style="float:right; border:none; background:none; font-size:24px;">&times;</button>
    <h3 id="ai-status">AIè§£æ</h3>
    <div id="ai-content"></div>
    <div id="debug-area" style="display:none;">
        <p style="font-weight:bold; color:red; margin-top:20px;">Developer Debug Trace:</p>
        <div id="debug-log" class="debug-log"></div>
    </div>
</div>

<div id="set-panel" class="panel">
    <h3>è¨­å®š</h3>
    <label>Gemini API Key</label>
    <input type="password" id="api-key-input" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
    <button class="btn" style="background:var(--gemini-blue); color:white; width:100%;" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
    <p style="font-size:12px; color:#666; margin-top:10px;">â€»ä¿å­˜å¾Œã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨AIãŒå‹•ãã¾ã™ã€‚</p>
</div>

<script>
    // è¨­å®šã®èª­ã¿è¾¼ã¿
    window.onload = () => {
        document.getElementById('api-key-input').value = localStorage.getItem('gemini_api_key') || "";
    };

    function saveSettings() {
        localStorage.setItem('gemini_api_key', document.getElementById('api-key-input').value.trim());
        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        document.getElementById('set-panel').classList.remove('open');
    }

    function sendMsg() {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim()) return;
        const area = document.getElementById('chat-area');
        const div = document.createElement('div');
        div.className = "bubble me";
        div.innerText = inp.value;
        div.onclick = () => askGemini(inp.value);
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
        inp.value = "";
    }

    async function askGemini(text) {
        const key = localStorage.getItem('gemini_api_key');
        const panel = document.getElementById('ai-panel');
        const content = document.getElementById('ai-content');
        const debugArea = document.getElementById('debug-area');
        const debugLog = document.getElementById('debug-log');
        
        panel.classList.add('open');
        content.innerHTML = "æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...";
        debugArea.style.display = "none";

        if(!key) { content.innerHTML = "âš™ï¸è¨­å®šã‹ã‚‰APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; return; }

        // è©¦è¡Œã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ãƒ¢ãƒ‡ãƒ«ã®çµ„ã¿åˆã‚ã›
        const attempts = [
            { ver: "v1beta", model: "gemini-1.5-flash" },
            { ver: "v1", model: "gemini-1.5-flash" },
            { ver: "v1beta", model: "gemini-1.5-flash-latest" },
            { ver: "v1", model: "gemini-1.5-flash-001" }
        ];

        let success = false;
        let lastError = "";

        for(let config of attempts) {
            content.innerHTML = `è©¦è¡Œä¸­: ${config.ver} / ${config.model}...`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/${config.ver}/models/${config.model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `ç†ç³»è¬›å¸«ã¨ã—ã¦ã€Œ${text}ã€ã‚’æ—¥æœ¬èªã§è§£èª¬ã—ã¦ã€‚æ•°å¼ã¯$ã§ã€‚` }] }] })
                });

                const data = await res.json();
                
                if(res.ok) {
                    content.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, "<br>");
                    if(window.renderMathInElement) renderMathInElement(content);
                    success = true;
                    break;
                } else {
                    lastError += `[${config.ver}/${config.model}] Error: ${data.error.message}\n`;
                }
            } catch(e) {
                lastError += `[${config.ver}/${config.model}] Network Error: ${e.message}\n`;
            }
        }

        if(!success) {
            content.innerHTML = "âŒ å…¨ã¦ã®ãƒ¢ãƒ‡ãƒ«è©¦è¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¸‹ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            debugArea.style.display = "block";
            debugLog.innerText = lastError;
        }
    }
</script>
</body>
</html>
