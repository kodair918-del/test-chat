<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K | Science Edition</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; width: 100%; background: var(--bg-blue); font-family: sans-serif; }
        body { display: flex; flex-direction: column; }
        header { background: var(--header-dark); color: white; display: flex; align-items: center; height: 50px; padding: 0 10px; padding-top: env(safe-area-inset-top); flex-shrink: 0; z-index: 100; }
        header .title { flex: 1; text-align: center; font-weight: bold; font-size: 16px; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 14px; }
        .footer { background: #ffffff; padding: 8px 10px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #ddd; }
        #msg-input { flex: 1; border: none; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; max-height: 100px; resize: none; }
        
        /* „Ç∑„Çπ„ÉÜ„É†„É°„ÉÉ„Çª„Éº„Ç∏ */
        .system-msg { align-self: center; background: rgba(0,0,0,0.15); color: white; font-size: 11px; padding: 4px 12px; border-radius: 12px; margin: 5px 0; }
        
        /* Âêπ„ÅçÂá∫„Åó */
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1.5; }
        .sender-name { font-size: 11px; color: #555; margin-bottom: 3px; margin-left: 5px; font-weight: bold; }
        .me { align-self: flex-end; } .me .bubble { background: var(--line-green); color: white; border-top-right-radius: 2px; }
        .other { align-self: flex-start; } .other .bubble { border-top-left-radius: 2px; }
        
        /* AIËß£Ë™¨Áî® */
        .ai-bubble { align-self: flex-start; max-width: 90%; margin: 10px 0; border: 1.5px dashed var(--line-green); padding: 12px; border-radius: 15px; background: rgba(255,255,255,0.9); font-size: 13px; color: #333; }
        .ai-badge { background: var(--line-green); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-bottom: 5px; display: inline-block; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 20px; overflow-y: auto; }
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <button onclick="location.reload()" style="background:none; border:none; color:white; font-size:20px;">üè†</button>
    <div class="title" id="display-group-name">ÁêÜÁ≥ª„ÉÅ„É£„ÉÉ„Éà</div>
    <button onclick="openSettings()" id="gear-btn" style="display:none; background:none; border:none; color:white; font-size:20px;">‚öôÔ∏è</button>
</header>

<div id="chat-area"></div>

<div class="footer">
    <textarea id="msg-input" rows="1" placeholder="Êï∞Âºè„ÅØ$„ÅßÂõ≤„Çì„ÅßÂÖ•Âäõ" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
    <button onclick="sendMessage()" style="background:var(--line-green); color:white; border:none; width:40px; height:40px; border-radius:50%;">‚û§</button>
</div>

<div id="main-modal" class="modal">
    <h2 style="text-align:center; color:var(--line-green);">Chat-K Expert</h2>
    <div id="step-register">
        <input type="email" id="reg-email" style="width:100%; padding:15px; border-radius:12px; margin-bottom:10px;" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ">
        <div id="name-input-area" style="display:none;"><input type="text" id="reg-name" style="width:100%; padding:15px; border-radius:12px; margin-bottom:10px;" placeholder="„ÅäÂêçÂâçÔºàÂ∞ÇÈñÄ„Å™„Å©Ôºâ"></div>
        <button class="btn-main" onclick="checkEmail()">Ê¨°„Å∏</button>
    </div>
    <div id="step-home" style="display:none; text-align:center;">
        <p id="welcome-msg" style="font-weight:bold;"></p>
        <div id="history-list"></div>
        <button onclick="window.currentMode='create'; document.getElementById('group-form').style.display='block'" class="btn-main" style="margin-top:10px;">Êñ∞Ë¶è„Ç∞„É´„Éº„Éó‰ΩúÊàê</button>
        <div id="group-form" style="display:none; margin-top:10px;"><input type="text" id="group-id" placeholder="„Ç∞„É´„Éº„ÉóÂêç"><input type="password" id="group-pw" placeholder="PW"><button onclick="handleGroupAction()">‰ΩúÊàê/ÂèÇÂä†</button></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get, set, off, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com",
        projectId: "my-chat-1d626",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = localStorage.getItem('chat_name'), myEmail = localStorage.getItem('chat_email'), currentGid = "";

    // Êï∞ÂºèÊèèÁîªË®≠ÂÆö
    const mathOptions = { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] };

    window.onload = () => { (myName && myEmail) ? showStep('home') : showStep('register'); };

    window.sendMessage = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim()) return;
        push(ref(db, `v5_groups/${currentGid}/messages`), { 
            name: myName, 
            sender: myEmail, 
            text: inp.value, 
            type: 'text',
            time: serverTimestamp() 
        });
        inp.value = ""; inp.style.height = 'auto';
    };

    window.enterChat = async (gid) => {
        currentGid = gid;
        document.getElementById('main-modal').style.display = 'none';
        document.getElementById('gear-btn').style.display = 'block';
        document.getElementById('display-group-name').innerText = gid;
        const chatArea = document.getElementById('chat-area');
        chatArea.innerHTML = "";

        // ÂÖ•ÂÆ§ÈÄöÁü•„ÇíÈÄÅ‰ø°
        push(ref(db, `v5_groups/${gid}/messages`), { text: `${myName}„Åï„Çì„ÅåÂèÇÂä†„Åó„Åæ„Åó„Åü`, type: 'system' });

        const chatRef = ref(db, `v5_groups/${gid}/messages`);
        off(chatRef);
        onChildAdded(chatRef, (snap) => {
            const d = snap.val();
            const wrap = document.createElement('div');
            
            if(d.type === 'system') {
                wrap.className = 'system-msg';
                wrap.innerText = d.text;
            } else {
                wrap.className = `bubble-wrapper ${d.sender === myEmail ? 'me' : 'other'}`;
                wrap.innerHTML = `<div class="sender-name">${d.name}</div><div class="bubble">${d.text}</div>`;
                // Êï∞Âºè„Åå„ÅÇ„Çå„Å∞Âç≥Â∫ß„Å´Â§âÊèõ
                renderMathInElement(wrap, mathOptions);
            }
            
            chatArea.appendChild(wrap);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            // AIËß£Ë™¨„Éà„É™„Ç¨„ÉºÔºàËá™ÂàÜ‰ª•Â§ñ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÊôÇ„ÅÆ„ÅøÂèçÂøúÔºâ
            if(d.sender !== myEmail && d.type === 'text') checkExpertTerms(d.text);
        });
    };

    // --- AIËß£Ë™¨„É≠„Ç∏„ÉÉ„ÇØÔºàÁ∞°ÊòìÁâà„Ç®„Éü„É•„É¨„Éº„Ç∑„Éß„É≥Ôºâ ---
    // ÂÆüÈöõ„Å´„ÅØGemini API„Å®ÈÄ£Êê∫„Åï„Åõ„Åæ„Åô„Åå„ÄÅ„Åì„Åì„Åß„ÅØÁêÜÁ≥ªÁî®Ë™û„Å´ÂèçÂøú„Åô„Çã‰ªïÁµÑ„Åø„ÇíÂÆüË£Ö
    async function checkExpertTerms(text) {
        const terms = {
            "„Ç∑„É•„É¨„Éá„Ç£„É≥„Ç¨„Éº": "„ÄêËß£Ë™¨„ÄëÈáèÂ≠êÂäõÂ≠¶„Å´„Åä„Åë„ÇãÂü∫Á§éÊñπÁ®ãÂºè„ÇíÂ∞é„ÅÑ„ÅüÁâ©ÁêÜÂ≠¶ËÄÖ„ÄÇÁå´„ÅÆÊÄùËÄÉÂÆüÈ®ì„Åß„ÇÇÊúâÂêç„Åß„Åô„ÄÇ",
            "„Ç®„É≥„Éà„É≠„Éî„Éº": "„ÄêËß£Ë™¨„ÄëÁ≥ª„ÅÆ‰π±Èõë„Åï„ÇíË°®„ÅôÁâ©ÁêÜÈáè„ÄÇÁÜ±ÂäõÂ≠¶Á¨¨‰∫åÊ≥ïÂâá„Å´„Çà„Çä„ÄÅÂ≠§Á´ãÁ≥ª„Åß„ÅØÂ¢óÂ§ß„ÅóÁ∂ö„Åë„Åæ„Åô„ÄÇ",
            "„Éï„Éº„É™„Ç®Â§âÊèõ": "„ÄêËß£Ë™¨„Äë‰ø°Âè∑„ÇÑÈñ¢Êï∞„ÇíÂë®Ê≥¢Êï∞ÊàêÂàÜ„Å´ÂàÜËß£„Åô„ÇãÊï∞Â≠¶ÁöÑÊâãÊ≥ï„ÄÇ$f(\xi) = \int_{-\infty}^{\infty} f(x) e^{-2\pi i x \xi} dx$ „ÅßÂÆöÁæ©„Åï„Çå„Åæ„Åô„ÄÇ",
            "Áõ∏ÂØæÊÄßÁêÜË´ñ": "„ÄêËß£Ë™¨„Äë„Ç¢„Ç§„É≥„Ç∑„É•„Çø„Ç§„É≥„Å´„Çà„ÇãÁêÜË´ñ„ÄÇÊôÇÈñì„Å®Á©∫Èñì„ÅåË¶≥Ê∏¨ËÄÖ„ÅÆÈÄüÂ∫¶„Å´„Çà„Å£„Å¶Â§âÂåñ„Åô„Çã„Åì„Å®„ÇíË®òËø∞„Åó„Åæ„Åô„ÄÇ"
        };

        for (let key in terms) {
            if (text.includes(key)) {
                setTimeout(() => {
                    const aiWrap = document.createElement('div');
                    aiWrap.className = 'ai-bubble';
                    aiWrap.innerHTML = `<span class="ai-badge">Gemini Advisor</span><br>${terms[key]}`;
                    renderMathInElement(aiWrap, mathOptions);
                    document.getElementById('chat-area').appendChild(aiWrap);
                    document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
                }, 1500);
                break;
            }
        }
    }

    // --- Ë™çË®ºÁ≥ª (Ver 4.6.3Á∂ôÊâø) ---
    window.checkEmail = async () => {
        const email = document.getElementById('reg-email').value.trim().toLowerCase();
        const snap = await get(ref(db, `users/${email.replace(/\./g, '_')}`));
        if(snap.exists()){
            myName = snap.val().name; myEmail = email;
            localStorage.setItem('chat_name', myName); localStorage.setItem('chat_email', myEmail);
            showStep('home');
        } else {
            document.getElementById('name-input-area').style.display = 'block';
            document.getElementById('auth-btn').onclick = () => finalizeReg(email);
        }
    };
    async function finalizeReg(email) {
        const name = document.getElementById('reg-name').value.trim();
        await set(ref(db, `users/${email.replace(/\./g, '_')}`), { name: name });
        myName = name; myEmail = email;
        localStorage.setItem('chat_name', name); localStorage.setItem('chat_email', email);
        showStep('home');
    }
    window.handleGroupAction = async () => {
        const gid = document.getElementById('group-id').value.trim(), pw = btoa(document.getElementById('group-pw').value);
        await set(ref(db, `v5_groups/${gid}`), { host: myEmail, pw: pw });
        let h = JSON.parse(localStorage.getItem('chat_history') || "[]"); h.push(gid);
        localStorage.setItem('chat_history', JSON.stringify(h));
        enterChat(gid);
    };
    function showStep(s) { 
        document.getElementById('step-register').style.display = 'none'; 
        document.getElementById('step-home').style.display = 'none'; 
        document.getElementById('step-'+s).style.display = 'block';
        if(s === 'home') refreshHistory();
    }
    function refreshHistory() {
        const list = document.getElementById('history-list'); list.innerHTML = "";
        JSON.parse(localStorage.getItem('chat_history') || "[]").forEach(gid => {
            const div = document.createElement('div');
            div.style = "background:white; padding:10px; border-radius:10px; margin-bottom:5px; display:flex; justify-content:space-between;";
            div.innerHTML = `<span>${gid}</span><button onclick="enterChat('${gid}')">ÂÖ•ÂÆ§</button>`;
            list.appendChild(div);
        });
        document.getElementById('welcome-msg').innerText = "Hello, " + myName;
    }
</script>
</body>
</html>
