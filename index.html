<script type="module">
    // --- 修正された Gemini API 接続関数 ---
    window.askGemini = async (text) => {
        const key = localStorage.getItem('gemini_api_key');
        const age = localStorage.getItem('user_age') || "20";
        const content = document.getElementById('detail-content');
        
        document.getElementById('detail-panel').classList.add('open');
        content.innerHTML = `<div style="text-align:center; padding:20px;">AIが思考中...</div>`;

        if(!key) {
            content.innerHTML = `<p style="color:red;">⚠️ APIキーが設定されていません。右上の⚙️から設定してください。</p>`;
            return;
        }

        // 修正ポイント：エンドポイントを v1 に変更し、モデル名を指定
        // また、万が一に備えフォールバック（代わりのモデル）も考慮したURLにしています
        const API_URL = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${key}`;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ 
                        parts: [{ 
                            text: `あなたは理系講師です。${age}歳の生徒に向けて、次のメッセージに含まれる理系用語を抽出し、LaTeX（$）を使ってHTML形式で詳しく解説してください。回答は必ず日本語で行ってください。対象メッセージ:「${text}」` 
                        }] 
                    }]
                })
            });

            const data = await response.json();

            if (!response.ok) {
                // モデルが見つからない等のエラー時の詳細表示
                throw new Error(data.error ? data.error.message : "APIエラーが発生しました");
            }

            const aiText = data.candidates[0].content.parts[0].text;
            // マークダウンのコードブロックなどを簡易的にHTMLへ変換
            content.innerHTML = aiText.replace(/\n/g, "<br>").replace(/### (.+)/g, "<b>$1</b>");
            
            if(window.renderMathInElement) {
                renderMathInElement(content, { 
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false}
                    ] 
                });
            }
        } catch (e) {
            content.innerHTML = `
                <div style="color:#d32f2f; background:#ffebee; padding:15px; border-radius:10px;">
                    <b>❌ 通信エラー</b><br>
                    <small>${e.message}</small>
                    <hr>
                    <p style="font-size:12px;">【解決策】<br>
                    1. APIキーが Google AI Studio で正しく作成されているか確認。<br>
                    2. キーのコピーに余計な文字が入っていないか確認してください。</p>
                </div>`;
        }
    };
    // ... 他の関数は Ver 5.2.3 と同じ
</script>
