<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat-K Ver 4.5.8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; }
        * { box-sizing: border-box; }
        body { background: var(--bg-blue); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: var(--header-dark); color: white; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; height: 55px; flex-shrink: 0; z-index: 100; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 12px; }
        .footer { background: #fff; padding: 8px 10px; display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #ddd; }
        #msg-input { flex: 1; border: none; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; }
        
        /* è¨­å®šãƒ‘ãƒãƒ«ã®å¼·åŒ– */
        #settings-panel { position: fixed; top: 0; right: -100%; width: 85%; height: 100%; background: white; z-index: 2000; transition: 0.3s; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.3); overflow-y: auto; }
        #settings-panel.open { right: 0; }
        .member-chip { display: inline-block; background: #f0f2f5; padding: 5px 12px; border-radius: 15px; font-size: 13px; margin: 3px; border: 1px solid #ddd; }
        .host-badge { background: #ffd700; font-size: 10px; padding: 2px 5px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 25px; display: block; text-align: center; }
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-sub { width: 100%; padding: 12px; background: #666; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; }
        
        #scanner-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 3000; display: none; flex-direction: column; }
        #video-preview { width: 100%; height: 70%; object-fit: cover; }
        
        .bubble { padding: 8px 12px; border-radius: 18px; font-size: 15px; background: white; white-space: pre-wrap; word-break: break-all; }
        .me { align-self: flex-end; } .me .bubble { background: var(--line-green); color: white; border-top-left-radius: 18px; border-top-right-radius: 2px; }
        .other { align-self: flex-start; }
    </style>
</head>
<body>

<header>
    <button onclick="location.reload()" style="background:none; border:none; color:white; font-size:24px;">ğŸ </button>
    <div id="display-group-name">Chat-K</div>
    <button id="gear-btn" onclick="openSettings()" style="background:none; border:none; color:white; font-size:24px; display:none;">âš™ï¸</button>
    <div id="header-spacer" style="width:24px;"></div>
</header>

<div id="chat-area"></div>

<div class="footer">
    <textarea id="msg-input" rows="1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›"></textarea>
    <button onclick="sendMessage()" style="background:var(--line-green); color:white; border:none; width:42px; height:42px; border-radius:50%;">â¤</button>
</div>

<div id="settings-panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š</h3>
        <button onclick="closeSettings()" style="font-size:24px; border:none; background:none;">Ã—</button>
    </div>
    <hr>
    
    <div id="host-only-info" style="display:none; background:#fff9c4; padding:10px; border-radius:8px; margin-bottom:15px; text-align:left; border:1px solid #fbc02d;">
        <p style="margin:0; font-size:12px; color:#856404;"><b>ğŸ”‘ ãƒ›ã‚¹ãƒˆé™å®šæƒ…å ±</b></p>
        <p style="margin:5px 0 0; font-size:16px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: <strong id="info-pw"></strong></p>
    </div>

    <div style="text-align:left;">
        <p><b>å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼:</b></p>
        <div id="member-list"></div>
    </div>
    
    <div id="qr-code" style="margin:20px auto; display:flex; justify-content:center;"></div>
    <p style="font-size:11px; color:#666;">ã“ã®QRã‚’ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦æ‹›å¾…</p>
    
    <hr>
    <button class="btn-sub" onclick="leaveGroup()" style="background:#ff4b4b;">ã‚°ãƒ«ãƒ¼ãƒ—ã®å±¥æ­´ã‚’æ¶ˆã™</button>
</div>

<div id="scanner-container">
    <div style="color:white; padding:20px;" onclick="stopScanner()">Ã— é–‰ã˜ã‚‹</div>
    <video id="video-preview"></video>
    <canvas id="scan-canvas" style="display:none;"></canvas>
</div>

<div id="main-modal" class="modal">
    <h2 style="color:var(--line-green);">Chat-K</h2>
    <div id="step-register">
        <input type="email" id="reg-email" placeholder="Gmailã‚¢ãƒ‰ãƒ¬ã‚¹" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
        <div id="name-input-area" style="display:none;">
            <input type="text" id="reg-name" placeholder="è¡¨ç¤ºå" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
        </div>
        <button class="btn-main" id="auth-btn" onclick="checkEmail()">ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²</button>
    </div>

    <div id="step-home" style="display:none;">
        <p id="welcome-msg"></p>
        <button class="btn-main" onclick="startScanner()" style="background:#4285F4; margin-bottom:15px;">ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³ã§å‚åŠ </button>
        <div id="history-list"></div>
        <button class="btn-sub" onclick="toggleForm('join')">æ‰‹å‹•å‚åŠ </button>
        <button class="btn-sub" onclick="toggleForm('create')">æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</button>
        <div id="group-form" style="display:none; margin-top:15px; background:#eee; padding:15px; border-radius:10px;">
            <input type="text" id="group-id" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" style="width:100%; padding:10px; margin-bottom:5px;">
            <input type="password" id="group-pw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%; padding:10px; margin-bottom:5px;">
            <button class="btn-main" onclick="handleGroupAction()">å®Ÿè¡Œ</button>
        </div>
        <button onclick="logout()" style="color:red; border:none; background:none; margin-top:30px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get, set, serverTimestamp, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com",
        projectId: "my-chat-1d626",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = localStorage.getItem('chat_name'), myEmail = localStorage.getItem('chat_email'), currentGid = "";
    let members = {};

    window.onload = () => { (myName && myEmail) ? showStep('home') : showStep('register'); };

    // --- è¨­å®šãƒ‘ãƒãƒ« & ãƒ›ã‚¹ãƒˆç®¡ç† ---
    window.openSettings = async () => {
        const groupSnap = await get(ref(db, `v5_groups/${currentGid}`));
        if(!groupSnap.exists()) return;
        const groupData = groupSnap.val();

        // 1. ãƒ›ã‚¹ãƒˆåˆ¤å®š & ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º
        const hostInfo = document.getElementById('host-only-info');
        if(groupData.host === myEmail) {
            hostInfo.style.display = 'block';
            document.getElementById('info-pw').innerText = atob(groupData.pw);
        } else { hostInfo.style.display = 'none'; }

        // 2. ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆæ›´æ–° (ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆã®ç™ºè¨€è€…ã‹ã‚‰é›†è¨ˆ)
        const listDiv = document.getElementById('member-list');
        listDiv.innerHTML = "";
        Object.keys(members).forEach(mEmail => {
            const span = document.createElement('span');
            span.className = 'member-chip';
            span.innerHTML = members[mEmail] + (mEmail === groupData.host ? '<span class="host-badge">HOST</span>' : '');
            listDiv.appendChild(span);
        });

        // 3. QRã‚³ãƒ¼ãƒ‰ (æ‹›å¾…ãƒªãƒ³ã‚¯)
        const access = JSON.parse(localStorage.getItem('chat_access') || "{}");
        document.getElementById('qr-code').innerHTML = "";
        new QRCode(document.getElementById('qr-code'), {
            text: `${window.location.origin}${window.location.pathname}?join=${currentGid}`,
            width: 140, height: 140
        });
        
        document.getElementById('settings-panel').classList.add('open');
    };

    window.closeSettings = () => document.getElementById('settings-panel').classList.remove('open');

    // --- ãƒãƒ£ãƒƒãƒˆå…¥å®¤ & ãƒ¡ãƒ³ãƒãƒ¼ç›£è¦– ---
    window.enterChat = (gid) => {
        currentGid = gid;
        members = {}; // åˆæœŸåŒ–
        document.getElementById('main-modal').style.display = 'none';
        document.getElementById('gear-btn').style.display = 'block';
        document.getElementById('display-group-name').innerText = gid;
        document.getElementById('chat-area').innerHTML = "";
        
        const chatRef = ref(db, `v5_groups/${gid}/messages`);
        off(chatRef);
        onChildAdded(chatRef, (snap) => {
            const d = snap.val();
            // ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¨˜éŒ²
            members[d.sender] = d.name;
            
            const wrap = document.createElement('div');
            wrap.className = `bubble-wrapper ${d.sender === myEmail ? 'me' : 'other'}`;
            wrap.innerHTML = `<div style="font-size:10px;margin:0 5px;color:#eee;">${d.name}</div><div class="bubble">${d.text}</div>`;
            document.getElementById('chat-area').appendChild(wrap);
            document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
        });
    };

    // --- QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ & æ‹›å¾…å¯¾å¿œ ---
    window.startScanner = async () => {
        const video = document.getElementById('video-preview');
        document.getElementById('scanner-container').style.display = 'flex';
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        video.setAttribute("playsinline", true);
        video.play();
        const tick = () => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.getElementById('scan-canvas');
                canvas.height = video.videoHeight; canvas.width = video.videoWidth;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
                if (code) {
                    stopScanner();
                    const url = new URL(code.data);
                    const gid = url.searchParams.get('join');
                    if(gid) {
                        const pw = prompt(`ã‚°ãƒ«ãƒ¼ãƒ—ã€Œ${gid}ã€ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›`);
                        if(pw) { document.getElementById('group-id').value = gid; document.getElementById('group-pw').value = pw; window.currentMode = 'join'; handleGroupAction(); }
                    }
                    return;
                }
            }
            if(document.getElementById('scanner-container').style.display === 'flex') requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
    };
    window.stopScanner = () => {
        document.getElementById('video-preview').srcObject.getTracks().forEach(t => t.stop());
        document.getElementById('scanner-container').style.display = 'none';
    };

    // --- åŸºæœ¬ãƒ­ã‚¸ãƒƒã‚¯ (Firebase & Storage) ---
    window.checkEmail = async () => {
        const email = document.getElementById('reg-email').value.trim();
        const snap = await get(ref(db, `users/${email.replace(/\./g, '_')}`));
        if(snap.exists()){
            myName = snap.val().name; myEmail = email;
            localStorage.setItem('chat_name', myName); localStorage.setItem('chat_email', myEmail);
            if(snap.val().history) localStorage.setItem('chat_history', JSON.stringify(snap.val().history));
            showStep('home');
        } else {
            document.getElementById('name-input-area').style.display = 'block';
            document.getElementById('auth-btn').onclick = () => finalizeNewAccount(email);
        }
    };
    async function finalizeNewAccount(email) {
        const name = document.getElementById('reg-name').value.trim();
        if(!name) return;
        await set(ref(db, `users/${email.replace(/\./g, '_')}`), { name: name, history: [] });
        myName = name; myEmail = email;
        localStorage.setItem('chat_name', name); localStorage.setItem('chat_email', email);
        showStep('home');
    }
    window.handleGroupAction = async () => {
        const gid = document.getElementById('group-id').value.trim(), pw = btoa(document.getElementById('group-pw').value);
        const snap = await get(ref(db, `v5_groups/${gid}`));
        if(window.currentMode === 'create') {
            if(snap.exists()) return alert("æ—¢ã«å­˜åœ¨");
            await set(ref(db, `v5_groups/${gid}`), { host: myEmail, pw: pw });
        } else { if(!snap.exists() || snap.val().pw !== pw) return alert("èªè¨¼å¤±æ•—"); }
        saveGroupLocal(gid, pw); enterChat(gid);
    };
    function saveGroupLocal(gid, pw) {
        let history = JSON.parse(localStorage.getItem('chat_history') || "[]");
        if(!history.includes(gid)) history.push(gid);
        localStorage.setItem('chat_history', JSON.stringify(history));
        let access = JSON.parse(localStorage.getItem('chat_access') || "{}");
        access[gid] = pw; localStorage.setItem('chat_access', JSON.stringify(access));
        set(ref(db, `users/${myEmail.replace(/\./g, '_')}/history`), history);
    }
    window.sendMessage = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim() || !currentGid) return;
        push(ref(db, `v5_groups/${currentGid}/messages`), { name: myName, sender: myEmail, text: inp.value });
        inp.value = "";
    };
    window.toggleForm = (m) => { window.currentMode = m; document.getElementById('group-form').style.display = 'block'; };
    function showStep(s) {
        document.getElementById('step-register').style.display = 'none';
        document.getElementById('step-home').style.display = 'none';
        document.getElementById('step-'+s).style.display = 'block';
        if(s === 'home') refreshHistory();
    }
    function refreshHistory() {
        const list = document.getElementById('history-list'); list.innerHTML = "";
        JSON.parse(localStorage.getItem('chat_history') || "[]").forEach(gid => {
            const div = document.createElement('div'); div.className = 'history-item';
            div.style = "background:white; padding:12px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;";
            div.innerHTML = `<span><b>${gid}</b></span><button onclick="enterChat('${gid}')" style="background:var(--line-green);color:white;border:none;padding:8px 15px;border-radius:8px;">å…¥å®¤</button>`;
            list.appendChild(div);
        });
        document.getElementById('welcome-msg').innerText = "ãƒ­ã‚°ã‚¤ãƒ³: " + myName;
    }
    window.leaveGroup = () => {
        if(confirm("ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å±¥æ­´ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            let h = JSON.parse(localStorage.getItem('chat_history') || "[]").filter(g => g !== currentGid);
            localStorage.setItem('chat_history', JSON.stringify(h));
            location.reload();
        }
    };
    window.logout = () => { if(confirm("å…¨æ¶ˆå»ã—ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼Ÿ")) { localStorage.clear(); location.reload(); } };
</script>
</body>
</html>
