<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* ç”»é¢å…¨ä½“ã®å›ºå®š */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; position: fixed; width: 100%; background: var(--bg-blue); font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; }
        body { display: flex; flex-direction: column; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®å®‰å®šåŒ– */
        header { 
            background: var(--header-dark); 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 50px; 
            padding: 0 10px;
            padding-top: env(safe-area-inset-top);
            flex-shrink: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        header button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; width: 40px; }
        header .title { flex: 1; text-align: center; font-weight: bold; font-size: 16px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ»‘ã‚‰ã‹ã« */
        #chat-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px 10px; 
            display: flex; 
            flex-direction: column; 
            gap: 14px; 
            -webkit-overflow-scrolling: touch;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ï¼šLINEé¢¨ã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ« */
        .footer { 
            background: #ffffff; 
            padding: 8px 10px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            display: flex; 
            align-items: flex-end; 
            gap: 8px; 
            border-top: 1px solid #ddd;
            flex-shrink: 0;
        }
        #msg-input { 
            flex: 1; 
            border: none; 
            background: #f0f2f5; 
            padding: 10px 15px; 
            border-radius: 20px; 
            font-size: 16px; 
            outline: none; 
            max-height: 100px;
            resize: none;
            line-height: 1.4;
        }

        /* ãµãã ã—ï¼šã‚ˆã‚ŠLINEã«è¿‘ã„ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .bubble { padding: 8px 14px; border-radius: 18px; font-size: 15px; background: white; white-space: pre-wrap; word-break: break-all; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sender-name { font-size: 11px; color: #555; margin-bottom: 3px; margin-left: 5px; }
        
        .me { align-self: flex-end; } 
        .me .bubble { background: var(--line-green); color: white; border-top-right-radius: 2px; }
        .me .sender-name { align-self: flex-end; margin-right: 5px; color: #eee; }
        
        .other { align-self: flex-start; } 
        .other .bubble { border-top-left-radius: 2px; }

        /* è¨­å®šãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ (Ver 4.6.1ç¶™æ‰¿) */
        #settings-panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100%; background: white; z-index: 2000; transition: 0.3s; padding: 20px; overflow-y: auto; }
        #settings-panel.open { right: 0; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 20px; display: block; overflow-y: auto; }
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <button onclick="location.reload()">ğŸ </button>
    <div class="title" id="display-group-name">Chat-K</div>
    <button id="gear-btn" onclick="openSettings()" style="display:none;">âš™ï¸</button>
</header>

<div id="chat-area"></div>

<div class="footer" id="footer-ui">
    <textarea id="msg-input" rows="1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" oninput="autoResize(this)" onkeydown="handleKeyDown(event)"></textarea>
    <button onclick="sendMessage()" style="background:var(--line-green); color:white; border:none; width:40px; height:40px; border-radius:50%; flex-shrink:0; display:flex; justify-content:center; align-items:center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">â¤</button>
</div>

<div id="settings-panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š</h3>
        <button onclick="closeSettings()" style="font-size:30px; border:none; background:none;">&times;</button>
    </div>
    <hr>
    <div id="host-only-info" style="display:none; background:#fff9c4; padding:15px; border-radius:10px; margin-bottom:15px;">
        <p style="margin:0; font-size:12px;"><b>ğŸ”‘ ãƒ›ã‚¹ãƒˆæ¨©é™: PWå¤‰æ›´</b></p>
        <input type="text" id="edit-group-pw" style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid #ccc;">
        <button onclick="updateGroupPw()" style="margin-top:8px; width:100%;">ä¿å­˜</button>
    </div>
    <div id="member-list" style="margin-bottom:20px;"></div>
    <div id="qr-code" style="display:flex; justify-content:center; margin:20px 0;"></div>
    <button onclick="leaveGroup()" style="width:100%; padding:12px; background:#ff4b4b; color:white; border:none; border-radius:8px;">å±¥æ­´ã‹ã‚‰å‰Šé™¤</button>
</div>

<div id="main-modal" class="modal">
    <h2 style="color:var(--line-green); text-align:center;">Chat-K</h2>
    <div id="step-register">
        <input type="email" id="reg-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-bottom:15px;">
        <div id="name-input-area" style="display:none;"><input type="text" id="reg-name" placeholder="ãŠåå‰" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-bottom:15px;"></div>
        <button class="btn-main" onclick="checkEmail()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <div id="step-home" style="display:none; text-align:center;">
        <div style="background:white; padding:15px; border-radius:15px; margin-bottom:15px; border:1px solid #ddd;">
            <p id="welcome-msg" style="font-weight:bold;"></p>
            <input type="text" id="edit-my-name" style="width:100%; padding:8px; text-align:center; border:1px solid #eee; margin:10px 0;">
            <button onclick="updateProfileName()" style="font-size:12px;">åå‰ã‚’æ›´æ–°</button>
        </div>
        <button class="btn-main" onclick="startScanner()" style="background:#4285F4; margin-bottom:15px;">ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³ã§å‚åŠ </button>
        <div id="history-list"></div>
        <button onclick="toggleForm('join')" style="width:100%; background:#eee; border:none; padding:15px; border-radius:12px; margin-top:10px;">æ‰‹å‹•ã§å‚åŠ </button>
        <button onclick="toggleForm('create')" style="width:100%; background:none; border:1px solid #ccc; padding:10px; border-radius:12px; margin-top:10px; color:#666;">ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</button>
        <div id="group-form" style="display:none; margin-top:10px; padding:15px; background:#fff; border-radius:12px; border:1px solid #ddd;">
            <input type="text" id="group-id" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" style="width:100%; padding:10px; margin-bottom:5px;">
            <input type="password" id="group-pw" placeholder="PW" style="width:100%; padding:10px; margin-bottom:5px;">
            <button class="btn-main" onclick="handleGroupAction()">æ±ºå®š</button>
        </div>
        <button onclick="logout()" style="color:red; border:none; background:none; margin-top:30px; font-size:12px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get, set, off, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com",
        projectId: "my-chat-1d626",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = localStorage.getItem('chat_name'), myEmail = localStorage.getItem('chat_email'), currentGid = "";
    let members = {};

    // --- ã€é‡è¦ã€‘ã‚¹ãƒãƒ›ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾ç­– ---
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            const viewHeight = window.visualViewport.height;
            document.body.style.height = viewHeight + 'px';
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒå‡ºãŸæ™‚ã«æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
            }, 100);
        });
    }

    window.autoResize = (obj) => {
        obj.style.height = 'auto';
        obj.style.height = obj.scrollHeight + 'px';
    };

    window.onload = () => { (myName && myEmail) ? showStep('home') : showStep('register'); };

    // PCé€ä¿¡ & ã‚¹ãƒãƒ›ã§ã®æ”¹è¡Œåˆ¶å¾¡
    window.handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            if (e.shiftKey || window.innerWidth < 768) {
                // PCãªã‚‰Shift+Enterã€ã‚¹ãƒãƒ›ãªã‚‰æ™®é€šã®Enterã¯æ”¹è¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŒ™å‹•ï¼‰
                return;
            } else {
                // PCã§Shiftãªã—Enterãªã‚‰é€ä¿¡
                e.preventDefault();
                sendMessage();
            }
        }
    };

    window.sendMessage = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim() || !currentGid) return;
        push(ref(db, `v5_groups/${currentGid}/messages`), { name: myName, sender: myEmail, text: inp.value });
        inp.value = "";
        inp.style.height = 'auto';
        inp.focus();
    };

    window.enterChat = (gid) => {
        currentGid = gid; members = {};
        document.getElementById('main-modal').style.display = 'none';
        document.getElementById('gear-btn').style.display = 'block';
        document.getElementById('display-group-name').innerText = gid;
        document.getElementById('chat-area').innerHTML = "";
        const chatRef = ref(db, `v5_groups/${gid}/messages`);
        off(chatRef);
        onChildAdded(chatRef, (snap) => {
            const d = snap.val();
            members[d.sender] = d.name;
            const wrap = document.createElement('div');
            wrap.className = `bubble-wrapper ${d.sender === myEmail ? 'me' : 'other'}`;
            wrap.innerHTML = `<div class="sender-name">${d.name}</div><div class="bubble">${d.text}</div>`;
            document.getElementById('chat-area').appendChild(wrap);
            document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
        });
    };

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»è¨­å®šé–¢é€£ (Ver 4.6.1ã‚ˆã‚Š)
    window.updateProfileName = async () => {
        const newName = document.getElementById('edit-my-name').value.trim();
        if(!newName) return;
        await update(ref(db, `users/${myEmail.replace(/\./g, '_')}`), { name: newName });
        localStorage.setItem('chat_name', newName); myName = newName;
        alert("å¤‰æ›´ã—ã¾ã—ãŸ"); refreshHistory();
    };

    window.openSettings = async () => {
        const snap = await get(ref(db, `v5_groups/${currentGid}`));
        const data = snap.val();
        if(data.host === myEmail) {
            document.getElementById('host-only-info').style.display = 'block';
            document.getElementById('edit-group-pw').value = atob(data.pw);
        }
        document.getElementById('qr-code').innerHTML = "";
        new QRCode(document.getElementById('qr-code'), { text: `${window.location.origin}${window.location.pathname}?join=${currentGid}`, width: 140, height: 140 });
        document.getElementById('settings-panel').classList.add('open');
    };
    window.closeSettings = () => document.getElementById('settings-panel').classList.remove('open');

    // QRã‚¹ã‚­ãƒ£ãƒ³ãƒ»èªè¨¼ï¼ˆçœç•¥ã›ãšå®Ÿè£…ï¼‰
    window.startScanner = async () => {
        const container = document.createElement('div');
        container.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:3000; display:flex; flex-direction:column;";
        container.innerHTML = `<div style="color:white; padding:20px;" id="close-scan">âœ• é–‰ã˜ã‚‹</div><video id="v" style="width:100%; flex:1; object-fit:cover;"></video><canvas id="c" style="display:none;"></canvas>`;
        document.body.appendChild(container);
        const v = document.getElementById('v'), c = document.getElementById('c'), ctx = c.getContext('2d');
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        v.srcObject = s; v.play();
        const close = () => { s.getTracks().forEach(t => t.stop()); container.remove(); };
        document.getElementById('close-scan').onclick = close;
        const loop = () => {
            if (v.readyState === v.HAVE_ENOUGH_DATA) {
                c.height = v.videoHeight; c.width = v.videoWidth;
                ctx.drawImage(v, 0, 0, c.width, c.height);
                const code = jsQR(ctx.getImageData(0, 0, c.width, c.height).data, c.width, c.height);
                if (code) {
                    const gid = new URL(code.data).searchParams.get('join');
                    if(gid) { close(); const pw = prompt(`PWã‚’å…¥åŠ›`); if(pw){ document.getElementById('group-id').value = gid; document.getElementById('group-pw').value = pw; window.currentMode='join'; handleGroupAction(); } }
                }
            }
            if(document.body.contains(container)) requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
    };

    // åŸºç¤é–¢æ•°
    window.checkEmail = async () => {
        const email = document.getElementById('reg-email').value.trim();
        const snap = await get(ref(db, `users/${email.replace(/\./g, '_')}`));
        if(snap.exists()){
            myName = snap.val().name; myEmail = email;
            localStorage.setItem('chat_name', myName); localStorage.setItem('chat_email', myEmail);
            if(snap.val().history) localStorage.setItem('chat_history', JSON.stringify(snap.val().history));
            showStep('home');
        } else { document.getElementById('name-input-area').style.display = 'block'; }
    };
    window.handleGroupAction = async () => {
        const gid = document.getElementById('group-id').value.trim(), pw = btoa(document.getElementById('group-pw').value);
        const snap = await get(ref(db, `v5_groups/${gid}`));
        if(window.currentMode === 'create') { await set(ref(db, `v5_groups/${gid}`), { host: myEmail, pw: pw }); }
        else { if(!snap.exists() || snap.val().pw !== pw) return alert("èªè¨¼ã‚¨ãƒ©ãƒ¼"); }
        saveGroupLocal(gid, pw); enterChat(gid);
    };
    function saveGroupLocal(gid, pw) {
        let h = JSON.parse(localStorage.getItem('chat_history') || "[]"); if(!h.includes(gid)) h.push(gid);
        localStorage.setItem('chat_history', JSON.stringify(h));
        let a = JSON.parse(localStorage.getItem('chat_access') || "{}"); a[gid] = pw;
        localStorage.setItem('chat_access', JSON.stringify(a));
        update(ref(db, `users/${myEmail.replace(/\./g, '_')}`), { history: h });
    }
    function showStep(s) { document.getElementById('step-register').style.display = 'none'; document.getElementById('step-home').style.display = 'none'; document.getElementById('step-'+s).style.display = 'block'; if(s === 'home') refreshHistory(); }
    function refreshHistory() {
        const list = document.getElementById('history-list'); list.innerHTML = "";
        JSON.parse(localStorage.getItem('chat_history') || "[]").forEach(gid => {
            const div = document.createElement('div');
            div.style = "background:white; padding:12px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #ddd;";
            div.innerHTML = `<span><b>${gid}</b></span><button onclick="enterChat('${gid}')" style="background:var(--line-green);color:white;border:none;padding:8px 15px;border-radius:10px;">å…¥å®¤</button>`;
            list.appendChild(div);
        });
        document.getElementById('welcome-msg').innerText = myName;
        document.getElementById('edit-my-name').value = myName;
    }
    window.logout = () => { localStorage.clear(); location.reload(); };
    window.toggleForm = (m) => { window.currentMode = m; document.getElementById('group-form').style.display = 'block'; };
</script>
</body>
</html>
