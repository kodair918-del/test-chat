<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K | True AI Intelligence</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; --gemini-blue: #4285F4; }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; overflow: hidden; position: fixed; width: 100%; background: var(--bg-blue); font-family: sans-serif; }
        body { display: flex; flex-direction: column; }
        header { background: var(--header-dark); color: white; display: flex; align-items: center; height: 50px; padding: 0 15px; flex-shrink: 0; }
        header .title { flex: 1; text-align: center; font-weight: bold; }
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 12px; }
        .bubble-wrapper { display: flex; flex-direction: column; max-width: 80%; position: relative; margin-bottom: 5px; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }
        .me { align-self: flex-end; } .me .bubble { background: var(--line-green); color: white; }
        .ai-hint { font-size: 9px; color: white; margin-top: 2px; margin-left: 5px; opacity: 0.8; }
        #detail-panel { position: fixed; bottom: -100%; left: 0; width: 100%; height: 80%; background: white; z-index: 2000; transition: 0.4s cubic-bezier(0, 0.5, 0.5, 1); border-radius: 20px 20px 0 0; padding: 25px; overflow-y: auto; }
        #detail-panel.open { bottom: 0; }
        .footer { background: white; padding: 10px; display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #ddd; }
        #msg-input { flex: 1; border: none; background: #f0f2f5; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; }
        .settings-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1500; }
    </style>
</head>
<body>

<header>
    <div style="width:30px;">ğŸ </div>
    <div class="title">Gemini Expert Chat</div>
    <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
</header>

<div id="chat-area"></div>
<div id="overlay" class="overlay" onclick="closeDetail()"></div>

<div id="detail-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <span style="color:var(--gemini-blue); font-weight:bold;">âœ¨ Gemini AI è§£èª¬</span>
        <button onclick="closeDetail()" style="border:none; background:none; font-size:24px;">&times;</button>
    </div>
    <div id="detail-content" style="line-height:1.6;">AIãŒæ€è€ƒä¸­...</div>
</div>

<div id="settings-panel" style="position:fixed; top:0; right:-100%; width:100%; height:100%; background:white; z-index:3000; transition:0.3s; padding:20px;">
    <h3>AI & ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</h3>
    <hr>
    <label>Gemini API Key:</label>
    <input type="password" id="api-key" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd;" placeholder="AI Studioã§å–å¾—ã—ãŸã‚­ãƒ¼">
    <label>ã‚ãªãŸã®å¹´é½¢:</label>
    <input type="number" id="user-age" value="20" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd;">
    <button onclick="saveSettings()" style="width:100%; padding:15px; background:var(--gemini-blue); color:white; border:none; border-radius:12px; font-weight:bold;">ä¿å­˜ã—ã¦é©ç”¨</button>
    <button onclick="toggleSettings()" style="width:100%; margin-top:10px; border:none; background:none;">æˆ»ã‚‹</button>
</div>

<div class="footer">
    <textarea id="msg-input" rows="1" placeholder="ç†ç³»ã®è©±ã‚’ã—ã¾ã—ã‚‡ã†..."></textarea>
    <button onclick="send()" style="background:var(--gemini-blue); color:white; border:none; width:44px; height:44px; border-radius:50%;">â¤</button>
</div>

<script type="module">
    let apiKey = localStorage.getItem('gemini_api_key') || "";
    let userAge = localStorage.getItem('user_age') || "20";
    document.getElementById('api-key').value = apiKey;
    document.getElementById('user-age').value = userAge;

    // --- Gemini API é€£æºãƒ­ã‚¸ãƒƒã‚¯ ---
    async function fetchGeminiExplanation(text) {
        if(!apiKey) return "è¨­å®šç”»é¢ã‹ã‚‰APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        
        const prompt = `ã‚ãªãŸã¯ç†ç³»å°‚é–€å®¶ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚
        ãƒ¦ãƒ¼ã‚¶ãƒ¼å¹´é½¢: ${userAge}æ­³
        ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã¾ã‚Œã‚‹é›£ã—ã„å°‚é–€ç”¨èªã‚’æŠ½å‡ºã—ã€ãã®å¹´é½¢ã«åˆã‚ã›ãŸé›£æ˜“åº¦ã§è§£èª¬ã—ã¦ãã ã•ã„ã€‚
        æ•°å¼ãŒå¿…è¦ãªå ´åˆã¯ LaTeXå½¢å¼ï¼ˆ$ ã¾ãŸã¯ $$ ã§å›²ã‚€ï¼‰ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
        è¿”ä¿¡ã¯HTMLå½¢å¼ã§ã€è¦‹å‡ºã—ãªã©ã¯ <b> ã‚„ <h4> ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
        
        å¯¾è±¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "${text}"`;

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        } catch (e) {
            return "ã‚¨ãƒ©ãƒ¼: APIã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        }
    }

    window.send = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim()) return;
        renderMessage("User", inp.value);
        inp.value = "";
    };

    function renderMessage(name, text) {
        const area = document.getElementById('chat-area');
        const wrap = document.createElement('div');
        wrap.className = `bubble-wrapper ${name === "User" ? "me" : "other"}`;
        wrap.innerHTML = `<div class="bubble">${text}</div><div class="ai-hint">ğŸ’¡ ã‚¯ãƒªãƒƒã‚¯ã—ã¦AIè§£èª¬</div>`;
        
        wrap.onclick = async () => {
            document.getElementById('detail-content').innerHTML = "GeminiãŒæ€è€ƒä¸­...";
            document.getElementById('detail-panel').classList.add('open');
            document.getElementById('overlay').style.display = 'block';
            
            const explanation = await fetchGeminiExplanation(text);
            document.getElementById('detail-content').innerHTML = explanation;
            
            // æ•°å¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            if(window.renderMathInElement) {
                renderMathInElement(document.getElementById('detail-content'), {
                    delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}]
                });
            }
        };

        area.appendChild(wrap);
        area.scrollTop = area.scrollHeight;
    }

    window.saveSettings = () => {
        apiKey = document.getElementById('api-key').value;
        userAge = document.getElementById('user-age').value;
        localStorage.setItem('gemini_api_key', apiKey);
        localStorage.setItem('user_age', userAge);
        toggleSettings();
    };
    window.toggleSettings = () => {
        const p = document.getElementById('settings-panel');
        p.style.right = p.style.right === "0px" ? "-100%" : "0px";
    };
    window.closeDetail = () => {
        document.getElementById('detail-panel').classList.remove('open');
        document.getElementById('overlay').style.display = 'none';
    };
</script>
</body>
</html>
