<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Chat App</title>
    <style>
        body { background-color: #7494c0; font-family: sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        #home-screen { padding: 20px; text-align: center; color: white; }
        .group-card { background: white; color: #333; padding: 15px; border-radius: 10px; margin: 10px auto; width: 80%; max-width: 300px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
        .login-box { background: white; padding: 25px; border-radius: 10px; text-align: center; width: 80%; max-width: 300px; }
        .login-box input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; }
        
        #chat-container { display: none; flex-direction: column; height: 100vh; }
        #chat-header { background: #557094; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        #chat-screen { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        
        /* ãƒ“ãƒ‡ã‚ªç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #video-area { display: none; background: #000; position: relative; height: 200px; }
        video { width: 50%; height: 100%; background: #222; }
        .close-video { position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; }

        .message-box { margin-bottom: 15px; display: flex; flex-direction: column; max-width: 80%; }
        .left { align-self: flex-start; }
        .right { align-self: flex-end; }
        .balloon { padding: 8px 15px; border-radius: 18px; background: white; line-height: 1.4; color: #333; }
        .right .balloon { background-color: #8de055; }
        .input-area { background: #fff; padding: 10px; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div id="home-screen">
    <h2>ãƒã‚¤ã‚°ãƒ«ãƒ¼ãƒ—</h2>
    <div id="group-list"></div>
    <button onclick="showLogin()" style="background:#28a745;">ï¼‹ æ–°è¦è¿½åŠ </button>
</div>

<div id="login-screen">
    <div class="login-box">
        <h3>ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š</h3>
        <input type="text" id="group-id" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å">
        <input type="text" id="group-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(é€šçŸ¥å›é¿ã®ãŸã‚text)">
        <input type="text" id="user-id" placeholder="ã‚ãªãŸã®åå‰">
        <button onclick="enterGroup(true)">ä¿å­˜ã—ã¦å…¥å®¤</button>
        <button onclick="hideLogin()">æˆ»ã‚‹</button>
    </div>
</div>

<div id="chat-container">
    <div id="chat-header">
        <button onclick="location.reload()">ğŸ </button>
        <span id="display-group-name"></span>
        <button onclick="startCall()" style="background:#28a745;">ğŸ“é€šè©±</button>
    </div>
    
    <div id="video-area">
        <video id="local-video" autoplay playsinline muted></video>
        <video id="remote-video" autoplay playsinline></video>
        <button class="close-video" onclick="endCall()">Ã—</button>
    </div>

    <div id="chat-screen"></div>
    <div class="input-area">
        <input type="text" id="input-message" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸...">
        <button id="send-btn">é€ä¿¡</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, serverTimestamp, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        projectId: "my-chat-1d626",
        storageBucket: "my-chat-1d626.firebasestorage.app",
        messagingSenderId: "769979957640",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let chatRef, callRef;
    let myName = "";
    let localStream;

    window.onload = displayGroups;

    function displayGroups() {
        const list = document.getElementById('group-list');
        list.innerHTML = "";
        const groups = JSON.parse(localStorage.getItem('myGroups') || "[]");
        groups.forEach((g, i) => {
            const div = document.createElement('div');
            div.className = 'group-card';
            div.innerHTML = `<span onclick="quickEnter('${g.id}', '${g.pass}')">${g.id}</span>
                             <span onclick="deleteGroup(${i})">Ã—</span>`;
            list.appendChild(div);
        });
    }

    window.showLogin = () => document.getElementById('login-screen').style.display = 'flex';
    window.hideLogin = () => document.getElementById('login-screen').style.display = 'none';

    window.enterGroup = function(save) {
        const id = document.getElementById('group-id').value;
        const pass = document.getElementById('group-pass').value;
        const user = document.getElementById('user-id').value;
        if(save) {
            let gs = JSON.parse(localStorage.getItem('myGroups') || "[]");
            gs.push({id, pass});
            localStorage.setItem('myGroups', JSON.stringify(gs));
        }
        startChat(id, pass, user);
    };

    window.quickEnter = (id, pass) => {
        const user = prompt("åå‰ã¯ï¼Ÿ");
        if(user) startChat(id, pass, user);
    };

    function startChat(group, pass, user) {
        myName = user;
        const path = `rooms/${group}_${pass}`;
        chatRef = ref(db, path + "/messages");
        callRef = ref(db, path + "/call");

        document.getElementById('display-group-name').innerText = group;
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('chat-container').style.display = 'flex';

        onChildAdded(chatRef, (data) => {
            const msg = data.val();
            const side = msg.name === myName ? "right" : "left";
            const div = document.createElement('div');
            div.className = `message-box ${side}`;
            div.innerHTML = `<div style="font-size:10px">${msg.name}</div><div class="balloon">${msg.text}</div>`;
            document.getElementById('chat-screen').appendChild(div);
            document.getElementById('chat-screen').scrollTop = document.getElementById('chat-screen').scrollHeight;
        });

        // é€šè©±ã®ç€ä¿¡ã‚’ç›£è¦–
        onValue(callRef, (snapshot) => {
            const data = snapshot.val();
            if (data && data.status === "calling" && data.caller !== myName) {
                if (confirm(data.caller + "ã•ã‚“ã‹ã‚‰é€šè©±ã§ã™ã€‚å‚åŠ ã—ã¾ã™ã‹ï¼Ÿ")) {
                    joinCall();
                }
            }
        });
    }

    window.startCall = async () => {
        document.getElementById('video-area').style.display = 'flex';
        localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        document.getElementById('local-video').srcObject = localStream;
        set(callRef, { status: "calling", caller: myName });
    };

    async function joinCall() {
        document.getElementById('video-area').style.display = 'flex';
        localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        document.getElementById('local-video').srcObject = localStream;
        // æœ¬æ¥ã¯ã“ã“ã«WebRTCã®æ¥ç¶šå‡¦ç†ãŒå¿…è¦ã§ã™ãŒã€ç°¡æ˜“ç‰ˆã¨ã—ã¦ç”»é¢è¡¨ç¤ºã®ã¿
    }

    window.endCall = () => {
        if(localStream) localStream.getTracks().forEach(track => track.stop());
        document.getElementById('video-area').style.display = 'none';
        set(callRef, { status: "ended" });
    };

    document.getElementById('send-btn').onclick = () => {
        const input = document.getElementById('input-message');
        if(input.value) push(chatRef, { name: myName, text: input.value });
        input.value = "";
    };
</script>
</body>
</html>
