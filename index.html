<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat-K Ver 4.5.9</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-blue: #7494C0; --header-dark: #35495e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* ç”»é¢å…¨ä½“ã®é«˜ã•åˆ¶å¾¡ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾ç­–ï¼‰ */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg-blue); }
        body { display: flex; flex-direction: column; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¿®æ­£ï¼šã‚¢ã‚¤ã‚³ãƒ³ã®ä½ç½®ã‚’å®‰å®šåŒ– */
        header { 
            background: var(--header-dark); 
            color: white; 
            padding: 0 10px; 
            display: grid; 
            grid-template-columns: 50px 1fr 50px; 
            align-items: center; 
            height: 55px; 
            flex-shrink: 0; 
            padding-top: env(safe-area-inset-top);
            z-index: 100;
        }
        header button { background: none; border: none; color: white; font-size: 22px; cursor: pointer; padding: 5px; }
        header .title { text-align: center; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        #chat-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px 10px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            -webkit-overflow-scrolling: touch;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ï¼šå¸¸ã«æœ€ä¸‹éƒ¨ã«å›ºå®š */
        .footer { 
            background: #fff; 
            padding: 10px 10px calc(10px + env(safe-area-inset-bottom)); 
            display: flex; 
            align-items: flex-end; 
            gap: 8px; 
            border-top: 1px solid #ddd;
            flex-shrink: 0;
        }
        #msg-input { 
            flex: 1; 
            border: none; 
            background: #f0f2f5; 
            padding: 10px 15px; 
            border-radius: 20px; 
            font-size: 16px; 
            outline: none; 
            max-height: 120px;
            resize: none;
            line-height: 1.4;
        }

        /* è¨­å®šãƒ‘ãƒãƒ« */
        #settings-panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100%; background: white; z-index: 2000; transition: 0.3s cubic-bezier(0, 0, 0.2, 1); padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.2); overflow-y: auto; }
        #settings-panel.open { right: 0; }
        
        .member-chip { display: inline-block; background: #f0f2f5; padding: 5px 12px; border-radius: 15px; font-size: 13px; margin: 3px; border: 1px solid #ddd; }
        .host-badge { background: #ffd700; font-size: 10px; padding: 2px 5px; border-radius: 4px; margin-left: 5px; font-weight: bold; color: #333; }
        
        .bubble { padding: 8px 12px; border-radius: 18px; font-size: 15px; background: white; white-space: pre-wrap; word-break: break-all; }
        .me { align-self: flex-end; } .me .bubble { background: var(--line-green); color: white; border-top-right-radius: 2px; }
        .other { align-self: flex-start; } .other .bubble { border-top-left-radius: 2px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 1000; padding: 20px; display: block; overflow-y: auto; }
        .btn-main { width: 100%; padding: 15px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; }
        
        /* ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ */
        #scanner-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 3000; display: none; flex-direction: column; }
        #video-preview { width: 100%; flex: 1; object-fit: cover; }
    </style>
</head>
<body>

<header>
    <button onclick="location.reload()">ğŸ </button>
    <div class="title" id="display-group-name">Chat-K</div>
    <button id="gear-btn" onclick="openSettings()" style="display:none;">âš™ï¸</button>
    <div id="header-spacer" style="width:40px;"></div>
</header>

<div id="chat-area"></div>

<div class="footer">
    <textarea id="msg-input" rows="1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›"></textarea>
    <button onclick="sendMessage()" style="background:var(--line-green); color:white; border:none; width:44px; height:44px; border-radius:50%; flex-shrink:0; font-size:18px;">â¤</button>
</div>

<div id="settings-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š</h3>
        <button onclick="closeSettings()" style="font-size:30px; border:none; background:none;">&times;</button>
    </div>
    <hr>
    <div id="host-only-info" style="display:none; background:#fff9c4; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #fbc02d;">
        <p style="margin:0; font-size:12px; color:#856404;"><b>ğŸ”‘ ãƒ›ã‚¹ãƒˆé™å®šæƒ…å ±</b></p>
        <p style="margin:8px 0 0; font-size:18px; font-family:monospace;">PW: <strong id="info-pw"></strong></p>
    </div>
    <div style="text-align:left; margin-bottom:20px;">
        <p style="font-weight:bold; margin-bottom:8px;">å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼:</p>
        <div id="member-list"></div>
    </div>
    <div id="qr-code" style="margin:10px auto; display:flex; justify-content:center; background:white; padding:10px; border-radius:10px; width:fit-content;"></div>
    <p style="text-align:center; font-size:12px; color:#666;">QRã‚³ãƒ¼ãƒ‰ã§å‹é”ã‚’æ‹›å¾…</p>
    <hr>
    <button onclick="leaveGroup()" style="width:100%; padding:12px; background:#ff4b4b; color:white; border:none; border-radius:8px; margin-top:10px;">ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹</button>
</div>

<div id="main-modal" class="modal">
    <h2 style="color:var(--line-green); margin-top:20px;">Chat-K</h2>
    <div id="step-register">
        <p style="color:#666;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="email" id="reg-email" placeholder="example@gmail.com" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-bottom:15px; font-size:16px;">
        <div id="name-input-area" style="display:none;">
            <input type="text" id="reg-name" placeholder="ãŠåå‰" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-bottom:15px; font-size:16px;">
        </div>
        <button class="btn-main" id="auth-btn" onclick="checkEmail()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="step-home" style="display:none;">
        <p id="welcome-msg" style="font-weight:bold;"></p>
        <button class="btn-main" onclick="startScanner()" style="background:#4285F4; margin-bottom:20px;">ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³ã§å‚åŠ </button>
        <div id="history-list"></div>
        <button onclick="toggleForm('join')" style="width:100%; background:#eee; border:none; padding:12px; border-radius:12px; margin-top:10px;">æ‰‹å‹•ã§ã‚°ãƒ«ãƒ¼ãƒ—ã«å‚åŠ </button>
        <button onclick="toggleForm('create')" style="width:100%; background:none; border:1px solid #ccc; padding:10px; border-radius:12px; margin-top:10px; color:#666;">æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹</button>
        
        <div id="group-form" style="display:none; margin-top:15px; background:#fff; padding:15px; border-radius:15px; border:1px solid #ddd;">
            <input type="text" id="group-id" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ccc; border-radius:8px;">
            <input type="password" id="group-pw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ccc; border-radius:8px;">
            <button class="btn-main" onclick="handleGroupAction()">å®Ÿè¡Œ</button>
        </div>
        <button onclick="logout()" style="color:red; border:none; background:none; margin-top:40px; font-size:14px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’å…¨æ¶ˆå»ï¼‰</button>
    </div>
</div>

<div id="scanner-container">
    <div style="color:white; padding:20px; font-size:18px; background:rgba(0,0,0,0.5);" onclick="stopScanner()">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
    <video id="video-preview"></video>
    <canvas id="scan-canvas" style="display:none;"></canvas>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get, set, serverTimestamp, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        databaseURL: "https://my-chat-1d626-default-rtdb.firebaseio.com",
        projectId: "my-chat-1d626",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = localStorage.getItem('chat_name'), myEmail = localStorage.getItem('chat_email'), currentGid = "";
    let members = {};

    // ã‚¹ãƒãƒ›ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºã«ã‚ˆã‚‹é«˜ã•å¤‰åŒ–ã‚’ç›£è¦–
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            document.body.style.height = window.visualViewport.height + 'px';
            window.scrollTo(0, 0);
        });
    }

    window.onload = () => { (myName && myEmail) ? showStep('home') : showStep('register'); };

    // --- è¨­å®šãƒ‘ãƒãƒ« & ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç† ---
    window.openSettings = async () => {
        const groupSnap = await get(ref(db, `v5_groups/${currentGid}`));
        if(!groupSnap.exists()) return;
        const groupData = groupSnap.val();

        if(groupData.host === myEmail) {
            document.getElementById('host-only-info').style.display = 'block';
            document.getElementById('info-pw').innerText = atob(groupData.pw);
        } else { document.getElementById('host-only-info').style.display = 'none'; }

        const listDiv = document.getElementById('member-list');
        listDiv.innerHTML = "";
        Object.keys(members).forEach(mEmail => {
            const span = document.createElement('span');
            span.className = 'member-chip';
            span.innerHTML = members[mEmail] + (mEmail === groupData.host ? '<span class="host-badge">HOST</span>' : '');
            listDiv.appendChild(span);
        });

        document.getElementById('qr-code').innerHTML = "";
        new QRCode(document.getElementById('qr-code'), {
            text: `${window.location.origin}${window.location.pathname}?join=${currentGid}`,
            width: 160, height: 160
        });
        document.getElementById('settings-panel').classList.add('open');
    };
    window.closeSettings = () => document.getElementById('settings-panel').classList.remove('open');

    // --- ãƒãƒ£ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯ ---
    window.enterChat = (gid) => {
        currentGid = gid; members = {};
        document.getElementById('main-modal').style.display = 'none';
        document.getElementById('gear-btn').style.display = 'block';
        document.getElementById('header-spacer').style.display = 'none';
        document.getElementById('display-group-name').innerText = gid;
        document.getElementById('chat-area').innerHTML = "";
        
        const chatRef = ref(db, `v5_groups/${gid}/messages`);
        off(chatRef);
        onChildAdded(chatRef, (snap) => {
            const d = snap.val();
            members[d.sender] = d.name;
            const wrap = document.createElement('div');
            wrap.className = `bubble-wrapper ${d.sender === myEmail ? 'me' : 'other'}`;
            wrap.innerHTML = `<div style="font-size:10px;margin:2px 5px;color:#eee;">${d.name}</div><div class="bubble">${d.text}</div>`;
            document.getElementById('chat-area').appendChild(wrap);
            document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
        });
    };

    window.sendMessage = () => {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim() || !currentGid) return;
        push(ref(db, `v5_groups/${currentGid}/messages`), { name: myName, sender: myEmail, text: inp.value });
        inp.value = "";
        inp.focus();
    };

    // --- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ ---
    window.startScanner = async () => {
        const video = document.getElementById('video-preview');
        document.getElementById('scanner-container').style.display = 'flex';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            video.setAttribute("playsinline", true);
            video.play();
            const tick = () => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    const canvas = document.getElementById('scan-canvas');
                    canvas.height = video.videoHeight; canvas.width = video.videoWidth;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
                    if (code) {
                        stopScanner();
                        const url = new URL(code.data);
                        const gid = url.searchParams.get('join');
                        if(gid) {
                            const pw = prompt(`ã‚°ãƒ«ãƒ¼ãƒ—ã€Œ${gid}ã€ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›`);
                            if(pw) { document.getElementById('group-id').value = gid; document.getElementById('group-pw').value = pw; window.currentMode = 'join'; handleGroupAction(); }
                        }
                        return;
                    }
                }
                if(document.getElementById('scanner-container').style.display === 'flex') requestAnimationFrame(tick);
            };
            requestAnimationFrame(tick);
        } catch(e) { alert("ã‚«ãƒ¡ãƒ©è¨±å¯ãŒå¿…è¦ã§ã™"); stopScanner(); }
    };
    window.stopScanner = () => {
        if(document.getElementById('video-preview').srcObject) document.getElementById('video-preview').srcObject.getTracks().forEach(t => t.stop());
        document.getElementById('scanner-container').style.display = 'none';
    };

    // --- ãã®ä»–èªè¨¼ãªã© ---
    window.checkEmail = async () => {
        const email = document.getElementById('reg-email').value.trim();
        if(!email.includes('@')) return alert("ãƒ¡ã‚¢ãƒ‰æ­£ã—ããªã„ã‚ˆ");
        const snap = await get(ref(db, `users/${email.replace(/\./g, '_')}`));
        if(snap.exists()){
            myName = snap.val().name; myEmail = email;
            localStorage.setItem('chat_name', myName); localStorage.setItem('chat_email', myEmail);
            if(snap.val().history) localStorage.setItem('chat_history', JSON.stringify(snap.val().history));
            showStep('home');
        } else {
            document.getElementById('name-input-area').style.display = 'block';
            document.getElementById('auth-btn').onclick = () => finalizeNewAccount(email);
        }
    };
    async function finalizeNewAccount(email) {
        const name = document.getElementById('reg-name').value.trim();
        if(!name) return;
        await set(ref(db, `users/${email.replace(/\./g, '_')}`), { name: name, history: [] });
        myName = name; myEmail = email;
        localStorage.setItem('chat_name', name); localStorage.setItem('chat_email', email);
        showStep('home');
    }
    window.handleGroupAction = async () => {
        const gid = document.getElementById('group-id').value.trim(), pw = btoa(document.getElementById('group-pw').value);
        const snap = await get(ref(db, `v5_groups/${gid}`));
        if(window.currentMode === 'create') {
            if(snap.exists()) return alert("æ—¢ã«ã‚ã‚Šã¾ã™");
            await set(ref(db, `v5_groups/${gid}`), { host: myEmail, pw: pw });
        } else { if(!snap.exists() || snap.val().pw !== pw) return alert("èªè¨¼ã‚¨ãƒ©ãƒ¼"); }
        saveGroupLocal(gid, pw); enterChat(gid);
    };
    function saveGroupLocal(gid, pw) {
        let h = JSON.parse(localStorage.getItem('chat_history') || "[]"); if(!h.includes(gid)) h.push(gid);
        localStorage.setItem('chat_history', JSON.stringify(h));
        let a = JSON.parse(localStorage.getItem('chat_access') || "{}"); a[gid] = pw;
        localStorage.setItem('chat_access', JSON.stringify(a));
        set(ref(db, `users/${myEmail.replace(/\./g, '_')}/history`), h);
    }
    window.toggleForm = (m) => { window.currentMode = m; document.getElementById('group-form').style.display = 'block'; };
    function showStep(s) {
        document.getElementById('step-register').style.display = 'none';
        document.getElementById('step-home').style.display = 'none';
        document.getElementById('step-'+s).style.display = 'block';
        if(s === 'home') refreshHistory();
    }
    function refreshHistory() {
        const list = document.getElementById('history-list'); list.innerHTML = "";
        JSON.parse(localStorage.getItem('chat_history') || "[]").forEach(gid => {
            const div = document.createElement('div');
            div.style = "background:white; padding:15px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #ddd;";
            div.innerHTML = `<span><b>${gid}</b></span><button onclick="enterChat('${gid}')" style="background:var(--line-green);color:white;border:none;padding:10px 20px;border-radius:10px;font-weight:bold;">å…¥å®¤</button>`;
            list.appendChild(div);
        });
        document.getElementById('welcome-msg').innerText = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­: " + myName;
    }
    window.logout = () => { if(confirm("æ¶ˆå»ï¼Ÿ")) { localStorage.clear(); location.reload(); } };
</script>
</body>
</html>
