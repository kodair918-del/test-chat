<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Home</title>
    <style>
        body { background-color: #7494c0; font-family: sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        #home-screen { padding: 20px; text-align: center; color: white; }
        .group-card { background: white; color: #333; padding: 15px; border-radius: 10px; margin: 10px auto; width: 80%; max-width: 300px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .delete-btn { color: red; font-weight: bold; padding: 5px 10px; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
        .login-box { background: white; padding: 25px; border-radius: 10px; text-align: center; width: 80%; max-width: 300px; }
        .login-box input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; }
        
        #chat-container { display: none; flex-direction: column; height: 100vh; }
        #chat-header { background: #557094; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        #chat-screen { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .message-box { margin-bottom: 15px; display: flex; flex-direction: column; max-width: 80%; }
        .left { align-self: flex-start; }
        .right { align-self: flex-end; }
        .balloon { padding: 8px 15px; border-radius: 18px; background: white; line-height: 1.4; word-wrap: break-word; color: #333; }
        .right .balloon { background-color: #8de055; }
        .input-area { background: #fff; padding: 10px; display: flex; gap: 10px; }
        #input-message { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div id="home-screen">
    <h2>„Éû„Ç§„Ç∞„É´„Éº„Éó</h2>
    <div id="group-list"></div>
    <button onclick="showLogin()" style="margin-top:20px; background:#28a745;">Ôºã Êñ∞„Åó„ÅÑ„Ç∞„É´„Éº„Éó„ÇíËøΩÂä†</button>
</div>

<div id="login-screen">
    <div class="login-box">
        <h3>„Ç∞„É´„Éº„ÉóË®≠ÂÆö</h3>
        <input type="text" id="group-id" placeholder="„Ç∞„É´„Éº„ÉóÂêç">
        <input type="text" id="group-pass" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
        <input type="text" id="user-id" placeholder="„ÅÇ„Å™„Åü„ÅÆÂêçÂâç">
        <button onclick="enterGroup(true)">‰øùÂ≠ò„Åó„Å¶ÂÖ•ÂÆ§</button>
        <button onclick="hideLogin()" style="background:#666;">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
</div>

<div id="chat-container">
    <div id="chat-header">
        <button onclick="goHome()" style="background:none; font-size:20px;">üè†</button>
        <span id="display-group-name"></span>
        <div style="width:40px;"></div>
    </div>
    <div id="chat-screen"></div>
    <div class="input-area">
        <input type="text" id="input-message" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏...">
        <button id="send-btn">ÈÄÅ‰ø°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, serverTimestamp, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC0LabfY8QcZgSFySBrF5Jj6xnKMbPXbZo",
        authDomain: "my-chat-1d626.firebaseapp.com",
        projectId: "my-chat-1d626",
        storageBucket: "my-chat-1d626.firebasestorage.app",
        messagingSenderId: "769979957640",
        appId: "1:769979957640:web:777fb6120b5b223e127a3d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let chatRef;
    let myName = "";

    // Ëµ∑ÂãïÊôÇ„Å´‰øùÂ≠ò„Åï„Çå„Åü„Ç∞„É´„Éº„Éó„ÇíË°®Á§∫
    window.onload = displayGroups;

    function displayGroups() {
        const list = document.getElementById('group-list');
        list.innerHTML = "";
        const groups = JSON.parse(localStorage.getItem('myGroups') || "[]");
        groups.forEach((g, index) => {
            const div = document.createElement('div');
            div.className = 'group-card';
            div.innerHTML = `<span onclick="quickEnter('${g.id}', '${g.pass}')">${g.id}</span>
                             <span class="delete-btn" onclick="deleteGroup(${index})">√ó</span>`;
            list.appendChild(div);
        });
    }

    window.showLogin = () => document.getElementById('login-screen').style.display = 'flex';
    window.hideLogin = () => document.getElementById('login-screen').style.display = 'none';
    window.goHome = () => location.reload();

    window.enterGroup = function(save) {
        const group = document.getElementById('group-id').value;
        const pass = document.getElementById('group-pass').value;
        const user = document.getElementById('user-id').value;
        if(!group || !pass || !user) return alert("ÂÖ®ÈÉ®ÂÖ•Âäõ„Åó„Å¶„Å≠");

        if(save) {
            const groups = JSON.parse(localStorage.getItem('myGroups') || "[]");
            if(!groups.find(g => g.id === group)) {
                groups.push({id: group, pass: pass});
                localStorage.setItem('myGroups', JSON.stringify(groups));
            }
        }
        startChat(group, pass, user);
    };

    window.quickEnter = (id, pass) => {
        const user = prompt("ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        if(user) startChat(id, pass, user);
    };

    window.deleteGroup = (index) => {
        const groups = JSON.parse(localStorage.getItem('myGroups') || "[]");
        groups.splice(index, 1);
        localStorage.setItem('myGroups', JSON.stringify(groups));
        displayGroups();
    };

    function startChat(group, pass, user) {
        myName = user;
        chatRef = ref(db, "rooms/" + group + "_" + pass);
        document.getElementById('display-group-name').innerText = group;
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('chat-container').style.display = 'flex';

        onChildAdded(chatRef, (data) => {
            const msg = data.val();
            const side = msg.name === myName ? "right" : "left";
            const msgDiv = document.createElement('div');
            msgDiv.className = `message-box ${side}`;
            msgDiv.innerHTML = `<div style="color:white;font-size:10px">${msg.name}</div><div class="balloon">${msg.text}</div>`;
            document.getElementById('chat-screen').appendChild(msgDiv);
            document.getElementById('chat-screen').scrollTop = document.getElementById('chat-screen').scrollHeight;
        });
    }

    document.getElementById('send-btn').onclick = () => {
        const input = document.getElementById('input-message');
        if(input.value.trim() && chatRef) {
            push(chatRef, { name: myName, text: input.value, time: serverTimestamp() });
            input.value = "";
        }
    };
</script>
</body>
</html>

